<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Explosion Contour Simulator</title>

  <meta name="description" content="Interactive tool to visualize explosion contours with customizable settings.">
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="//unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    :root{--ink:#0f172a;--muted:#64748b;--card:#fff;--bg:#f6f8fb;--brand:#1296d4;--brand-hover:#1082b9;}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial; overflow: hidden;}
    
    .wrap{
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 16px;
      max-width: 1800px;
      height: 100vh;
      margin: auto;
      padding: 16px;
    }
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(2,8,20,.08);padding:14px}
    
    #settings-panel {
      padding: 24px;
      overflow-y: auto;
    }
    #map-card {
      padding: 0;
      height: calc(100vh - 32px);
      display: flex;
      flex-direction: column;
    }
    #map{flex-grow:1; border-radius:14px;overflow:hidden}

    #settings-title {
        display: none; /* Hidden on desktop */
        font-size: 20px;
        margin: 0 0 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
        line-height: 1.3;
    }
    #settings-title small {
        display: block;
        font-size: 14px;
        color: var(--muted);
        font-weight: normal;
        margin-top: 4px;
    }

    #map-title {
        position: absolute;
        top: 12px;
        left: 58px; /* Space for zoom controls */
        z-index: 1002;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 14px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(2,8,20,.12);
        max-width: 450px;
        font-size: 16px;
        font-weight: 700;
        margin: 0;
        line-height: 1.3;
    }
    #map-title small {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-top: 3px;
        color: var(--muted);
    }
    
    .form-group{margin-bottom: 16px;}
    label{font-weight:600;display:block;margin-bottom:6px;font-size:14px;}
    .form-group small{font-size:12px;color:var(--muted);display:block;margin-top:4px;}
    input[type="number"], textarea, select{
      width:100%;
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:8px;
      background:#f9fafb;
      font-size:14px;
    }
    textarea{min-height:120px;font-family:monospace;resize:vertical;}
    
    #locationName {
        font-weight: 500;
        font-size: 14px;
        padding-top: 4px;
    }

    .render-btn{
      width:100%;
      padding:12px;
      background:var(--brand);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      transition: background-color .2s;
    }
    .render-btn:hover{background: var(--brand-hover);}

    .actions-group {
        margin-top: 24px;
    }
    .io-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
    }
    .io-btn {
        padding: 10px;
        border: 1px solid #d1d5db;
        background: #fff;
        color: var(--ink);
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: background-color .2s, border-color .2s;
    }
    .io-btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }

    .legend{position:absolute;z-index:1001;bottom:12px;left:12px;background:rgba(255,255,255,0.9);border-radius:10px;
      box-shadow:0 6px 18px rgba(2,8,20,.15);padding:10px 12px;font:14px/1.2 system-ui,Segoe UI,Roboto,Arial}
    .legend .muted {font-size: 12px; color: var(--muted);}

    /* Fullscreen overlay */
    #map-card{position:relative}
    .fs-btn{
      position:absolute; z-index:1002; top:12px; right:12px;
      background:rgba(255,255,255,.95); border:1px solid #e5e7eb; border-radius:10px;
      padding:8px 10px; font-weight:700; cursor:pointer; box-shadow:0 4px 12px rgba(2,8,20,.12)
    }
    .fs-btn:active{transform:translateY(1px)}
    .fs-host.fullscreen{position:fixed; inset:0; z-index:9999; margin:0; border-radius:0; padding:0; background:#000;}
    .fs-host.fullscreen #map{height:100dvh; height:100vh; border-radius:0}
    body.fs-lock{overflow:hidden}

    @media (max-width:960px){
      body{overflow:auto;}
      .wrap{grid-template-columns:1fr; height:auto;}
      #map-card{height:65vh;}
      #map-title { display: none; }
      #settings-title { display: block; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="settings-panel" class="card">
      <h1 id="settings-title">
        Modeling and Visualization of Explosion Overpressure Contours
        <small id="settings-subtitle">Loading location...</small>
      </h1>
      
      <div class="form-group">
        <label for="lat">Latitude</label>
        <input type="number" id="lat" step="any">
      </div>
      <div class="form-group">
        <label for="lon">Longitude</label>
        <input type="number" id="lon" step="any">
      </div>
      
      <div class="form-group">
        <label for="csv">Radius (m), Pressure (kPa) Data</label>
        <textarea id="csv" spellcheck="false"></textarea>
        <small>One line per ring. Format: `radius, pressure`</small>
      </div>

      <div class="form-group">
        <label for="np">Points Per Ring</label>
        <input type="number" id="np" min="3" max="360">
        <small>Higher values create smoother circles.</small>
      </div>
      
      <div class="form-group">
        <label for="iv">Animation Interval (ms)</label>
        <input type="number" id="iv" min="0">
        <small>Delay between each ring's appearance.</small>
      </div>
      
      <div class="form-group">
        <label for="os">Initial Opacity</label>
        <input type="number" id="os" min="0" max="1" step="0.05">
      </div>
      
      <div class="form-group">
        <label for="of">Final Opacity</label>
        <input type="number" id="of" min="0" max="1" step="0.05">
      </div>

      <div class="form-group">
        <label for="sw">Stroke Width</label>
        <input type="number" id="sw" min="0" max="10" step="0.1">
      </div>

      <div class="form-group">
        <label for="pal">Color Palette</label>
        <select id="pal">
          <option value="bright">Bright</option>
          <option value="heat">Heat</option>
          <option value="bluegreen">Blue-Green</option>
        </select>
      </div>
      
      <div class="actions-group">
        <button id="renderBtn" class="render-btn">Render</button>
        <div class="io-buttons">
          <button id="importBtn" class="io-btn">Import CSV</button>
          <button id="exportBtn" class="io-btn">Export CSV</button>
        </div>
        <input type="file" id="importFile" hidden accept=".csv,.txt">
      </div>
    </div>

    <div class="card fs-host" id="map-card">
      <h1 id="map-title">
        Modeling and Visualization of Explosion Overpressure Contours
        <small id="map-subtitle">Loading location...</small>
      </h1>
      <button id="fsBtn" class="fs-btn" aria-pressed="false" title="Fullscreen (F)">⛶ Fullscreen</button>
      <div id="map" role="region" aria-label="Explosion contour map"></div>
      <div class="legend" id="legend" hidden></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // ======= INITIAL SETTINGS =======
  const initialSettings = {
    lat: 33.901436,
    lon: 35.519057,
    csv: `49, 2042.348\n150, 159.4947\n300, 41.51972\n500, 19.59217\n1000, 8.648397\n3000, 2.768441`,
    np: 90,
    iv: 250,
    os: 0.3,
    of: 0.2,
    sw: 0.3,
    pal: 'bright'
  };
  
  const ui = {
      lat: document.getElementById('lat'),
      lon: document.getElementById('lon'),
      csv: document.getElementById('csv'),
      np: document.getElementById('np'),
      iv: document.getElementById('iv'),
      os: document.getElementById('os'),
      of: document.getElementById('of'),
      sw: document.getElementById('sw'),
      pal: document.getElementById('pal'),
      renderBtn: document.getElementById('renderBtn'),
      importBtn: document.getElementById('importBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile'),
      fsBtn: document.getElementById('fsBtn'),
      mapCard: document.getElementById('map-card'),
      legend: document.getElementById('legend'),
      mapSubtitle: document.getElementById('map-subtitle'),
      settingsSubtitle: document.getElementById('settings-subtitle')
  };

  // ======= Map Initialization =======
  const map = L.map('map', {center:[initialSettings.lat, initialSettings.lon], zoom: 14, zoomControl:true});
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19, attribution:'Tiles © Esri'
  }).addTo(map);

  // ======= Helpers =======
  const palettes = {
    bright: ["#FF0000","#FFA500","#FFFF00","#00FF00","#00FFFF","#0000FF","#FF00FF","#800080","#FFC0CB","#A52A2A"],
    bluegreen: ["#203a8f","#2d6cdf","#3fb6ff","#27c3a4","#15a371","#0f7a54","#0b533b","#083b2c"],
    heat: ["#4b0d0d","#7a1f0e","#ad3510","#e65a0d","#ff8c00","#ffb200","#ffd000","#ffe680"]
  };

  function parseData(text){
    const out = [];
    const rows = (text||'').trim().split(/[\r\n]+/).filter(Boolean);
    for(const r of rows){
      const parts = r.trim().split(/[,\t; ]+/).filter(Boolean);
      const rVal = Number((parts[0]||'').replace(',', '.'));
      const poVal = parts.length > 1 ? Number((parts[1]||'').replace(',', '.')) : null;
      if(isFinite(rVal) && rVal > 0){
        out.push({r:rVal, Po: isFinite(poVal) ? poVal : null});
      }
    }
    out.sort((a,b)=>a.r-b.r);
    return out;
  }

  function circleCoords(lat0, lon0, R, n=90){
    const latRad0 = lat0 * Math.PI / 180;
    const coords = [];
    for(let i=0; i<=n; i++){
      const th = 2 * Math.PI * i / n;
      const lat = lat0 + (R * Math.sin(th)) / 110574.0;
      const lon = lon0 + (R * Math.cos(th)) / (111320.0 * Math.cos(latRad0));
      coords.push([lat, lon]);
    }
    return coords;
  }
  
  // ======= UI and Render Logic =======
  function populateUI(settings) {
    for (const key in settings) {
        if (ui[key] && typeof settings[key] !== 'undefined') {
            ui[key].value = settings[key];
        }
    }
  }
  
  function getSettingsFromUI() {
    return {
      lat: parseFloat(ui.lat.value) || 0,
      lon: parseFloat(ui.lon.value) || 0,
      csv: ui.csv.value,
      np: parseInt(ui.np.value, 10) || 90,
      iv: parseInt(ui.iv.value, 10) || 250,
      os: parseFloat(ui.os.value) || 0.3,
      of: parseFloat(ui.of.value) || 0.2,
      sw: parseFloat(ui.sw.value) || 0.3,
      pal: ui.pal.value || 'bright'
    };
  }

  async function fetchLocationName(lat, lon) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=en`);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        const address = data.address;
        const name = data.display_name || 'Unknown location';
        const locationString = [address.city, address.state, address.country].filter(Boolean).join(', ');
        
        return locationString || name;
    } catch (error) {
        console.error("Failed to fetch location name:", error);
        return 'Failed to load location';
    }
  }

  let finalLayer = null;
  let animHandles = [];
  function clearMap(){
    animHandles.forEach(h => clearTimeout(h));
    animHandles = [];
    if(finalLayer){ map.removeLayer(finalLayer); finalLayer=null; }
    const toRemove = [];
    map.eachLayer(l => { if(l instanceof L.Polygon || l instanceof L.GeoJSON){ toRemove.push(l);} });
    toRemove.forEach(l => map.removeLayer(l));
    ui.legend.hidden = true;
  }

  async function renderMap(){
    clearMap();
    const s = getSettingsFromUI();
    const locationName = await fetchLocationName(s.lat, s.lon);
    ui.mapSubtitle.textContent = locationName;
    ui.settingsSubtitle.textContent = locationName;
    
    const rings = parseData(s.csv);
    if (rings.length === 0) return;
    
    const pal = (palettes[s.pal] || palettes.bright);
    const tempLayers = [];

    rings.forEach((d, idx) => {
      const t = setTimeout(() => {
        const coords = circleCoords(s.lat, s.lon, d.r, s.np);
        const layer = L.polygon(coords, {
          color: "#000000",
          weight: s.sw,
          fillColor: pal[idx % pal.length],
          fillOpacity: s.os
        }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po} kPa</code>`:''}`).addTo(map);
        tempLayers.push(layer);
        if(idx === 0){ try{ map.setView([s.lat, s.lon], map.getZoom()); }catch(e){} }
      }, idx * s.iv);
      animHandles.push(t);
    });

    const tFinal = setTimeout(() => {
      tempLayers.forEach(l => map.removeLayer(l));
      const reversed = rings.slice().reverse();
      finalLayer = L.featureGroup(
        reversed.map((d, idx) => {
          const coords = circleCoords(s.lat, s.lon, d.r, s.np);
          return L.polygon(coords, {
            color: "#000000",
            weight: s.sw,
            fillColor: pal[(rings.length - 1 - idx) % pal.length],
            fillOpacity: s.of
          }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po} kPa</code>`:''}`);
        })
      ).addTo(map);
      
      try{ map.fitBounds(finalLayer.getBounds(), {padding:[20,20]}); }catch(e){}
      
      const leg = ui.legend;
      leg.innerHTML = `<b>Explosion Contour</b>
        <div>Center: ${s.lat.toFixed(6)}, ${s.lon.toFixed(6)}</div>
        <div>Rings: ${rings.map(x=>x.r).join(', ')} m</div>`;
      leg.hidden = false;
    }, rings.length * s.iv + 300);
    animHandles.push(tFinal);
  }
  
  ui.renderBtn.addEventListener('click', renderMap);

  // ======= Import/Export Functions =======
  function exportCSV() {
    const csvData = ui.csv.value;
    const blob = new Blob([csvData], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'explosion-data.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  ui.importBtn.addEventListener('click', () => {
    ui.importFile.click();
  });

  ui.importFile.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        ui.csv.value = e.target.result;
        ui.importFile.value = ''; // Reset file input
    };
    reader.onerror = () => {
      alert('Failed to read file.');
      ui.importFile.value = '';
    }
    reader.readAsText(file);
  });
  
  ui.exportBtn.addEventListener('click', exportCSV);

  // ======= Fullscreen Controls =======
  function enterFS(){
    ui.mapCard.classList.add('fullscreen');
    document.body.classList.add('fs-lock');
    ui.fsBtn.setAttribute('aria-pressed','true');
    ui.fsBtn.textContent = '⛶ Exit Fullscreen';
    if (ui.mapCard.requestFullscreen) { ui.mapCard.requestFullscreen().catch(()=>{}); }
    setTimeout(() => map.invalidateSize(), 200);
  }
  function exitFS(){
    ui.mapCard.classList.remove('fullscreen');
    document.body.classList.remove('fs-lock');
    ui.fsBtn.setAttribute('aria-pressed','false');
    ui.fsBtn.textContent = '⛶ Fullscreen';
    if (document.fullscreenElement && document.exitFullscreen) {
      document.exitFullscreen().catch(()=>{});
    }
    setTimeout(() => map.invalidateSize(), 200);
  }
  function toggleFS(){ ui.mapCard.classList.contains('fullscreen') ? exitFS() : enterFS(); }
  ui.fsBtn.addEventListener('click', toggleFS);
  document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'f' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); toggleFS(); }
    if (e.key === 'Escape' && ui.mapCard.classList.contains('fullscreen')) { exitFS(); }
  });
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement && ui.mapCard.classList.contains('fullscreen')) { exitFS(); }
  });
  window.addEventListener('resize', () => {
      clearTimeout(window.__fsRaf);
      window.__fsRaf = setTimeout(() => map.invalidateSize(), 120);
  });

  // Initialize the application
  populateUI(initialSettings);
  setTimeout(renderMap, 80);
  </script>
</body>
</html>




