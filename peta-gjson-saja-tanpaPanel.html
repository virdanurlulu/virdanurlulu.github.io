<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Explosion Contour - Share Result</title>

  <meta name="description" content="Render kontur ledakan dari setting default dengan animasi dan fullscreen.">
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="//unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    :root{--ink:#0f172a;--muted:#64748b;--card:#fff;--bg:#f6f8fb;--brand:#1296d4}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:auto;padding:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(2,8,20,.08);padding:14px}
    h1{font-size:20px;margin:4px 0 12px}
    #map{height:72vh;border-radius:14px;overflow:hidden}
    .legend{position:absolute;z-index:1001;bottom:12px;left:12px;background:#fff;border-radius:10px;
      box-shadow:0 6px 18px rgba(2,8,20,.15);padding:10px 12px;font:14px/1.2 system-ui,Segoe UI,Roboto,Arial}
    .muted{color:var(--muted)}
    @media (max-width:960px){#map{height:64vh}}

    /* Fullscreen overlay */
    #mapCard{position:relative}
    .fs-btn{
      position:absolute; z-index:1002; top:12px; right:12px;
      background:rgba(255,255,255,.95); border:1px solid #e5e7eb; border-radius:10px;
      padding:8px 10px; font-weight:700; cursor:pointer; box-shadow:0 4px 12px rgba(2,8,20,.12)
    }
    .fs-btn:active{transform:translateY(1px)}
    .fs-host.fullscreen{position:fixed; inset:0; z-index:9999; margin:0; border-radius:0; padding:0; background:#000;}
    .fs-host.fullscreen #map{height:100dvh; height:100vh; border-radius:0}
    body.fs-lock{overflow:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Explosion Contour - Share Result</h1>

    <!-- Peta saja (panel dihapus) -->
    <div class="card fs-host" id="mapCard">
      <button id="fsBtn" class="fs-btn" aria-pressed="false" title="Fullscreen (F)">⛶ Fullscreen</button>
      <div id="map" role="region" aria-label="Peta kontur ledakan"></div>
      <div class="legend" id="legend" hidden></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // ======= DEFAULTS (sesuai instruksi) =======
  const DEFAULTS = {
    lat: 33.901436,
    lon: 35.519057,
    csv:
`49, 2042.348
150, 159.4947
300, 41.51972
500, 19.59217
1000, 8.648397
3000, 2.768441`,
    np: 90,
    iv: 250,
    os: 0.3,
    of: 0.2,
    sw: 0.3,
    pal: 'bright' // Cerah (default)
  };

  // Judul
  document.title = "Explosion Contour - Share Result";

  // ======= Map init =======
  const map = L.map('map', {center:[DEFAULTS.lat, DEFAULTS.lon], zoom: 14, zoomControl:true});
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19, attribution:'Tiles © Esri'
  }).addTo(map);

  // ======= Helpers =======
  const palettes = {
    bright: ["#FF0000","#FFA500","#FFFF00","#00FF00","#00FFFF","#0000FF","#FF00FF","#800080","#FFC0CB","#A52A2A"],
    bluegreen: ["#203a8f","#2d6cdf","#3fb6ff","#27c3a4","#15a371","#0f7a54","#0b533b","#083b2c"],
    heat: ["#4b0d0d","#7a1f0e","#ad3510","#e65a0d","#ff8c00","#ffb200","#ffd000","#ffe680"]
  };

  function parseData(text){
    const out = [];
    const rows = (text||'').trim().split(/[\r\n]+/).filter(Boolean);
    for(const r of rows){
      const parts = r.trim().split(/[,\t; ]+/).filter(Boolean);
      const rVal = Number((parts[0]||'').replace(',', '.'));
      const poVal = parts.length>1 ? Number((parts[1]||'').replace(',', '.')) : null;
      if(isFinite(rVal) && rVal>0){
        out.push({r:rVal, Po: isFinite(poVal)?poVal:null});
      }
    }
    out.sort((a,b)=>a.r-b.r);
    return out;
  }

  function circleCoords(lat0, lon0, R, n=90){
    const latRad0 = lat0*Math.PI/180;
    const coords = [];
    for(let i=0;i<=n;i++){
      const th = 2*Math.PI*i/n;
      const lat = lat0 + (R*Math.sin(th))/110574.0;
      const lon = lon0 + (R*Math.cos(th))/(111320.0*Math.cos(latRad0));
      coords.push([lat, lon]); // Leaflet LatLng order
    }
    return coords;
  }

  // ======= Render dengan DEFAULTS =======
  let finalLayer = null;
  let animHandles = [];
  function clearMap(){
    animHandles.forEach(h => clearTimeout(h));
    animHandles = [];
    if(finalLayer){ map.removeLayer(finalLayer); finalLayer=null; }
    const toRemove = [];
    map.eachLayer(l=>{ if(l instanceof L.Polygon || l instanceof L.GeoJSON){ toRemove.push(l);} });
    toRemove.forEach(l=>map.removeLayer(l));
    document.getElementById('legend').hidden = true;
  }

  function renderDefault(){
    clearMap();
    const s = DEFAULTS;
    const rings = parseData(s.csv);
    const pal = (palettes[s.pal] || palettes.bright);

    const tempLayers = [];
    rings.forEach((d, idx)=>{
      const t = setTimeout(()=>{
        const coords = circleCoords(s.lat, s.lon, d.r, s.np);
        const layer = L.polygon(coords, {
          color: "#000000",
          weight: s.sw,
          fillColor: pal[idx % pal.length],
          fillOpacity: s.os
        }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po}</code>`:''}`).addTo(map);
        tempLayers.push(layer);
        if(idx===0){ try{ map.setView([s.lat,s.lon], 14); }catch(e){} }
      }, idx*s.iv);
      animHandles.push(t);
    });

    const tFinal = setTimeout(()=>{
      tempLayers.forEach(l=>map.removeLayer(l));
      const reversed = rings.slice().reverse();
      finalLayer = L.featureGroup(
        reversed.map((d, idx)=>{
          const coords = circleCoords(s.lat, s.lon, d.r, s.np);
          return L.polygon(coords, {
            color: "#000000",
            weight: s.sw,
            fillColor: pal[(rings.length-1-idx) % pal.length],
            fillOpacity: s.of
          }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po}</code>`:''}`);
        })
      ).addTo(map);
      try{ map.fitBounds(finalLayer.getBounds(), {padding:[20,20]}); }catch(e){}
      const leg = document.getElementById('legend');
      leg.innerHTML = `<b>Kontur Ledakan</b>
        <div>Pusat: ${s.lat.toFixed(6)}, ${s.lon.toFixed(6)}</div>
        <div>Rings: ${rings.map(x=>x.r).join(', ')} m</div>
        <hr style="border:none;border-top:1px solid #e5e7eb;margin:8px 0">
        <div class="muted">nPoints=${s.np}, interval=${s.iv} ms</div>
        <div class="muted">opacity awal=${s.os}, akhir=${s.of}, strokeW=${s.sw}, palette=${s.pal}</div>`;
      leg.hidden = false;
    }, rings.length*s.iv + 300);
    animHandles.push(tFinal);
  }

  // ======= Fullscreen controls =======
  const fsBtn = document.getElementById('fsBtn');
  const mapCard = document.getElementById('mapCard');
  function enterFS(){
    mapCard.classList.add('fullscreen');
    document.body.classList.add('fs-lock');
    fsBtn.setAttribute('aria-pressed','true');
    fsBtn.textContent = '⛶ Exit Fullscreen';
    if (mapCard.requestFullscreen) { mapCard.requestFullscreen().catch(()=>{}); }
    setTimeout(()=>map.invalidateSize(), 200);
  }
  function exitFS(){
    mapCard.classList.remove('fullscreen');
    document.body.classList.remove('fs-lock');
    fsBtn.setAttribute('aria-pressed','false');
    fsBtn.textContent = '⛶ Fullscreen';
    if (document.fullscreenElement && document.exitFullscreen) {
      document.exitFullscreen().catch(()=>{});
    }
    setTimeout(()=>map.invalidateSize(), 200);
  }
  function toggleFS(){ mapCard.classList.contains('fullscreen') ? exitFS() : enterFS(); }
  fsBtn.addEventListener('click', toggleFS);
  document.addEventListener('keydown', (e)=>{
    if (e.key.toLowerCase() === 'f') { e.preventDefault(); toggleFS(); }
    if (e.key === 'Escape' && mapCard.classList.contains('fullscreen')) { exitFS(); }
  });
  document.addEventListener('fullscreenchange', ()=>{
    if (!document.fullscreenElement && mapCard.classList.contains('fullscreen')) { exitFS(); }
  });
  window.addEventListener('resize', ()=>{
    if (mapCard.classList.contains('fullscreen')) {
      clearTimeout(window.__fsRaf);
      window.__fsRaf = setTimeout(()=>map.invalidateSize(), 120);
    }
  });

  // Auto-render default saat halaman dibuka
  setTimeout(renderDefault, 80);
  </script>
</body>
</html>
