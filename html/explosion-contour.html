<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Explosion Contour</title>

  <!-- MODIFIED: Broadened the Content-Security-Policy to allow all connections -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src * data:; connect-src *;">

  <meta name="description" content="Explosion contour: CSV import/export, mini toolbar, localStorage, geodesic, fullscreen, read-only QS, Latin location label.">
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="//unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    :root{--ink:#0f172a;--muted:#64748b;--card:#fff;--bg:#f6f8fb}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:auto;padding:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(2,8,20,.08);padding:14px}
    h1{font-size:20px;margin:4px 0 12px}
    #map{height:72vh;border-radius:14px;overflow:hidden}
    .legend{
      display: none; /* This panel is now hidden */
      position:absolute;z-index:1001;bottom:12px;left:12px;background:#fff;border-radius:10px;
      box-shadow:0 6px 18px rgba(2,8,20,.15);padding:10px 12px;font:13px/1.3 system-ui,Segoe UI,Roboto,Arial}
    .muted{color:var(--muted)}
    @media (max-width:960px){#map{height:64vh}}

    /* Fullscreen overlay */
    #mapCard{position:relative}
    .fs-btn{
      position:absolute; z-index:1002; top:12px; right:12px;
      background:rgba(255,255,255,.95); border:1px solid #e5e7eb; border-radius:10px;
      padding:8px 10px; font-weight:700; cursor:pointer; box-shadow:0 4px 12px rgba(2,8,20,.12)
    }
    .fs-btn:active{transform:translateY(1px)}
    .fs-host.fullscreen{position:fixed; inset:0; z-index:9999; margin:0; border-radius:0; padding:0; background:#000;}
    .fs-host.fullscreen #map{height:100dvh; height:100vh; border-radius:0}
    body.fs-lock{overflow:hidden}

    /* Toolbar mini */
    .toolbar{
      display: none; /* Hide the entire toolbar */
    }
    .tb-btn{border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700}
    .tb-btn:hover{background:#f8fafc}
    .tb-input{width:120px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px}
    .tb-select{padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px}
    .sep{width:1px; height:28px; background:#e5e7eb; margin:0 2px}
    .notice{font-size:12px; color:#64748b}


    /* Location name label */
    .placelabel{
      background:rgba(255,255,255,.95);
      color:#0f172a; border:1px solid #e5e7eb; border-radius:8px;
      box-shadow:0 2px 8px rgba(2,8,20,.12); padding:4px 6px; font-weight:600
    }
    
    .placelabel .leaflet-tooltip-content-wrapper { padding: 0; }
    .placelabel .leaflet-tooltip-content {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 4px 2px 4px 8px;
      line-height: 1.2;
    }
    .placelabel-content { margin-right: 4px; }
    .placelabel-close {
      border: none; background: transparent; cursor: pointer;
      font-size: 18px; line-height: 1; padding: 0 4px;
      color: var(--muted);
    }
    .placelabel-close:hover { color: var(--ink); }


    /* Bolder credits */
    .leaflet-control-attribution span[title="Author"]{ font-weight:600; }

    /* Mobile fullscreen button */
    .fs-btn-mobile{ display:none; bottom:40px; left:12px; right:auto; top:auto; }
    @media (max-width:640px){
      #fsBtn{ display:none; }
      #fsBtnMobile{ display:inline-flex; }
    }
    
    /* Notifications */
    .notification {
      position: absolute; z-index: 1003; top: 75px; left: 50%;
      transform: translateX(-50%);
      background: rgba(40,40,40,0.9); color: #fff;
      padding: 10px 20px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0; visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      text-align: center;
      max-width: 90%;
    }
    .notification.show { opacity: 1; visibility: visible; }
    .notification.error { background: rgba(217, 48, 37, 0.9); }

    /* Styling for the in-map title */
    .map-title {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 1002;
        background: rgba(255, 255, 255, 0.92);
        padding: 8px 12px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(2,8,20,.12);
        font-weight: 700;
        font-size: 16px;
        pointer-events: none; /* So it doesn't block map clicks */
        max-width: calc(100% - 80px); /* To avoid overlapping with the fullscreen button */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    @media (max-width: 640px) {
        .map-title {
            font-size: 14px;
            padding: 6px 10px;
        }
    }

    /* MODIFIED: Styling for new coordinate and data panel */
    #coordPanel {
      margin-top: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .coord-inputs-vertical {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
    }
    .coord-inputs-vertical .tb-input {
      width: 140px;
      padding: 10px;
      font-size: 14px;
      text-align: center;
    }
    .data-table-wrapper {
      flex-grow: 1;
      overflow-x: auto;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .data-table th, .data-table td {
      border: 1px solid #e2e8f0;
      padding: 10px;
      text-align: center;
      white-space: nowrap;
    }
    .data-table th {
      background-color: #f8fafc;
      font-weight: 600;
    }
    .data-table td:first-child, .data-table th:first-child {
      text-align: left;
      font-weight: 600;
    }
    
    /* NEW: Styling for mobile data view */
    .mobile-data-view {
        display: none; /* Hidden by default */
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 12px;
        font-family: monospace;
        white-space: pre;
        font-size: 13px;
        line-height: 1.5;
        flex-grow: 1;
        overflow-x: auto;
    }

    /* MODIFIED: Responsive layout for the coordinate panel */
    @media (max-width: 768px) {
      #coordPanel {
        gap: 16px;
        align-items: center;
      }
      .data-table-wrapper {
        display: none; /* Hide desktop table on mobile */
      }
      .mobile-data-view {
        display: block; /* Show mobile list instead */
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card fs-host" id="mapCard">
      <!-- In-map title -->
      <div id="mapTitle" class="map-title">Explosion Contour</div>

      <!-- Fullscreen desktop -->
      <button id="fsBtn" class="fs-btn" aria-pressed="false" title="Fullscreen (F)">⛶ Fullscreen</button>
      <!-- Fullscreen mobile (appears automatically on small screens) -->
      <button id="fsBtnMobile" class="fs-btn fs-btn-mobile" aria-pressed="false" title="Fullscreen">⛶ Fullscreen</button>

      <!-- Mini toolbar (hidden, but holds the inputs temporarily) -->
      <div class="toolbar" role="region" aria-label="Map Controls">
        <input id="latIn" class="tb-input" type="number" step="any" aria-label="Latitude" placeholder="Latitude">
        <input id="lonIn" class="tb-input" type="number" step="any" aria-label="Longitude" placeholder="Longitude">
      </div>

      <div id="map" role="region" aria-label="Explosion contour map"></div>
      <div id="notification" class="notification"></div>
    </div>
    
    <!-- MODIFIED: Coordinate and Data Panel -->
    <div id="coordPanel" class="card"></div>

  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // ======= BUILT-IN DEFAULTS =======
  const BUILTIN_DEFAULTS = {
    lat: 33.901436, lon: 35.519057,
    csv:
`49, 2042.348
150, 159.4947
300, 41.51972
500, 19.59217
1000, 8.648397
3000, 2.768441`,
    np: 90, iv: 250, os: 0.3, of: 0.2, sw: 0.3, pal: 'bright',
    showLabel: true
  };
  const LS_KEY  = 'explosionContour:v1';
  const RG_KEY  = 'explosionContour:revgeo:v2';

  // ======= Parser & CSV =======
  function parseNumberLoose(s){
    if (s==null) return NaN;
    s = String(s).trim().replace(/\s+/g,'').replace(/\u00A0/g,'');
    if (/^\d{1,3}(\.\d{3})+,\d+$/.test(s)) s = s.replace(/\./g,'').replace(',', '.');
    else if (/^\d+,\d+$/.test(s)) s = s.replace(',', '.');
    else s = s.replace(/(?<=\d),(?=\d{3}(?:\D|$))/g, '');
    return Number(s);
  }
  function extractNumbers(line){
    const toks = String(line).match(/-?\d+(?:[.,]\d+)?/g) || [];
    return toks.map(parseNumberLoose).filter(n=>Number.isFinite(n));
  }
  function parseData(text){
    const out = [];
    const rows = (text||'').split(/[\r\n]+/).map(r=>r.trim()).filter(Boolean);
    for (const r of rows){
      const nums = extractNumbers(r);
      if (!nums.length) continue;
      const rVal = nums[0];
      const poVal = nums.length>1 ? nums[1] : null;
      if (rVal > 0) out.push({ r: rVal, Po: (poVal!=null && Number.isFinite(poVal)) ? poVal : null });
    }
    out.sort((a,b)=>a.r-b.r);
    return out;
  }
  
  let notifTimer = null;
  function showNotification(message, isError = false){
      const el = document.getElementById('notification');
      el.textContent = message;
      el.className = 'notification'; // reset
      if (isError) el.classList.add('error');
      el.classList.add('show');
      if (notifTimer) clearTimeout(notifTimer);
      notifTimer = setTimeout(() => {
          el.classList.remove('show');
      }, 4000); // Notification duration is slightly longer
  }

  // ======= QS read-only =======
  function b64urlToStr(b64u){
    try{
      const b64 = b64u.replace(/-/g,'+').replace(/_/g,'/') + '==='.slice(b64u.length%4);
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
      return new TextDecoder().decode(bytes);
    }catch{ return ''; }
  }
  function readFromQS(){
    const sp = new URLSearchParams(location.search);
    if (!sp || [...sp].length===0) return {};
    const obj = {};
    if (sp.has('lat')) obj.lat = parseNumberLoose(sp.get('lat'));
    if (sp.has('lon')) obj.lon = parseNumberLoose(sp.get('lon'));
    if (sp.has('np'))  obj.np  = Math.max(16, Math.min(360, parseInt(sp.get('np'),10) || 0));
    if (sp.has('iv'))  obj.iv  = Math.max(0, parseInt(sp.get('iv'),10) || 0);
    if (sp.has('os'))  obj.os  = Math.max(0, Math.min(1, parseNumberLoose(sp.get('os'))));
    if (sp.has('of'))  obj.of  = Math.max(0, Math.min(1, parseNumberLoose(sp.get('of'))));
    if (sp.has('sw'))  obj.sw  = Math.max(0, parseNumberLoose(sp.get('sw')));
    if (sp.has('pal')) {
      const v = sp.get('pal').toLowerCase();
      if (['bright','cerah','default'].includes(v)) obj.pal = 'bright';
      else if (['bluegreen','biru-hijau','biru','hijau','bg'].includes(v)) obj.pal = 'bluegreen';
      else if (['heat','panas'].includes(v)) obj.pal = 'heat';
    }
    if (sp.has('label')) {
      const v = sp.get('label').toLowerCase();
      obj.showLabel = !(v==='0' || v==='false' || v==='no' || v==='off');
    }
    if (sp.has('csvb64')) { const s = b64urlToStr(sp.get('csvb64')||''); if (s) obj.csv = s; }
    else if (sp.has('csv')) { let v = sp.get('csv')||''; obj.csv = v.replace(/\|/g,'\n').replace(/;/g,'\n'); }
    return Object.fromEntries(Object.entries(obj).filter(([,v])=>v!==undefined && v!==null && v!==''));
  }

  // ======= localStorage =======
  function loadSaved(){
    try { const o = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); return (o && typeof o==='object') ? o : {}; }
    catch{ return {}; }
  }
  function savePartial(patch){
    settings = { ...settings, ...patch };
    try { localStorage.setItem(LS_KEY, JSON.stringify(settings)); } catch {}
  }

  // ======= Compose settings (QS ➜ LS ➜ Built-in) =======
  let settings = { ...BUILTIN_DEFAULTS, ...loadSaved(), ...readFromQS() };

  // ======= Geodesic helpers =======
  const R_EARTH = 6371008.8; // m
  function destPoint(latDeg, lonDeg, distanceM, bearingDeg){
    const φ1 = latDeg * Math.PI/180, λ1 = lonDeg * Math.PI/180;
    const θ = bearingDeg * Math.PI/180, δ = distanceM / R_EARTH;
    const sinφ1 = Math.sin(φ1), cosφ1 = Math.cos(φ1);
    const sinδ = Math.sin(δ), cosδ = Math.cos(δ);
    const sinφ2 = sinφ1*cosδ + cosφ1*sinδ*Math.cos(θ);
    const φ2 = Math.asin(sinφ2);
    const y = Math.sin(θ)*sinδ*cosφ1, x = cosδ - sinφ1*sinφ2;
    let λ2 = λ1 + Math.atan2(y, x);
    λ2 = ((λ2 + 3*Math.PI) % (2*Math.PI)) - Math.PI;
    return [φ2 * 180/Math.PI, λ2 * 180/Math.PI];
  }
  function circleCoordsGeodesic(lat0, lon0, Rm, n=90){
    const coords = [];
    for(let i=0;i<=n;i++){
      const bearing = 360 * i / n;
      const [lat, lon] = destPoint(lat0, lon0, Rm, bearing);
      coords.push([lat, lon]);
    }
    return coords;
  }

  // ======= Map init =======
  const map = L.map('map', {
    center:[settings.lat, settings.lon],
    zoom: 14,
    zoomControl: false
  });
  const canvasRenderer = L.canvas({ padding: 0.3 });
  
  const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19, attribution:'Tiles © Esri'
  });

  satelliteLayer.on('tileerror', function(event) {
      console.error('Tile load error:', event);
      showNotification('Failed to load map data. Check your internet connection.', true);
      satelliteLayer.off('tileerror');
  });
  satelliteLayer.addTo(map);

  L.control.scale({imperial:false, position: 'bottomright'}).addTo(map);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  const creditHTML =
    `<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a> · ` +
    `<span title="Author">Credit by <a href="https://id.linkedin.com/in/virdanurlulu" target="_blank" rel="nofollow noopener">Virda Nur Lu'lu</a></span>`;
  map.attributionControl.setPrefix(creditHTML);

  // ======= Palettes =======
  const palettes = {
    bright: ["#FF0000","#FFA500","#FFFF00","#00FF00","#00FFFF","#0000FF","#FF00FF","#800080","#FFC0CB","#A52A2A"],
    bluegreen: ["#203a8f","#2d6cdf","#3fb6ff","#27c3a4","#15a371","#0f7a54","#0b533b","#083b2c"],
    heat: ["#4b0d0d","#7a1f0e","#ad3510","#e65a0d","#ff8c00","#ffb200","#ffd000","#ffe680"]
  };

  // ======= Reverse Geocoding (Latin/EN, cache, fallback) =======
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function isRTL(str){ return /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/.test(str); }
  function rgKey(lat, lon){ return `${lat.toFixed(5)},${lon.toFixed(5)}`; }
  function rgLoadCache(){ try{ return JSON.parse(localStorage.getItem(RG_KEY)||'{}'); }catch{ return {}; } }
  function rgSaveCache(obj){ try{ localStorage.setItem(RG_KEY, JSON.stringify(obj)); }catch{} }

  async function fetchNominatimEN(lat, lon){
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=8&addressdetails=1&namedetails=1&accept-language=en`;
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    if (!r.ok) throw new Error(`Nominatim request failed with status ${r.status}`);
    const j = await r.json();
    const a = j.address || {};
    
    if (a.sea || a.ocean || j.type === 'sea' || j.type === 'ocean' || j.type === 'water' || (j.category === 'natural' && j.type === 'water')) {
        return a.sea || a.ocean || j.name || j.display_name;
    }

    const city = a.city || a.town;
    const country = a.country || '';
    const joined = [city, country].filter(Boolean).join(', ');
    return joined;
  }

  // MODIFIED: Restructured the geocoding logic for clarity and better error handling
  async function reverseGeocode(lat, lon){
    const key = rgKey(lat, lon);
    const cache = rgLoadCache();
    const TTL = 30*24*3600*1000; // 30 days
    if (cache[key] && (Date.now()-cache[key].ts) < TTL) return cache[key].name;

    let finalName = '';

    try{
      let name = await fetchNominatimEN(lat, lon);
      if (name && !isRTL(name)) {
        finalName = name;
      }
    } catch(e) {
        console.error("Nominatim fetch failed:", e);
    }

    if (!finalName) {
        try{
          const r = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`);
          if (r.ok){
            const j = await r.json();
            if (j.results && j.results.length){
              const g = j.results[0];
              const name = [g.name, g.country].filter(Boolean).join(', ');
              if (name){
                finalName = name;
              }
            }
          } else {
              throw new Error(`Open-Meteo request failed with status ${r.status}`);
          }
        } catch(e) {
            console.error("Open-Meteo fetch failed:", e);
        }
    }
    
    if (finalName) {
        cache[key] = {name: finalName, ts: Date.now()}; rgSaveCache(cache);
        return finalName;
    }

    showNotification('The entered coordinate value is outside the valid range.', true);
    return '';
  }

  let centerMarker = null;
  let placeName = '';
  let mapTitleEl = null;
  let dataTableContainer = null;
  let mobileDataContainer = null;

  // ======= Heading updater =======
  function setHeading(name){
    const label = (name && name.trim()) ? name.trim() : `${settings.lat.toFixed(5)}, ${settings.lon.toFixed(5)}`;
    const txt = `Explosion Contour - ${label}`;
    document.title = txt;
    if (mapTitleEl) mapTitleEl.textContent = txt;
  }

  function setLabelButton(){
    const b = document.getElementById('btnLabel');
    if(b) b.textContent = (settings.showLabel ? '👁 Label: On' : '🚫 Label: Off');
  }

  function _attachTooltipCloseHandler(tooltip) {
    if (!tooltip || !tooltip._container) return;
    const closeBtn = tooltip._container.querySelector('.placelabel-close');
    if (closeBtn) {
      L.DomEvent.on(closeBtn, 'click', (event) => {
        L.DomEvent.stop(event);
        if (centerMarker) centerMarker.closeTooltip();
      });
    }
  }

  function ensureCenterMarker(lat, lon, name){
    if (!centerMarker){
      centerMarker = L.circleMarker([lat, lon], {
        renderer: canvasRenderer, radius: 5,
        color:'#111', weight:1, fillColor:'#fff', fillOpacity:1
      }).addTo(map);

      centerMarker.on('tooltipopen', function (e) {
        _attachTooltipCloseHandler(e.tooltip);
      });
    } else {
      centerMarker.setLatLng([lat, lon]);
    }

    if (!settings.showLabel){
      if (centerMarker.getTooltip()) centerMarker.unbindTooltip();
      return;
    }

    const locationName = name ? esc(name) : `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    const labelContent = `<span class="placelabel-content">📍 ${locationName}</span><button class="placelabel-close" title="Close">×</button>`;
    
    const t = centerMarker.getTooltip();
    if (t) {
        t.setContent(labelContent);
        if (centerMarker.isTooltipOpen()) {
            _attachTooltipCloseHandler(t);
        }
    } else {
        centerMarker.bindTooltip(labelContent, {permanent:true, direction:'right', offset:[8,0], className:'placelabel'});
    }
    
    if (!centerMarker.isTooltipOpen()) {
        centerMarker.openTooltip();
    }
  }

  async function refreshPlaceName(lat, lon){
    placeName = await reverseGeocode(lat, lon);
    ensureCenterMarker(lat, lon, placeName);
    setHeading(placeName);
  }

  // ======= Animation & Data =======
  let rings = parseData(settings.csv);
  let finalLayer = null;

  function clearLayers(){
    if (finalLayer){ map.removeLayer(finalLayer); finalLayer=null; }
    const toRemove = [];
    map.eachLayer(l=>{ if(l instanceof L.Polygon || l instanceof L.GeoJSON){ toRemove.push(l); } });
    toRemove.forEach(l=>map.removeLayer(l));
  }
  
  // MODIFIED: Function to update both desktop and mobile data views
  function updateDataViews() {
      // Desktop Table
      if (dataTableContainer) {
        const pressureHeader = rings.some(r => r.Po != null) ? 'Pressure (kPa)' : 'Pressure';
        let tableHTML = `<table class="data-table"><thead><tr><th>Radius (m)</th>`;
        rings.forEach(ring => {
            tableHTML += `<th>${ring.r}</th>`;
        });
        tableHTML += `</tr></thead><tbody><tr><td>${pressureHeader}</td>`;
        rings.forEach(ring => {
            tableHTML += `<td>${ring.Po != null ? ring.Po.toFixed(3) : '-'}</td>`;
        });
        tableHTML += `</tr></tbody></table>`;
        dataTableContainer.innerHTML = tableHTML;
      }
      
      // Mobile List
      if (mobileDataContainer) {
        let dataText = '';
        rings.forEach(ring => {
            dataText += `${String(ring.r).padEnd(5)} ${ring.Po != null ? ring.Po.toFixed(3) : '-'}\n`;
        });
        mobileDataContainer.textContent = dataText.trim();
      }
  }

  function drawInitialState(){
    clearLayers();
    rings = parseData(settings.csv);
    
    const pal = (palettes[settings.pal] || palettes.bright);
    const reversed = rings.slice().reverse();
    finalLayer = L.featureGroup(
      reversed.map((d, irev)=>{
        const coords = circleCoordsGeodesic(settings.lat, settings.lon, d.r, settings.np);
        return L.polygon(coords, {
          renderer: canvasRenderer, color:"#000000", weight:settings.sw,
          fillColor: pal[(rings.length-1-irev) % pal.length], fillOpacity: settings.of
        }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po}</code>`:''}`);
        })
      ).addTo(map);
    try{ map.fitBounds(finalLayer.getBounds(), {padding:[20,20]}); }catch(e){}
    updateDataViews(); // Update data views
  }

  // ======= Fullscreen (desktop & mobile) =======
  const fsBtn = document.getElementById('fsBtn'),
        fsBtnMobile = document.getElementById('fsBtnMobile'),
        mapCard = document.getElementById('mapCard');

  function setFSLabel(on){
    const txt = on ? '⛶ Exit Fullscreen' : '⛶ Fullscreen';
    [fsBtn, fsBtnMobile].forEach(b=>{
      if(!b) return;
      b.textContent = txt;
      b.setAttribute('aria-pressed', on ? 'true' : 'false');
    });
  }
  function enterFS(){
    mapCard.classList.add('fullscreen'); document.body.classList.add('fs-lock');
    if (mapCard.requestFullscreen) { mapCard.requestFullscreen().catch(()=>{}); }
    else if (mapCard.webkitRequestFullscreen) { mapCard.webkitRequestFullscreen(); } // iOS Safari
    setFSLabel(true);
    setTimeout(()=>map.invalidateSize(), 180);
  }
  function exitFS(){
    mapCard.classList.remove('fullscreen'); document.body.classList.remove('fs-lock');
    if (document.fullscreenElement && document.exitFullscreen) { document.exitFullscreen().catch(()=>{}); }
    else if (document.webkitFullscreenElement && document.webkitCancelFullScreen) { document.webkitCancelFullScreen(); }
    setFSLabel(false);
    setTimeout(()=>map.invalidateSize(), 180);
  }
  function toggleFS(){ mapCard.classList.contains('fullscreen') ? exitFS() : enterFS(); }

  fsBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFS(); });
  fsBtnMobile?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFS(); });

  document.addEventListener('fullscreenchange', ()=>{
    const active = !!document.fullscreenElement || mapCard.classList.contains('fullscreen');
    if (!document.fullscreenElement) { mapCard.classList.remove('fullscreen'); document.body.classList.remove('fs-lock'); }
    setFSLabel(active);
  });

  document.addEventListener('keydown', (e)=>{
    if (document.activeElement.tagName === 'INPUT') return; // Don't trigger shortcuts if typing
    if (e.key.toLowerCase() === 'f') { e.preventDefault(); toggleFS(); }
    if (e.key === 'Escape' && mapCard.classList.contains('fullscreen')) { exitFS(); }
  });

  window.addEventListener('resize', ()=>{
    if (mapCard.classList.contains('fullscreen')) {
      clearTimeout(window.__fsRaf);
      window.__fsRaf = setTimeout(()=>map.invalidateSize(), 120);
    }
  });

  // ======= Coordinate Input handling =======
  async function handleCoordUpdate() {
      const latInput = document.getElementById('latIn');
      const lonInput = document.getElementById('lonIn');
      const lat = parseFloat(latInput.value);
      const lon = parseFloat(lonInput.value);

      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
          return;
      }
      if (lat < -90 || lat > 90) {
          showNotification('Latitude must be between -90 and 90.', true);
          return;
      }
      if (lon < -180 || lon > 180) {
          showNotification('Longitude must be between -180 and 180.', true);
          return;
      }

      savePartial({ lat, lon });
      settings.lat = lat;
      settings.lon = lon;
      map.setView([lat, lon], map.getZoom());
      setHeading(null);
      await refreshPlaceName(lat, lon);
      drawInitialState();
  }
  
  function debounce(func, delay) {
      let timeout;
      return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
      };
  }
  
  const debouncedCoordUpdate = debounce(handleCoordUpdate, 750);

  // ======= Start =======
  (function init(){
    mapTitleEl = document.getElementById('mapTitle');

    // Create and move coordinate inputs and data table to the panel
    const coordPanel = document.getElementById('coordPanel');
    const toolbar = document.querySelector('.toolbar');
    
    if (coordPanel && toolbar) {
        const coordInputsVertical = document.createElement('div');
        coordInputsVertical.className = 'coord-inputs-vertical';

        dataTableContainer = document.createElement('div');
        dataTableContainer.className = 'data-table-wrapper';

        mobileDataContainer = document.createElement('div');
        mobileDataContainer.className = 'mobile-data-view';
        
        const elementsToMove = [
            document.getElementById('latIn'),
            document.getElementById('lonIn'),
        ];
        
        elementsToMove.forEach(el => {
            if (el) coordInputsVertical.appendChild(el);
        });

        coordPanel.appendChild(coordInputsVertical);
        coordPanel.appendChild(dataTableContainer);
        coordPanel.appendChild(mobileDataContainer);
    }

    document.getElementById('latIn').value = settings.lat;
    document.getElementById('lonIn').value = settings.lon;
    document.getElementById('latIn').addEventListener('input', debouncedCoordUpdate);
    document.getElementById('lonIn').addEventListener('input', debouncedCoordUpdate);

    setHeading(null); 
    refreshPlaceName(settings.lat, settings.lon);
    setFSLabel(false);
    drawInitialState();
  })();
  </script>
</body>
</html>

