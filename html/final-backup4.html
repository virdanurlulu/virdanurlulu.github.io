<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulation & Modeling of Explosion Effects (TNT Equivalence)</title>

  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="canonical" href="https://virdanurlulu.github.io/">
  <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
  <link rel="dns-prefetch" href="https://raw.githubusercontent.com">
  <link rel="preload" as="image" href="/img/banner-itb1.webp">

  <meta name="description" content="Interactive Simulation and Modeling of Explosion Effects Based on TNT Equivalence Using JavaScript: Incorporating Chemical Material Properties, Consequence Estimation, Pa–Ze Relationship, Overpressure–Distance Chart, and Visualization of Explosion Overpressure Contours.">
  <meta name="author" content="Virda Nur Lu'lu">
  <meta name="robots" content="index,follow">
  <meta name="theme-color" content="#0079c2">
  <meta name="color-scheme" content="light dark">

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Master’s Program in Chemical Engineering, Bandung Institute of Technology">
  <meta property="og:title" content="Simulation and Modeling of Explosion Effects Based on TNT Equivalence using Javascript">
  <meta property="og:description" content="Interactive Simulation and Modeling of Explosion Effects Based on TNT Equivalence Using JavaScript: Incorporating Chemical Material Properties, Consequence Estimation, Pa–Ze Relationship, Overpressure–Distance Chart, and Visualization of Explosion Overpressure Contours.">
  <meta property="og:url" content="https://virdanurlulu.github.io/">
  <meta property="og:image" content="https://virdanurlulu.github.io/img/ITB-Exlosion-Modeling-Simulation.webp">
  <meta property="og:image:type" content="image/webp">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Simulation and Modeling of Explosion Effects Based on TNT Equivalence using Javascript">
  <meta name="twitter:description" content="Interactive Simulation and Modeling of Explosion Effects Based on TNT Equivalence Using JavaScript: Incorporating Chemical Material Properties, Consequence Estimation, Pa–Ze Relationship, Overpressure–Distance Chart, and Visualization of Explosion Overpressure Contours.">
  <meta name="twitter:image" content="https://virdanurlulu.github.io/img/ITB-Exlosion-Modeling-Simulation.webp">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Explosion Effects Simulation & Modeling (TNT Equivalence)", 
    "applicationCategory": "EducationalApplication",
    "operatingSystem": "Web",
    "url": "https://virdanurlulu.github.io/",
    "image": "https://virdanurlulu.github.io/img/ITB-Exlosion-Modeling-Simulation.webp",
    "author": {"@type": "Person", "name": "Virda Nur Lu'lu", "sameAs": ["https://id.linkedin.com/in/virdanurlulu"]},
    "inLanguage": "en",
    "description": "Interactive Simulation and Modeling of Explosion Effects Based on TNT Equivalence Using JavaScript: Incorporating Chemical Material Properties, Consequence Estimation, Pa–Ze Relationship, Overpressure–Distance Chart, and Visualization of Explosion Overpressure Contours.",
    "publisher": {"@type": "Organization", "name": "Bandung Institute of Technology", "url": "https://che.itb.ac.id/"}
  }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  
  <style>
    :root {
      --ink: #1e2b3b;
      --muted: #64748b;
      --card: #ffffff;
      --bg: #f5f7fb;
      --blue-itb: #0079c2;
      --stripe: #eaf3fb;
      --ring: rgba(0, 121, 194, 0.25);
      --danger: #DC2626;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    body.dragging {
        user-select: none;
    }
    .wrap { max-width: 1280px; margin: 32px auto; padding-left: max(16px, env(safe-area-inset-left)); padding-right: max(16px, env(safe-area-inset-right)); }
    body.full .wrap { max-width: none; width: 100%; padding: 0; margin: 0 auto; }
    body.full .banner, body.full main.split { padding-left: max(20px, env(safe-area-inset-left)); padding-right: max(20px, env(safe-area-inset-right)); }
    body.full .banner { border-radius: 0; padding-top: clamp(16px, 2.2vw, 24px); padding-bottom: clamp(16px, 2.2vw, 24px); margin-bottom: 18px; }
    body.full main.split { margin-top: 18px; }
    .title { display: grid; gap: 6px; }
    .title h1 { margin: 0; font-size: clamp(24px, 3.2vw, 44px); line-height: 1.25; font-family: Georgia, "Times New Roman", serif; color: #fff; padding: 6px 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); max-width: clamp(560px, 70vw, 62ch); }
    @supports (text-wrap: balance) { .title h1 { text-wrap: balance; } }
    .title h2 { margin: 0; font-size: clamp(12px, 1.2vw, 16px); font-weight: 600; color: #fff; }
    .banner { position: relative; color: #fff; background-image: url("https://virdanurlulu.github.io/img/banner-itb1.webp"); background-size: cover; background-position: center; padding: clamp(16px, 2.2vw, 24px) clamp(16px, 2.4vw, 28px); min-height: clamp(120px, 20vw, 240px); border-radius: 14px; box-shadow: 0 6px 20px rgba(2, 41, 77, 0.12); margin-bottom: 18px; display: flex; justify-content: space-between; align-items: flex-start;}
    .title h1, .title h2 { text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25); }
    .brandbar { display: flex; align-items: center; gap: 16px; }
    .brand-logo { height: clamp(56px, 6.5vw, 96px); width: auto; }
    .nowrap { white-space: nowrap; }
    .brand-text { display: flex; flex-direction: column; gap: 6px; }
    .card { background: var(--card); border-radius: 14px; overflow: hidden; box-shadow: 0 4px 14px rgba(10, 34, 64, 0.08); margin-bottom: 18px; }
    .card-header { background: var(--blue-itb); color: #e9f5ff; font-weight: 700; padding: 10px 14px; font-family: Georgia, "Times New Roman", serif; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .card-header .btn { padding: 6px 10px; font-size: 12px; background: #fff; color: var(--blue-itb); border: none; cursor: pointer; border-radius: 6px; transition: background-color 0.2s; }
    .card-header .btn:disabled { background-color: #e0e0e0; color: #9e9e9e; cursor: not-allowed; }
    .log-actions { display: flex; flex-wrap: wrap; gap: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; vertical-align: middle; text-align: left; font-size: 14px; }
    thead th { background: var(--stripe); font-weight: 700; color: #294050; border-bottom: 1px solid #dbe7f2; }
    tbody tr:nth-child(even) { background: #fbfdff; }
    tbody tr { border-bottom: 1px solid #eef4fa; }
    .label { font-weight: 600; display: block; margin-bottom: 4px; font-size: 14px;}
    .ref { color: var(--blue-itb); font-size: 12px; }
    input[type="number"], input[readonly], input[type="text"], input[type="text"][readonly], select { width: 100%; border: 1px solid #d6e3ef; background: #fff; color: var(--ink); border-radius: 10px; padding: 10px 12px; min-height: 40px; outline: none; transition: 0.2s box-shadow, 0.2s border-color; font-size: 16px; }
    input[readonly], input[type="text"][readonly] { background: #f6f9fd; color: #475569; }
    input:focus, select:focus { border-color: var(--blue-itb); box-shadow: 0 0 0 4px var(--ring); }
    input.input-error { border-color: var(--danger) !important; box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.25) !important; }
    .chem-grid { display: grid; grid-template-columns: 1.3fr 1fr; gap: 14px; align-items: start; }
    .mini { display: flex; gap: 12px; align-items: flex-start; }
    .mini > * { flex: 1; }
    .matcol { display: flex; flex-direction: column; gap: 12px; }
    .eq-panel { border: 1px solid #dbe7f2; background: var(--card); color: var(--ink); border-radius: 12px; padding: 12px; }
    .eq-title { font-weight: 700; color: var(--blue-itb); margin-bottom: 8px; }
    .rxn { padding: 10px 12px; border: 1px dashed #c9d8e6; border-radius: 10px; margin-top: 8px; background: var(--stripe); }
    .rxn small { display: block; color: #334155; margin-bottom: 4px; }
    .rxn-eq { font-family: "Times New Roman", Georgia, serif; font-size: 16px; color: var(--ink); }
    .rxn-eq .arrow { padding: 0 6px; font-weight: 700; }
    .status { padding: 8px 12px; border-left: 4px solid #0ea5e9; background: #ebf8ff; color: #075985; border-radius: 10px; display: none; margin-top: 8px; }
    .status.bad { border-left-color: var(--danger); background: #fff1f2; color: #be123c; }
    .footnote { font-size: 12px; color: var(--muted); margin-top: 8px; }
    main.split { display: grid; grid-template-columns: 2fr 3fr; gap: 18px; }
    .left, .right { display: flex; flex-direction: column; gap: 18px; min-width: 0; }
    .right { position: sticky; top: 12px; align-self: start; }
    .method-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 12px; padding: 12px; }
    .method-card { position: relative; min-height: 220px; border: 1px solid #dbe7f2; background: #fff; border-radius: 12px; overflow: hidden; }
    .method-card .vlabel { background: var(--stripe); color: var(--blue-itb); padding: 8px 12px; font-weight: 700; text-align: center; border-bottom: 1px solid #e6eef6; }
    .method-card .pad { padding: 10px 10px 40px 10px; height: 100%; color: var(--ink); font-size: 14px; }
    .sevfoot { position: absolute; left: 0; right: 0; bottom: 0; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .damage-category { margin-top: 10px; }
    .damage-category strong { color: var(--blue-itb); }
    .damage-category ul { padding-left: 20px; margin-top: 5px; list-style-type: disc;}
    .app-footer { margin-top: 20px; color: #fff; background-color: var(--blue-itb); width: 100vw; margin-left: calc(50% - 50vw); padding: 24px 16px; border-top: 1px solid rgba(255, 255, 255, 0.25); text-align: center; }
    .app-footer .footer-content { max-width: 1280px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .app-footer .credit { font-weight: 700; color: #e9f5ff; }
    .app-footer .dedication { font-size: 13px; line-height: 1.6; max-width: 960px; }
    .app-footer a:not(.btn-home-3d) { color: #fff; text-decoration: none; }
    .btn-home-3d { --button-bg-top: #CC00CC; --button-bg-bottom: #990099; --button-shadow: #660066; --button-active-shadow: #440044; display: inline-flex; align-items: center; justify-content: center; padding: 1px 20px; font-size: 12px; font-weight: normal; color: #ffffff; background: linear-gradient(to bottom, var(--button-bg-top) 0%, var(--button-bg-bottom) 100%); border: none; border-radius: 8px; cursor: pointer; position: relative; outline: none; transform: translateY(0); transition: all 0.2s ease; box-shadow: 0 4px 0 var(--button-shadow); text-decoration: none; }
    .btn-home-3d:hover { transform: translateY(-2px); box-shadow: 0 6px 0 var(--button-shadow); }
    .btn-home-3d:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--button-active-shadow); }
    .footer-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
    .dropdown-menu {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1002; /* Memastikan menu tampil di atas elemen lain */
    }
    .dropdown-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: rgba(255, 255, 255, 0.9);
      color: var(--ink);
      padding: 8px 16px;
      font-size: 16px;
      font-weight: 600;
      border: 1px solid #d6e3ef;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .dropdown-toggle:hover {
      background-color: #ffffff;
      border-color: var(--blue-itb);
    }
    .dropdown-toggle .hamburger-icon {
      font-size: 20px;
      line-height: 1;
    }
    .dropdown-content {
      display: none; /* Disembunyikan secara default */
      opacity: 0;
      visibility: hidden;
      position: absolute;
      right: 0;
      top: 110%;
      background-color: #ffffff;
      min-width: 220px;
      box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      overflow: hidden;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
    }
    .dropdown-menu.is-active .dropdown-content {
      display: block;
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .dropdown-content a {
      color: var(--ink);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background-color 0.2s ease, color 0.2s ease;
      font-weight: 500;
      white-space: nowrap;
    }
    .dropdown-content a:hover {
      background-color: var(--stripe);
      color: var(--blue-itb);
    }
    .chart-container { padding: 12px; background-color: var(--card); border-radius: 14px; position: relative; }
    #chart, #overpressureChart { width: 100%; height: 500px; }
    .chart-note { margin-top: 4px; text-align: center; font-style: italic; color: var(--muted); font-size: 11px; }
    #overpressureChartMsg { color: var(--muted); font-style: italic; padding: 20px; font-size: 14px; text-align: center; }
    .table-wrapper { overflow-x: auto; }
    #logTable { font-size: 12px; }
    #logTable th, #logTable td { padding: 6px 8px; white-space: nowrap; }
    #logTable .col-action { width: 40px; text-align: center; }
    #logTable .log-placeholder td { text-align: center; color: var(--muted); padding: 20px; font-style: italic; }
    .btn-delete { background: none; border: none; cursor: pointer; padding: 4px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; width: 24px; height: 24px; transition: background-color 0.2s;}
    .btn-delete:hover { background-color: #fee2e2; }
    .btn-delete svg { width: 14px; height: 14px; stroke: #ef4444; }
    @keyframes fadeIn { from { background-color: #ebf8ff; } to { background-color: transparent; } }
    .new-row-animation { animation: fadeIn 1.5s ease-out; }
    #toTop { position: fixed; bottom: 20px; right: 20px; z-index: 1000; cursor: pointer; border-radius: 50%; width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: var(--blue-itb); color: white; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-size: 24px; opacity: 0; visibility: hidden; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s; }
    #toTop.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #toTop:hover { background-color: #005a8c; }
   
    #floatingControlPanel { display: none; position: fixed; z-index: 1001; background-color: var(--card); border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); transition: all 0.4s ease-in-out; width: auto; max-width: 90%; left: 50%; bottom: 20px; transform: translateX(-50%); }
    #floatingControlPanel.visible { display: block; }
    .floating-panel-header { cursor: move; padding: 10px 14px; background-color: var(--blue-itb); color: white; border-top-left-radius: 14px; border-top-right-radius: 14px; display: flex; justify-content: space-between; align-items: center; }
    .floating-panel-header h3 { margin: 0; font-size: 12px; font-family: Georgia, "Times New Roman", serif; transition: opacity 0.3s ease; }
    .floating-panel-action-btn { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.2); color: white; border: none; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
    .floating-panel-body { display: grid; grid-template-areas: "inputs outputs"; grid-template-columns: auto auto; gap: 16px; padding: 14px; align-items: start; max-height: 500px; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, opacity 0.4s ease-in-out;}
    #floatingControlPanel.collapsed {
        width: 44px !important;
        height: 44px;
        border-radius: 50%;
        bottom: auto;
        left: auto;
        top: var(--target-top, 20px);
        right: var(--target-right, 20px);
        transform: none;
        overflow: hidden;
    }
    #floatingControlPanel.collapsed .floating-panel-header { padding: 10px; cursor: pointer; }
    #floatingControlPanel.collapsed h3, #floatingControlPanel.collapsed .floating-panel-body { display: none; }
    #floatingControlPanel.collapsed #floatPanelCollapseBtn { transform: rotate(180deg); }
    #floatPanelInputs { grid-area: inputs; display: flex; flex-direction: column; gap: 10px; }
    #floatPanelOutputs { grid-area: outputs; display: flex; flex-direction: column; gap: 4px; padding-left: 16px; border-left: 2px solid var(--stripe); }
    .floating-group { display: flex; flex-direction: column; }
    #floatPanelOutputs .label { color: var(--muted); font-weight: normal; }
    #floatPanelOutputs .output-values { display: flex; justify-content: space-between; gap: 16px; flex-direction: column; }
    .floating-output-col { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; font-size: 12px; }
    .floating-output-col span:first-child { font-weight: 600; color: var(--muted); }
    .floating-output-col span:last-child { font-family: monospace; color: var(--blue-itb); font-weight: bold; font-size: 16px; }

    #floatingControlPanel .label { font-size: 11px; }
    #floatingControlPanel input, #floatingControlPanel select { font-size: 11px; padding: 8px 10px; min-height: 25px; }
    .floating-output-col span:last-child { font-size: 12px; }
    #logTable .unit-row th { font-weight: normal; font-size: 10px; color: var(--muted); padding-top: 0; padding-bottom: 4px; }

    #language-switcher { position: absolute; bottom: 12px; right: clamp(16px, 2.4vw, 28px); display: flex; gap: 8px; z-index: 10; }
    .lang-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.7); background-color: rgba(255, 255, 255, 0.1); cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); opacity: 0.7; }
    .lang-btn:hover { transform: scale(1.1); opacity: 1; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); }
    .lang-btn.active { border-color: #fff; opacity: 1; transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
    .lang-btn img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

    /* --- CONTOUR MAP STYLES START --- */
    #contourMapContainer {
        height: 75vh;
        display: flex;
        /* padding: 14px; */ /* Padding dipindahkan ke wrapper */
    }
    #mapCard {
        flex-grow: 1;
        position: relative;
        border-radius: 14px;
        box-shadow: 0 8px 24px rgba(2,8,20,.08);
        overflow: hidden; /* Ensures map corners are rounded */
    }
    #map {
        height: 100%;
        width: 100%;
    }
    .legend{ display: none; position:absolute;z-index:1001;bottom:12px;left:12px;background:#fff;border-radius:10px; box-shadow:0 6px 18px rgba(2,8,20,.15);padding:10px 12px;font:13px/1.3 system-ui,Segoe UI,Roboto,Arial}
    .fs-btn{ position:absolute; z-index:1002; top:12px; right:12px; background:rgba(255,255,255,.95); border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer; box-shadow:0 4px 12px rgba(2,8,20,.12); color: var(--ink, #0f172a); }
    .fs-btn:active{transform:translateY(1px)}
    .fs-host.fullscreen{position:fixed; inset:0; z-index:9999; margin:0; border-radius:0; padding:0; background:#000;}
    .fs-host.fullscreen #map{height:100dvh; height:100vh; border-radius:0}
    body.fs-lock{overflow:hidden}
    .placelabel{ background:rgba(255,255,255,.95); color:#0f172a; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 2px 8px rgba(2,8,20,.12); padding:4px 6px; font-weight:600 }
    .placelabel .leaflet-tooltip-content-wrapper { padding: 0; }
    .placelabel .leaflet-tooltip-content { display: flex; align-items: center; justify-content: flex-start; padding: 4px 2px 4px 8px; line-height: 1.2; }
    .placelabel-content { margin-right: 4px; }
    .placelabel-close { border: none; background: transparent; cursor: pointer; font-size: 18px; line-height: 1; padding: 0 4px; color: #64748b; }
    .placelabel-close:hover { color: #0f172a; }
    .leaflet-control-attribution span[title="Author"]{ font-weight:600; }
    .fs-btn-mobile{ display:none; bottom:40px; left:12px; right:auto; top:auto; }
    @media (max-width:640px){ #fsBtn{ display:none; } #fsBtnMobile{ display:inline-flex; } }
    .notification { position: absolute; z-index: 1003; top: 75px; left: 50%; transform: translateX(-50%); background: rgba(40,40,40,0.9); color: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; text-align: center; max-width: 90%; }
    .notification.show { opacity: 1; visibility: visible; }
    .notification.error { background: rgba(217, 48, 37, 0.9); }
    .map-title { position: absolute; top: 12px; left: 12px; z-index: 1002; background: rgba(255, 255, 255, 0.92); padding: 8px 12px; border-radius: 10px; box-shadow: 0 4px 12px rgba(2,8,20,.12); font-weight: 700; font-size: 16px; pointer-events: none; max-width: calc(100% - 150px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    @media (max-width: 640px) { .map-title { font-size: 14px; padding: 6px 10px; } }
    /* --- CONTOUR MAP STYLES END --- */
    
    #mapControls {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        padding-top: 12px;
        margin-top: 12px;
        border-top: 1px solid var(--stripe);
    }
    .coord-inputs, .model-select {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #mapControls label {
        font-weight: 600;
        font-size: 14px;
        color: var(--muted);
    }
    #mapControls input, #mapControls select {
        max-width: 120px;
        font-size: 14px;
        padding: 6px 10px;
        min-height: 36px;
    }
    /* --- Map Controls Styles END --- */

    @media (max-width: 1024px) {
        main.split {
            grid-template-columns: 1fr; /* Stack left and right columns */
        }
        aside.right {
            position: static;
        }
        .method-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .table-wrapper { /* Make ALL tables scrollable */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        #logTable {
            min-width: 900px;
        }
         #prop-head + div .table-wrapper table,
         #param-head + div .table-wrapper table {
            min-width: 600px; /* Set min-width for properties/params tables */
        }
    }

    /* 2. Styles for Mobile Devices in General */
    @media (max-width: 768px) {
        .banner .brand-text h1 { font-size: 1rem; }
        .banner .brand-text h2 { font-size: 0.8rem; }
        .footer-buttons { flex-wrap: wrap; justify-content: center; gap: 8px; }
        #contourMapContainer {
            height: 65vh;
        }
    }

    /* 3. Fine-tuning for Small Screens */
    @media (max-width: 430px) {
        body {
            font-size: 14px;
        }
        .card-header {
            font-size: 0.95rem;
            padding: 10px 14px;
        }
        .card > div[style*="padding"] {
            padding: 12px !important;
        }
        .chem-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        #mapControls {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }
        .coord-inputs {
            display: grid;
            grid-template-columns: auto 1fr;
        }
        .coord-inputs input {
            width: 100%;
            max-width: none;
        }
        .model-select {
            justify-content: space-between;
        }
        .model-select select {
            flex-grow: 1;
        }
    }
    
    /* 4. SPECIFIC FIX for Very Small Screens */
    @media (max-width: 380px) {
        #floatingControlPanel .floating-panel-body {
            grid-template-areas: "inputs" "outputs";
            grid-template-columns: 1fr;
            gap: 12px;
        }
        #floatPanelOutputs {
            padding-left: 0;
            border-left: none;
            padding-top: 12px;
            border-top: 2px solid var(--stripe);
        }
    }

    @media (max-width: 480px) {
      .dropdown-menu {
        top: 12px;
        right: 12px;
      }
      .dropdown-toggle {
        padding: 6px 12px;
        font-size: 14px;
      }
    }

    @media (max-width: 375px) {
        body {
            font-size: 13px;
            -webkit-text-size-adjust: 100%;
        }
        .wrap > .banner.title {
            padding: 8px 0; /* Changed: Ensures horizontal padding is zero */
        }
        .banner .brand-logo {
            width: 50px;
            height: 50px;
        }
        .banner .brand-text h1 { 
            font-size: 0.8rem;
            line-height: 1.25;
        }
        .banner .brand-text h2 { 
            font-size: 0.7rem;
            line-height: 1.3;
        }
        .card > div[style*="padding"] {
            padding: 10px !important;
        }
        table, td, th {
            font-size: 0.9em;
        }
        .footer-buttons .btn-home-3d {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        #contourMapContainer {
            height: 60vh;
            padding: 8px;
        }
    }

    /* 5. Adjustments for Landscape Orientation on Phones */
    @media (max-height: 500px) and (max-width: 926px) and (orientation: landscape) {
        .banner.title {
            display: none;
        }
        .app-footer {
             display: none;
        }
        main.split {
            padding-top: 1rem;
        }
        #contourMapContainer {
            height: 85vh;
        }
    }

  #logTable tbody tr.selected-row {
    background-color: #dbeafe !important; /* Warna biru muda untuk sorotan */
    font-weight: 600;
  }

  #logTable tbody tr:not(.log-placeholder) {
    cursor: pointer; /* Mengubah kursor menjadi pointer saat di atas baris */
  }

  .log-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center; 
  }
  #simulationSelector {
    /* 1. Reset tampilan bawaan browser */
    -webkit-appearance: none;
    appearance: none;

    /* 2. Atur ulang properti dasar (tanpa height eksplisit) */
    width: 200px;
    font-size: 12px;
    font-weight: normal;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    cursor: pointer;
    outline: none;
    border: none;
    border-radius: 6px;
    margin-right: 4px;
    
    /* 3. Atur padding & warna agar sama dengan tombol */
    padding: 6px 30px 6px 10px; /* Padding kanan ditambah untuk ruang panah */
    background-color: #fff;
    color: var(--blue-itb);

    /* 4. Tambahkan ikon panah dropdown custom (SVG) */
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%230079c2' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
  }
  #simulationSelector:hover {
    background-color: #f0f7ff;
  }
  .brand-text .authors {
    font-size: clamp(11px, 1.1vw, 14px);
    font-weight: 400;
    color: hsl(0, 0%, 100%);
    margin: 4px 0 0 0;
    font-style: italic;
    text-shadow: 0 1px 2px rgba(0,0,0,0.25);
  }
  </style>
</head>
<body class="theme-itb full">
  <div class="wrap">
    <div class="banner title">
      <div class="brandbar">
        <a href="https://virdanurlulu.github.io/" target="_blank" rel="noopener noreferrer" aria-label="Visit homepage">
          <img id="itbLogo" class="brand-logo" alt="Logo ITB" width="96" height="96">
        </a>
        <div class="brand-text">
          <h1 data-lang-key="app_title">Simulation and Modeling of Explosion Effects Based on TNT Equivalence <span class="nowrap">using Javascript</span></h1>
          <h3>
            <span class="sub-line1" data-lang-key="app_subtitle1">Chemical Engineering, </span>
            <span class="sub-line2" data-lang-key="app_subtitle2">Bandung Institute of Technology</span>
          </h3>
          <h3 class="authors">Virda Nur Lu’lu, S.T., IPP<br>Dr. Eng. Ir. Pramujo Widiatmoko, S.T., M.T.<br>Ir. Hary Devianto, S.T., M.Eng., Ph.D., IPM, AER.*</h3>
        </div>
      </div>

      <div class="dropdown-menu">
        <button class="dropdown-toggle"><span data-lang-key="menu_button">Menu</span><span class="hamburger-icon">&#9776;</span></button>
        <div class="dropdown-content">
          <a href="/" data-lang-key="menu_home">Home</a>
          <a href="/html/simulation-modeling-visualisation-explosion.html" data-lang-key="menu_app">Simulation & Modeling Application</a>
          <a href="/html/flowprocess-simulation.html" data-lang-key="menu_guide">Workflow Process of Simulation</a>
          <a href="/html/presentation-slide.html" data-lang-key="menu_presentation">Presentation</a>
          <a href="#" data-lang-key="menu_journal">Journal & Conference (coming soon)</a>
          <a href="/html/bibliography_sim_modeling_explosion.html" data-lang-key="menu_bibliography">Bibliography</a>
        </div>
      </div>
      
      <div id="language-switcher">
          <button class="lang-btn" data-lang="en" aria-label="Switch to English">
              <img src="https://virdanurlulu.github.io/img/EN.svg" alt="Switch to English" />
          </button>
          <button class="lang-btn" data-lang="id" aria-label="Ganti ke Bahasa Indonesia">
              <img src="https://virdanurlulu.github.io/img/ID.svg" alt="Ganti ke Bahasa Indonesia" />
          </button>
      </div>

    </div>

    <main class="split" role="main">
      <div class="left">
        <section class="card" id="materialCard" aria-labelledby="mat-head">
          <div id="mat-head" class="card-header" data-lang-key="card_title_material">Chemical Material</div>
          <div style="padding:14px">
            <div class="chem-grid">
              <div class="matcol">
                <div>
                  <label for="material" class="label" data-lang-key="label_select_material">Select Material</label>
                  <select id="material">
                    <option value="" data-lang-key="select_option_default">— Select —</option>
                    <option value="AN" data-lang-key="select_option_an">Ammonium Nitrate (AN)</option>
                    <option value="LPG" data-lang-key="select_option_lpg">Propane (LPG)</option>
                    <option value="H2" data-lang-key="select_option_h2">Hydrogen (H₂)</option>
                  </select>
                </div>
                <div class="mini">
                  <div>
                    <label for="vol" class="label" data-lang-key="label_volume">Volume (m³)</label>
                    <input id="vol" type="number" min="0" step="any" placeholder="e.g., 12.5" aria-label="Volume" />
                  </div>
                  <div>
                    <label for="dist" class="label" data-lang-key="label_distance">Distance (m)</label>
                    <input id="dist" type="number" min="0" step="any" placeholder="e.g., 150" aria-label="Distance" />
                  </div>
                </div>
              </div>
              <div class="eq-panel">
                <div class="eq-title" data-lang-key="eq_panel_title">Representative Overall Reaction</div>
                <div id="eq-text" class="eq-body" data-lang-key="eq_panel_placeholder">Select a material to display the reaction equation.</div>
              </div>
            </div>
          </div>
        </section>

        <section class="card" aria-labelledby="prop-head">
          <div id="prop-head" class="card-header" data-lang-key="card_title_properties">Properties</div>
          <div style="padding:12px">
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-lang-key="table_header_properties">Properties</th>
                    <th data-lang-key="table_header_value">Value</th>
                    <th data-lang-key="table_header_unit">Unit</th>
                    <th data-lang-key="table_header_literature">Literature</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td data-label="Properties"><label for="rho">Density ρ = m/V</label></td><td data-label="Value"><input id="rho" type="number" min="0" step="any"/></td><td data-label="Unit" class="unit">kg/m³</td><td data-label="Source" class="ref">@Literature</td></tr>
                  <tr><td data-label="Properties"><label for="dh">ΔH<sub>explosion</sub></label></td><td data-label="Value"><input id="dh" type="number" step="any"/></td><td data-label="Unit" class="unit">kJ/kg</td><td data-label="Source" class="ref">@Literature</td></tr>
                  <tr><td data-label="Properties"><label for="pa" data-lang-key="label_ambient_pressure">Ambient Pressure</label></td><td data-label="Value"><input id="pa" type="number" min="0" step="any"/></td><td data-label="Unit" class="unit">kPa</td><td data-label="Source" class="ref">@Literature</td></tr>
                  <tr><td data-label="Properties"><label for="eta" data-lang-key="label_explosion_efficiency">η<sub>E</sub> Explosion Efficiency</label></td><td data-label="Value"><input id="eta" type="number" min="0" max="1" step="any"/></td><td data-label="Unit" class="unit">–</td><td data-label="Source" class="ref">@Literature</td></tr>
                  <tr><td data-label="Properties"><label for="e_tnt">E<sub>TNT</sub></label></td><td data-label="Value"><input id="e_tnt" type="number" min="0" step="any"/></td><td data-label="Unit" class="unit">kJ/kg</td><td data-label="Source" class="ref">@Literature</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="card" aria-labelledby="param-head">
          <div id="param-head" class="card-header">
            <span data-lang-key="card_title_parameters">Parameters</span>
            <button class="btn" id="btnAddResult" data-lang-key="btn_add_result" disabled>Add to Log & Map</button>
          </div>
          <div style="padding:12px">
            <div class="table-wrapper">
              <table>
                <thead><tr>
                  <th data-lang-key="table_header_parameters">Parameters</th>
                  <th data-lang-key="table_header_value">Value</th>
                  <th data-lang-key="table_header_unit">Unit</th>
                  <th data-lang-key="table_header_sources">Sources</th>
                </tr></thead>
                <tbody>
                  <tr><td data-label="Parameters" data-lang-key="param_mass_material">(W) Mass Material</td><td data-label="Value"><input id="W_mass" type="text" readonly /></td><td data-label="Unit" class="unit">kg</td><td data-label="Source" class="ref" data-lang-key="source_calculated">@Calculated</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_total_energy">(E) Total Energy</td><td data-label="Value"><input id="E_total" type="text" readonly /></td><td data-label="Unit" class="unit">kJ</td><td data-label="Source" class="ref" data-lang-key="source_calculated">@Calculated</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_tnt_equivalent">(W) TNT Equivalent</td><td data-label="Value"><input id="W_tnt" type="text" readonly /></td><td data-label="Unit" class="unit">kg</td><td data-label="Source" class="ref" data-lang-key="source_calculated">@Calculated</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_scaled_distance">(Ze) Scaled Distance</td><td data-label="Value"><input id="Ze" type="text" readonly /></td><td data-label="Unit" class="unit">m·kg<sup>−1/3</sup></td><td data-label="Source" class="ref" data-lang-key="source_calculated">@Calculated</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_scaled_overpressure">(Ps) Scaled Overpressure</td><td data-label="Value"><input id="Ps" type="text" readonly /></td><td data-label="Unit" class="unit">–</td><td data-label="Source" class="ref" data-lang-key="source_crowl_kinney">@Crowl/Kinney</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_peak_overpressure">(Po) Peak side-on overpressure</td><td data-label="Value"><input id="Po_crowl" type="text" readonly /></td><td data-label="Unit" class="unit">kPa</td><td data-label="Source" class="ref" data-lang-key="source_crowl">@Crowl</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_peak_overpressure">(Po) Peak side-on overpressure</td><td data-label="Value"><input id="Po_alonso" type="text" readonly /></td><td data-label="Unit" class="unit">kPa</td><td data-label="Source" class="ref" data-lang-key="source_alonso">@Alonso</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_peak_overpressure">(Po) Peak side-on overpressure</td><td data-label="Value"><input id="Po_sadovski" type="text" readonly /></td><td data-label="Unit" class="unit">kPa</td><td data-label="Source" class="ref" data-lang-key="source_sadovski">@Sadovski</td></tr>
                </tbody>
              </table>
            </div>
            <div id="msg" class="status" role="status" aria-live="polite"></div>
          </div>
        </section>

        <section class="card" aria-labelledby="chart-head">
          <div id="chart-head" class="card-header">
            <span data-lang-key="chart_title_ps_vs_ze">Scaled Overpressure vs Scaled Distance</span>
            <button class="btn" id="btnExport" data-lang-key="btn_export_png">Export PNG</button>
          </div>
          <div class="chart-container">
            <div id="chart" role="img" aria-label="Log-log plot of Ps (Po/Pa) versus ze based on Kinney &amp; Graham (1985)."></div>
            <noscript><p data-lang-key="chart_noscript">Please enable JavaScript to display the chart. Reference: G. F. Kinney & K. J. Graham (1985).</p></noscript>
            <div class="chart-note" data-lang-key="chart_note_source">Source: G. F. Kinney & K. J. Graham, <em>Explosive Shocks in Air</em>, Springer-Verlag, 1985.</div>
          </div>
        </section>
        
        <section class="card" aria-labelledby="overpressure-chart-head">
          <div id="overpressure-chart-head" class="card-header">
            <span data-lang-key="chart_title_po_vs_dist">Overpressure vs Distance</span>
          </div>
          <div class="chart-container">
            <canvas id="overpressureChart"></canvas>
            <div id="overpressureChartMsg" class="chart-note" style="display: none; padding: 20px; font-size: 14px;"></div>
            <noscript><p data-lang-key="chart_noscript_generic">Please enable JavaScript to display the chart.</p></noscript>
          </div>
        </section>
        
        <section class="card" aria-labelledby="contour-map-head">
          <div id="contour-map-head" class="card-header">
            <span data-lang-key="contour_map_title">Explosion Contour Map</span>
          </div>
          <div style="padding: 14px;">
            <div id="contourMapContainer">
              <div class="fs-host" id="mapCard">
                <div id="mapTitle" class="map-title">Explosion Contour</div>
                <button id="fsBtn" class="fs-btn" aria-pressed="false" title="Fullscreen (F)">⛶ Fullscreen</button>
                <button id="fsBtnMobile" class="fs-btn fs-btn-mobile" aria-pressed="false" title="Fullscreen">⛶ Fullscreen</button>
                <div id="map" role="region" aria-label="Explosion contour map"></div>
                <div class="legend" id="legend" hidden></div>
                <div id="notification" class="notification"></div>
              </div>
            </div>
            <div id="mapControls">
              <div class="coord-inputs">
                  <label for="mapLat">Lat</label>
                  <input type="number" id="mapLat" step="any" aria-label="Latitude">
                  <label for="mapLon">Lon</label>
                  <input type="number" id="mapLon" step="any" aria-label="Longitude">
              </div>
              <div class="model-select">
                  <label for="poModelSelect">Select Po</label>
                  <select id="poModelSelect">
                      <option value="crowl">Crowl</option>
                      <option value="alonso">Alonso</option>
                      <option value="sadovski">Sadovski</option>
                  </select>
              </div>
            </div>
          </div>
        </section>

      </div>

      <aside class="right">
        <section class="card estimation" aria-labelledby="est-damage">
          <div id="est-damage" class="card-header" data-lang-key="estimation_damage_title">Estimation of Damage to Structures and Process Equipment</div>
          <div class="method-grid">
            <div class="method-card" id="panel-damage-crowl">
              <div class="vlabel">CROWL</div>
              <div class="pad">
                <p><strong>Overpressure (Po):</strong> <span id="val-Po-crowl">—</span> kPa</p>
                <div>
                  <strong data-lang-key="damage_details_label">Damage Details:</strong>
                  <div class="damage-category">
                    <strong data-lang-key="structural_label">Structural:</strong>
                    <ul id="structural-damage-crowl"></ul>
                  </div>
                  <div class="damage-category">
                    <strong data-lang-key="process_equipment_label">Process Equipment:</strong>
                    <ul id="equipment-damage-crowl"></ul>
                  </div>
                </div>
              </div>
              <div class="sevfoot" id="sev-crowl" data-lang-key="unknown">Unknown</div>
            </div>
            <div class="method-card" id="panel-damage-alonso">
              <div class="vlabel">ALONSO</div>
              <div class="pad">
                <p><strong>Overpressure (Po):</strong> <span id="val-Po-alonso">—</span> kPa</p>
                  <div>
                  <strong data-lang-key="damage_details_label">Damage Details:</strong>
                  <div class="damage-category">
                    <strong data-lang-key="structural_label">Structural:</strong>
                    <ul id="structural-damage-alonso"></ul>
                  </div>
                  <div class="damage-category">
                    <strong data-lang-key="process_equipment_label">Process Equipment:</strong>
                    <ul id="equipment-damage-alonso"></ul>
                  </div>
                </div>
              </div>
              <div class="sevfoot" id="sev-alonso" data-lang-key="unknown">Unknown</div>
            </div>
            <div class="method-card" id="panel-damage-sadovski">
              <div class="vlabel">SADOVSKI</div>
              <div class="pad">
                <p><strong>Overpressure (Po):</strong> <span id="val-Po-sadovski">—</span> kPa</p>
                  <div>
                  <strong data-lang-key="damage_details_label">Damage Details:</strong>
                  <div class="damage-category">
                    <strong data-lang-key="structural_label">Structural:</strong>
                    <ul id="structural-damage-sadovski"></ul>
                  </div>
                  <div class="damage-category">
                    <strong data-lang-key="process_equipment_label">Process Equipment:</strong>
                    <ul id="equipment-damage-sadovski"></ul>
                  </div>
                </div>
              </div>
              <div class="sevfoot" id="sev-sadovski" data-lang-key="unknown">Unknown</div>
            </div>
          </div>
        </section>
        <section class="card estimation" aria-labelledby="est-injury">
          <div id="est-injury" class="card-header" data-lang-key="estimation_injury_title">Estimation of Injury Consequences</div>
          <div class="method-grid">
            <div class="method-card" id="panel-injury-crowl"><div class="vlabel">CROWL</div><div class="pad"><p><strong>Overpressure (Po):</strong> <span id="val-Po-crowl-inj">—</span> kPa</p><p><strong data-lang-key="effects_label">Effects:</strong></p><ul id="injury-effects-crowl"></ul></div><div class="sevfoot" id="sev-injury-crowl" data-lang-key="unknown">Unknown</div></div>
            <div class="method-card" id="panel-injury-alonso"><div class="vlabel">ALONSO</div><div class="pad"><p><strong>Overpressure (Po):</strong> <span id="val-Po-alonso-inj">—</span> kPa</p><p><strong data-lang-key="effects_label">Effects:</strong></p><ul id="injury-effects-alonso"></ul></div><div class="sevfoot" id="sev-injury-alonso" data-lang-key="unknown">Unknown</div></div>
            <div class="method-card" id="panel-injury-sadovski"><div class="vlabel">SADOVSKI</div><div class="pad"><p><strong>Overpressure (Po):</strong> <span id="val-Po-sadovski-inj">—</span> kPa</p><p><strong data-lang-key="effects_label">Effects:</strong></p><ul id="injury-effects-sadovski"></ul></div><div class="sevfoot" id="sev-injury-sadovski" data-lang-key="unknown">Unknown</div></div>
          </div>
        </section>
        <section class="card" aria-labelledby="log-head">
            <div id="log-head" class="card-header">
                <span data-lang-key="log_title">Simulation Log</span>
                <div class="log-actions">
                    <select id="simulationSelector" aria-label="Pilih Skenario Simulasi"></select>
                    <button class="btn" id="btnSortLog" data-lang-key="btn_sort">Sort</button>
                    <button class="btn" id="btnExportLog" data-lang-key="btn_export_csv">Export CSV</button>
                    <button class="btn" id="btnImportLog" data-lang-key="btn_import_csv">Import CSV</button>
                    <input type="file" id="importFile" accept=".csv" style="display: none;" />
                </div>
            </div>
            <div class="table-wrapper">
                <table id="logTable">
                    <thead>
                        <tr>
                            <th data-lang-key="log_col_node">Node</th>
                            <th data-lang-key="log_col_material">Material</th>
                            <th>ηE</th>
                            <th>ETNT</th>
                            <th>ρ</th>
                            <th>ΔH<sub>exp</sub></th>
                            <th data-lang-key="log_col_volume">Volume</th>
                            <th data-lang-key="log_col_distance">Distance</th>
                            <th>WTNT</th>
                            <th>ze</th>
                            <th>Ps</th>
                            <th>Crowl</th>
                            <th>Alonso</th>
                            <th>Sadovski</th>
                            <th>Lat</th>
                            <th>Lon</th>
                            <th>Po Model</th>
                            <th class="col-action">-</th>
                        </tr>
                        <tr class="unit-row">
                           <th></th><th></th><th></th><th>(kJ/kg)</th><th>(kg/m³)</th><th>(kJ/kg)</th><th>(m³)</th><th>(m)</th><th>(kg)</th><th>(m·kg<sup>−1/3</sup>)</th><th></th><th>(kPa)</th><th>(kPa)</th><th>(kPa)</th><th>° N</th><th>° E</th><th>Po</th><th></th>
                        </tr>
                    </thead>
                    <tbody id="logTbody"></tbody>
                </table>
            </div>
            <div style="padding: 0 14px 14px;">
                <p class="footnote" data-lang-key="log_footnote">Click "Save" to log the calculation results. The last 10 entries will be stored in your browser.</p>
            </div>
        </section>
      </aside>
    </main>
  </div>
    
  <div id="floatingControlPanel">
      <div class="floating-panel-header">
        <h3 data-lang-key="quick_control_panel">Quick Control Panel</h3>
        <div class="panel-header-buttons">
          <button id="floatPanelCollapseBtn" class="floating-panel-action-btn" aria-label="Collapse/Expand Panel">▲</button>
        </div>
      </div>
      <div class="floating-panel-body">
        <div id="floatPanelInputs">
        </div>
        <div id="floatPanelOutputs">
        </div>
      </div>
  </div>

  <footer class="app-footer">
      <div class="footer-content">
        <div class="footer-buttons">
          <a class="btn-home-3d" href="/" target="_blank" rel="noopener noreferrer" data-lang-key="menu_home">Home</a>
          <a class="btn-home-3d" href="#" data-lang-key="footer_guide">Guide</a>
          <a class="btn-home-3d" href="#" data-lang-key="menu_presentation">Presentation</a>
          <a class="btn-home-3d" href="#" data-lang-key="footer_journal">Journal</a>
          <a class="btn-home-3d" href="https://id.linkedin.com/in/virdanurlulu" data-lang-key="footer_profile">Profile</a>
        </div>
        <div class="credit">
          <span data-lang-key="footer_copyright">Copyright © 2025 by</span>
          <a href="https://id.linkedin.com/in/virdanurlulu" target="_blank" rel="nofollow noopener noreferrer" style="text-decoration: none;">Virda Nur Lu'lu</a>
        </div>
        <div class="dedication">
          <span data-lang-key="footer_dedication1">This application is dedicated to my parents for their persistent support and patient guidance throughout my JavaScript journey.</span>
          <span data-lang-key="footer_dedication2">It is also presented to the academic community at</span>
          <a href="https://che.itb.ac.id/" target="_blank" rel="nofollow noopener noreferrer" data-lang-key="footer_dedication_itb">Bandung Institute of Technology</a>
          <span data-lang-key="footer_dedication3">as a contribution towards inspiring further advancements in JavaScript technology.</span>
        </div>
      </div>
  </footer>

  <button class="btn" id="toTop" type="button" aria-label="Back to Top">&#8679;</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  
  <script>
    let simulationLog = []; // Make simulationLog globally accessible for better module interaction
    let updatePsVsZeChart = () => {}; // Define a placeholder function in a shared scope

    // Global utility functions
    function debounce(func, delay = 250) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => { func.apply(this, args); }, delay);
      };
    }

    function parseNumberLoose(s){
      if (s==null) return NaN;
      s = String(s).trim().replace(/\s+/g,'').replace(/\u00A0/g,'');
      if (/^\d{1,3}(\.\d{3})+,\d+$/.test(s)) s = s.replace(/\./g,'').replace(',', '.');
      else if (/^\d+,\d+$/.test(s)) s = s.replace(',', '.');
      else s = s.replace(/(?<=\d),(?=\d{3}(?:\D|$))/g, '');
      return Number(s);
    }

    function extractNumbers(line){
      const toks = String(line).match(/-?\d+(?:[.,]\d+)?/g) || [];
      return toks.map(parseNumberLoose).filter(n=>Number.isFinite(n));
    }
    
    function parseData(text){
      const out = [];
      const rows = (text||'').split(/[\r\n]+/).map(r=>r.trim()).filter(Boolean);
      for (const r of rows){
        const nums = extractNumbers(r);
        if (!nums.length) continue;
        const rVal = nums[0];
        const poVal = nums.length>1 ? nums[1] : null;
        if (rVal > 0) out.push({ r: rVal, Po: (poVal!=null && Number.isFinite(poVal)) ? poVal : null });
      }
      out.sort((a,b)=>a.r-b.r);
      return out;
    }


    document.addEventListener("DOMContentLoaded", () => {
      const $ = (id) => document.getElementById(id);
      const fields = ["rho", "vol", "dh", "eta", "e_tnt", "dist", "pa"];
      const inputFields = ["material", ...fields];

      let isPageLoaded = false; // Flag to prevent premature execution

      const presets = {
        AN:  { rho: 1725,    dh:  2479,  e_tnt: 4500, eta: 0.35 },
        LPG: { rho: 493,     dh: 46000,  e_tnt: 4550, eta: 0.03 },
        H2:  { rho: 0.08375, dh: 130800, e_tnt: 4500, eta: 0.05 }
      };

      const eqMap = {
        AN:  [{ labelKey: "eq_label_detonation", eq: '2 NH<sub>4</sub>NO<sub>3</sub>(s) <span class="arrow">→</span> 2 N<sub>2</sub>(g) + O<sub>2</sub>(g) + 4 H<sub>2</sub>O(g)' }],
        LPG: [{ labelKey: "eq_label_combustion_propane", eq: 'C<sub>3</sub>H<sub>8</sub>(g) + 5 O<sub>2</sub>(g) <span class="arrow">→</span> 3 CO<sub>2</sub>(g) + 4 H<sub>2</sub>O(g)' }],
        H2:  [{ labelKey: "eq_label_combustion_explosion", eq: '2 H<sub>2</sub>(g) + O<sub>2</sub>(g) <span class="arrow">→</span> 2 H<sub>2</sub>O(g)' }]
      };
     
      const materialAbbreviationMap = {
        'Ammonium Nitrate (AN)': 'AN',
        'Propane (LPG)': 'LPG',
        'Hydrogen (H₂)': 'H₂',
        'Amonium Nitrat (AN)': 'AN',
        'Propana (LPG)': 'LPG',
        'Hidrogen (H₂)': 'H₂'
      };
     
      const citations = {
        1: "Wang et al., 2023",
        2: "Clancey, 1972; Crowl & Louvar, 2011",
        3: "Clancey, 1972; CCPS, 2000",
        4: "Jeremić & Bajić., 2006"
      };

      /*
      ================================================================================
      | START: BILINGUAL TRANSLATION SCRIPT                                          |
      ================================================================================
      */
      const translations = {
        en: {
          // Page Titles
          page_title: "Simulation & Modeling of Explosion Effects (TNT Equivalence)",
          app_title: "Simulation and Modeling of Explosion Effects Based on TNT Equivalence",
          app_subtitle1: "Chemical Engineering, ",
          app_subtitle2: "Bandung Institute of Technology",

          // Menu
          menu_button: "Menu",
          menu_home: "Home",
          menu_app: "Simulation & Modeling Application",
          menu_guide: "Workflow Process of Simulation",
          menu_presentation: "Presentation",
          menu_journal: "Journal & Conference (coming soon)",
          menu_bibliography: "Bibliography",
         
          // Card Titles
          card_title_material: "Chemical Material",
          card_title_properties: "Properties",
          card_title_parameters: "Parameters",
          estimation_damage_title: "Estimation of Damage to Structures and Process Equipment",
          estimation_injury_title: "Estimation of Injury Consequences",
          log_title: "Simulation Log",

          // Labels and Inputs
          label_select_material: "Select Material",
          label_volume: "Volume (m³)",
          label_distance: "Distance (m)",
          select_option_default: "— Select —",
          select_option_an: "Ammonium Nitrate (AN)",
          select_option_lpg: "Propane (LPG)",
          select_option_h2: "Hydrogen (H₂)",
          label_ambient_pressure: "Ambient Pressure",
          label_explosion_efficiency: "ηE Explosion Efficiency",
         
          // Parameters Table
          table_header_properties: "Properties",
          table_header_value: "Value",
          table_header_unit: "Unit",
          table_header_literature: "Literature",
          table_header_parameters: "Parameters",
          table_header_sources: "Sources",
          param_mass_material: "(W) Mass Material",
          param_total_energy: "(E) Total Energy",
          param_tnt_equivalent: "(W) TNT Equivalent",
          param_scaled_distance: "(Ze) Scaled Distance",
          param_scaled_overpressure: "(Ps) Scaled Overpressure",
          param_peak_overpressure: "(Po) Peak side-on overpressure",
          source_calculated: "@Calculated",
          source_crowl_kinney: "@Crowl/Kinney",
          source_crowl: "@Crowl",
          source_alonso: "@Alonso",
          source_sadovski: "@Sadovski",

          // Equation Panel
          eq_panel_title: "Representative Overall Reaction",
          eq_panel_placeholder: "Select a material to display the reaction equation.",
          eq_label_detonation: "Detonation",
          eq_label_combustion_propane: "Combustion (propane)",
          eq_label_combustion_explosion: "Combustion/explosion",
         
          // Charts
          chart_title_ps_vs_ze: "Scaled Overpressure vs Scaled Distance",
          btn_export_png: "Export PNG",
          chart_noscript: "Please enable JavaScript to display the chart. Reference: G. F. Kinney & K. J. Graham (1985).",
          chart_noscript_generic: "Please enable JavaScript to display the chart.",
          chart_note_source: "Source: G. F. Kinney & K. J. Graham, Explosive Shocks in Air, Springer-Verlag, 1985.",
          chart_title_po_vs_dist: "Overpressure vs Distance",
          chart_tooltip_compound: "Point",
          chart_tooltip_ref_curve: "Reference Curve",
          chart_x_axis_label: "Scaled Distance (ze)",
          chart_y_axis_label: "Scaled Overpressure Ratio (Ps = Po/Pa, –)",
          chart_x_axis_label_mobile: "ze (m·kg−1/3)",
          chart_y_axis_label_mobile: "Ps",
          chart_title_main: "Scaled Overpressure vs Scaled Distance",
          chart_subtitle_main: "Reference Model: Kinney & Graham (1985)",
          chart_title_mobile: "Ps vs ze",
          chart_subtitle_mobile: "Crowl (2011), Kinney & Graham (1985)",
          overpressure_chart_x_axis_label: "Distance [m]",
          overpressure_chart_y_axis_label: "Overpressure [kPa]",

          // Estimation Panels
          damage_details_label: "Damage Details:",
          structural_label: "Structural:",
          process_equipment_label: "Process Equipment:",
          awaiting_input: "Awaiting input...",
          effects_label: "Effects:",
          unknown: "Unknown",
          primary_effects_label: "Primary Effects:",
          secondary_tertiary_effects_label: "Secondary/Tertiary Effects:",
          conclusion_label: "Conclusion:",
         
          // Log
          btn_sort: "Sort",
          btn_export_csv: "Export CSV",
          btn_import_csv: "Import CSV",
          log_col_node: "Node",
          log_col_material: "Material",
          log_col_volume: "Volume",
          log_col_distance: "Distance",
          log_footnote: "Click \"Save\" to log the calculation results. The last 10 entries will be stored in your browser.",
          log_placeholder: "No simulation data are available.",

          // Footer
          footer_guide: "Guide",
          footer_journal: "Journal",
          footer_profile: "Profile",
          footer_copyright: "Copyright © 2025 by",
          footer_dedication1: "This application is dedicated to my parents for their persistent support and patient guidance throughout my JavaScript journey. ",
          footer_dedication2: "It is also presented to the academic community at ",
          footer_dedication_itb: "Bandung Institute of Technology",
          footer_dedication3: " as a contribution towards inspiring further advancements in JavaScript technology.",

          // Quick Control Panel
          quick_control_panel: "Quick Control Panel",
          btn_save: "Save",
          btn_add_result: "Add to Log & Map",
          float_overpressure_label: "Overpressure (Po)",
         
          // Status Messages
          status_success: "The calculation has been completed successfully.",
          status_error_range: "Ensure that the property is entered within the appropriate range.",
          status_error_invalid_ze: "The calculation outcome is invalid (Ze is non-positive).",
          status_loaded_defaults: "Default values have been loaded.",
          status_log_empty_export: "No log data are available for export.",
          status_import_success: "Log data from CSV file imported successfully!",
          status_import_error: "The file could not be imported: ",
          status_import_error_empty: "CSV file is invalid or empty.",
          status_import_error_missing_cols: "Required columns are missing: ",
          status_import_error_no_data: "No valid data could be retrieved from the CSV file.",
          status_log_saved: "Log entry saved successfully to browser storage.",
          status_export_success: "Export Successful.",

          // Damage & Injury Categories and Descriptions (as keys)
          cat_catastrophic: "Catastrophic",
          cat_major: "Major",
          cat_severe: "Severe",
          cat_serious: "Serious",
          cat_moderate: "Moderate",
          cat_minor: "Minor",
          cat_insignificant: "Insignificant",
          cat_no_effect: "No Effect",
         
          injury_cat_invalid: "Invalid Input",
          injury_cat_no_effect: "No Effect Reported",
          injury_cat_minor: "Minor Injury",
          injury_cat_moderate: "Moderate Injury",
          injury_cat_serious: "Serious Injury",
          injury_cat_severe: "Severe Injury",
          injury_cat_fatality: "Fatality",

          injury_awaiting_input: "Awaiting input...",
          injury_no_serious: "No serious injuries; eardrum damage is insignificant.",
          injury_glass_fragments: "Glass begins to break at 3–5 kPa, where fragments can cause skin/eye injuries.",
          injury_unlikely_primary: "Primary injuries are unlikely, but a risk of secondary injuries from glass fragments persists.",
          injury_minor_contusions: "Minor contusions.",
          injury_moderate_damage: "Moderate structural damage may cause ceiling collapse and falling of small objects.",
          injury_combo_minor: "A combination of minor contusions and secondary injuries from fragments/debris.",
          injury_eardrum_rupture: "Eardrum rupture, moderate contusions.",
          injury_flying_debris: "More extensive structural damage creates flying debris, which may cause bone fractures.",
          injury_increased_severity: "Injury severity is increased due to the combined effects of the blast wave and flying debris.",
          injury_serious_internal: "Serious and potentially fatal internal contusions.",
          injury_entrapment: "Most buildings are likely to be completely destroyed, creating entrapment scenarios under the rubble.",
          injury_highly_fatal: "The combination of internal injuries and entrapment is potentially highly fatal.",
          injury_high_mortality: "Extremely high mortality rate for unprotected individuals; 90%–100% fatality.",
          injury_total_collapse: "Total building collapse; large debris moving at high velocity.",
          injury_extreme_fatality_risk: "The interaction between the blast wave and structural failure poses an extremely high risk of fatality.",
          injury_no_significant_effects: "No significant effects reported.",
          injury_none_anticipated: "No injuries are anticipated.",
                    // == MULAI TAMBAHKAN DARI SINI ==
          injury_table_p1: "No serious injuries; eardrum rupture is not significant.",
          injury_table_s1: "Glass cracking can begin around 1–1.5 kPa [4]; widespread breakage typically 3.5–7.6 kPa [4].",
          injury_table_c1: "Primary injury is unlikely, but secondary injury risk from glass fragments remains.",
          injury_table_p2: "Minor contusion [1]; 1% eardrum rupture (20–30 kPa) [4].",
          injury_table_s2: "Moderate structure damage may cause ceiling sections to fall and small objects to drop [2].",
          injury_table_c2: "Combination of minor contusion and secondary injuries from fragments/debris.",
          injury_table_p3: "Moderate contusion [1]; eardrum rupture probability 50% around 110 kPa [4].",
          injury_table_s3: "Wider structural damage creates flying debris [2], which can cause fractures.",
          injury_table_c3: "Injury severity rises due to the combined effects of the blast wave and flying debris.",
          injury_table_p4: "Serious internal contusions and possibly fatal [1]; risk of blast-lung depends on positive-phase duration with overpressure 70 kPa at 50 ms or 140–200 kPa at 3 ms [4].",
          injury_table_s4: "Many buildings heavily damaged; some may be totally destroyed [2], creating entrapment under rubble.",
          injury_table_c4: "Concurrence of internal injuries and entrapment is potentially fatal.",
          injury_table_p5: "High fatality for unprotected persons, but thresholds depend on positive-phase duration: 1% fatality 190 kPa at 50 ms or 400–500 kPa at 3 ms [4].",
          injury_table_s5: "Total building collapse; large debris moving rapidly [2].",
          injury_table_c5: "Fatality risk escalates where both overpressure and duration exceed thresholds.",
          // == AKHIR BAGIAN TAMBAHAN ==
         
          damage_no_significant: "No significant structural damage predicted.",
          equipment_no_significant: "No significant equipment damage predicted.",
          alonso_warning: "Warning: Result is extrapolated beyond the valid Alonso model range (1 ≤ ze ≤ 200).",
          sadovski_warning: "Warning: Result is extrapolated beyond the valid Sadovski model range (1 ≤ ze ≤ 15).",
          crowl_warning: "Warning: Result is extrapolated beyond the valid Crowl model range (0.01 ≤ Ze ≤ 100).",
         
          damage_accidental_glass: "Accidental glass damage [1].",
          damage_minor_glass_architectural: "Minor glass breakage and light architectural damage such as displacement of roof tiles and falling plaster [1].",
          damage_widespread_glass_nonstructural: "Widespread glass shattering and significant damage to non-structural elements like doors, windows, and roofs [1].",
          damage_collapse_unreinforced_walls: "Collapse of unreinforced concrete walls or cement blocks [2].",
          damage_steel_panels_destroyed_tanks_ruptured_1: "Frame-less steel panels destroyed; oil storage tanks ruptured (20.7 kPa - ≤25 kPa) [2].",
          damage_steel_panels_destroyed_tanks_ruptured_2: "Frame-less steel panels destroyed; oil storage tanks ruptured (25 kPa - 27.6 kPa) [2].",
          damage_extensive_nonstructural: "Extensive damage to non-structural elements such as brick facades, roofs, and ceilings [1].",
          damage_total_destruction_houses_1: "Near-total destruction of residential houses (34.5 kPa - ≤40 kPa) [2].",
          damage_total_destruction_houses_2: "Near-total destruction of residential houses (40 kPa - 48.2 kPa) [2].",
          damage_heavy_nonstructural_ceiling_collapse: "Heavy damage to non-structural elements leading to ceiling collapse [1].",
          damage_brick_panels_fail_1: "8-12 inch thick unreinforced brick panels fail from shear or bending (48.2 kPa - ≤55 kPa) [2].",
          damage_brick_panels_fail_2: "8-12 inch thick unreinforced brick panels fail from shear or bending (55 kPa - 55.1 kPa) [2].",
          damage_partial_collapse_concrete_columns: "Partial collapse of non-structural elements and significant damage to concrete columns [1].",
          damage_total_collapse_all_elements: "Near-total collapse of all building elements, including heavy damage to load-bearing concrete columns [1].",

          desc_annoying_noise: "Annoying noise (137 dB if low frequency, 10–15 Hz)",
          desc_breakage_large_windows: "Breakage of large windows previously under stress",
          desc_loud_noise_glass_failure: "Loud noise (143 dB), sonic boom, glass failure",
          desc_small_windows_break: "Small windows break due to pressure",
          desc_typical_pressure_break_glass: "Typical pressure to break glass",
          desc_safe_distance: '"Safe distance," 95% probability of no serious damage below this level, projectile limit, minor ceiling damage, 10% window breakage',
          desc_limited_minor_structural_damage: "Limited minor structural damage",
          desc_minor_structural_damage_houses: "Minor structural damage to houses",
          desc_partial_house_collapse: "Partial house collapse, uninhabitable",
          desc_slight_distortion_steel_frames: "Slight distortion of coated steel frames",
          desc_partial_collapse_roof_walls: "Partial collapse of roof and walls",
          desc_lower_limit_serious_damage: "Lower limit of serious structural damage",
          desc_50_percent_brick_walls_collapse: "50% of brick walls collapse",
          desc_heavy_machinery_damaged: "Heavy machinery (3,000 lb) slightly damaged in industrial buildings; steel frames distorted or detached from foundation",
          desc_light_industrial_structures_collapse: "Light industrial structures collapse",
          desc_utility_poles_break: "Utility poles break; 40,000 lb hydraulic equipment slightly damaged",
          desc_freight_train_cars_destroyed: "Freight train cars completely destroyed",
          desc_fully_loaded_train_cars_destroyed: "Fully loaded train cars totally destroyed",
          desc_likely_total_damage: "Likely total damage to structures; 7,000 lb equipment displaced and severely damaged; 12,000 lb machinery still present",

          equip_no_damage: "No significant damage recorded",
          equip_control_house_steel_roof_windows_broken: "Control house steel roof. Windows and gauges broken. Cooling tower. Louvers fall off (1.37855 - 2.44738 kPa).",
          equip_switchgear_damaged_tank_roof_collapses: "Control house steel roof. Switchgear is damaged from roof collapse. Control house concrete roof. Windows broken. Tank (cone) roof. Roof collapses.",
          equip_control_house_roof_collapses_instruments_damaged: "Control house steel roof. Roof collapses. Control house concrete roof. Frame deforms. Instruments. Are damaged. Windows and gauges broken.",
          equip_concrete_roof_collapses_fire_heater_cracks: "Control house concrete roof. Roof collapses. Instruments. Are damaged. Windows and gauges broken. Fire heater. Brick cracks. Filter. Debris - missile damage occurs.",
          equip_fire_heater_moves: "Fire heater. Unit moves and pipes break.",
          equip_tank_uplifts_instruments_damaged: "Tank (cone roof). Unit uplifts (half tilted). Instruments. Unit is damaged. Unit moves and pipes break. Controls are damaged. Cooling tower. Frame collapses. Control house steel roof. Block walls fall. Pine supports. Unit moves and pipes break.",
          equip_cooling_tower_collapses: "Cooling tower. Frame collapses. Pine supports. Frame deforms.",
          equip_reactor_moves: "Reactor (chemical). Unit moves and pipes break.",
          equip_filter_inner_parts_damaged: "Filter. Inner parts are damaged. Utilities (gas regulatory). Controls are damaged. Utilities (electronic transformer). Debris - missile damage occurs.",
          equip_fire_heater_overturns: "Fire heater. Unit overturns or is destroyed. Reactor (chemical). Frame deforms. Electric motor. Debris - missile damage occurs. Blower. Unit is on foundation.",
          equip_fractionation_column_cracks: "Fractionation column. Frame cracks.",
          equip_instrument_cubicle_overturns: "Instrument cubicle. Unit overturns or is destroyed. Pine supports. Piping breaks. Frame collapses. Fractionation column. Unit moves and pipes break.",
          equip_tank_uplifts_reactor_destroyed: "Tank (cone roof). Unit uplifts (0.9 tilted). Reactor (chemical). Unit is destroyed. Fractionation column. Unit moves and pipes break. Extraction column. Unit moves and pipes break.",
          equip_reactor_cracking_moves: "Reactor (cracking). Unit moves and pipes break. Fractionation column. Unit overturns or is destroyed.",
          equip_generator_overturns: "Generator. Unit overturns or is destroyed. Utilities (electronic transformer). Unit moves and pipes break. Heat exchanger. Unit moves and pipes break.",
          equip_tank_sphere_moves: "Tank sphere. Unit moves and pipes break.",
          equip_reactor_chemical_overturns: "Reactor (chemical). Unit overturns or is destroyed. Electric motor. Unit moves and pipes break. Extraction column. Unit overturns or is destroyed. Heat exchanger. Unit overturns or is destroyed.",
          equip_filter_uplifts: "Filter. Unit uplifts (0.9 tilted).",
          equip_utilities_overturns: "Utilities (electronic transformer). Unit overturns or is destroyed. Utilities (gas regulatory). Controls are damaged. Case is damaged. Steam turbine. Piping breaks. Case is damaged.",
          equip_filter_overturns: "Filter. Unit overturns or is destroyed. Reactor (cracking). Unit overturns or is destroyed. Steam turbine. Unit overturns or is destroyed. Steam turbine. Controls are damaged.",
          equip_steam_turbine_piping_breaks: "Steam turbine. Piping breaks. Tank sphere. Unit moves and pipes break. Pressure vessel (vertical). Unit overturns or is destroyed.",
          equip_tank_sphere_overturns: "Tank sphere. Unit overturns or is destroyed. Pump. Unit moves on foundation.",
          equip_floating_roof_collapses: "Tank (floating roof). Roof collapses. Reactor (cracking). Unit overturns or is destroyed. Steam turbine. Unit moves on foundation."
        },
        id: {
          // Page Titles
          page_title: "Simulasi & Pemodelan Efek Ledakan (Ekuivalensi TNT)",
          app_title: "Simulasi dan Pemodelan Efek Ledakan Berdasarkan Ekuivalensi TNT",
          app_subtitle1: "Teknik Kimia, ",
          app_subtitle2: "Institut Teknologi Bandung",
         
          // Menu
          menu_button: "Menu",
          menu_home: "Beranda",
          menu_app: "Aplikasi Simulasi & Pemodelan",
          menu_guide: "Proses Alur Kerja Simulasi",
          menu_presentation: "Presentasi",
          menu_journal: "Jurnal & Konferensi (segera hadir)",
          menu_bibliography: "Bibliografi",
         
          // Card Titles
          card_title_material: "Material Kimia",
          card_title_properties: "Properti",
          card_title_parameters: "Parameter",
          estimation_damage_title: "Estimasi Kerusakan pada Struktur dan Peralatan Proses",
          estimation_injury_title: "Estimasi Konsekuensi Cedera",
          log_title: "Log Simulasi",
         
          // Labels and Inputs
          label_select_material: "Pilih Material",
          label_volume: "Volume (m³)",
          label_distance: "Jarak (m)",
          select_option_default: "— Pilih —",
          select_option_an: "Amonium Nitrat (AN)",
          select_option_lpg: "Propana (LPG)",
          select_option_h2: "Hidrogen (H₂)",
          label_ambient_pressure: "Tekanan Sekitar",
          label_explosion_efficiency: "ηE Efisiensi Ledakan",
         
          // Parameters Table
          table_header_properties: "Properti",
          table_header_value: "Nilai",
          table_header_unit: "Satuan",
          table_header_literature: "Literatur",
          table_header_parameters: "Parameter",
          table_header_sources: "Sumber",
          param_mass_material: "(W) Massa Material",
          param_total_energy: "(E) Energi Total",
          param_tnt_equivalent: "(W) Ekuivalen TNT",
          param_scaled_distance: "(Ze) Jarak Skala",
          param_scaled_overpressure: "(Ps) Tekanan Berlebih Skala",
          param_peak_overpressure: "(Po) Puncak tekanan berlebih",
          source_calculated: "@Terhitung",
          source_crowl_kinney: "@Crowl/Kinney",
          source_crowl: "@Crowl",
          source_alonso: "@Alonso",
          source_sadovski: "@Sadovski",

          // Equation Panel
          eq_panel_title: "Reaksi Keseluruhan Representatif",
          eq_panel_placeholder: "Pilih material untuk menampilkan persamaan reaksi.",
          eq_label_detonation: "Detonasi",
          eq_label_combustion_propane: "Pembakaran (propana)",
          eq_label_combustion_explosion: "Pembakaran/ledakan",

          // Charts
          chart_title_ps_vs_ze: "Tekanan Berlebih Skala vs Jarak Skala",
          btn_export_png: "Ekspor PNG",
          chart_noscript: "Harap aktifkan JavaScript untuk menampilkan grafik. Referensi: G. F. Kinney & K. J. Graham (1985).",
          chart_noscript_generic: "Harap aktifkan JavaScript untuk menampilkan grafik.",
          chart_note_source: "Sumber: G. F. Kinney & K. J. Graham, Explosive Shocks in Air, Springer-Verlag, 1985.",
          chart_title_po_vs_dist: "Tekanan Berlebih vs Jarak",
          chart_tooltip_compound: "Titik",
          chart_tooltip_ref_curve: "Kurva Referensi",
          chart_x_axis_label: "Jarak Skala (ze)",
          chart_y_axis_label: "Rasio Tekanan Berlebih Skala (Ps = Po/Pa, –)",
          chart_x_axis_label_mobile: "ze (m·kg−1/3)",
          chart_y_axis_label_mobile: "Ps",
          chart_title_main: "Tekanan Berlebih Skala vs Jarak Skala",
          chart_subtitle_main: "Model Referensi: Kinney & Graham (1985)",
          chart_title_mobile: "Ps vs ze",
          chart_subtitle_mobile: "Crowl (2011), Kinney & Graham (1985)",
          overpressure_chart_x_axis_label: "Jarak [m]",
          overpressure_chart_y_axis_label: "Tekanan Berlebih [kPa]",

          // Estimation Panels
          damage_details_label: "Detail Kerusakan:",
          structural_label: "Struktural:",
          process_equipment_label: "Peralatan Proses:",
          awaiting_input: "Menunggu masukan...",
          effects_label: "Efek:",
          unknown: "Tidak Diketahui",
          primary_effects_label: "Efek Primer:",
          secondary_tertiary_effects_label: "Efek Sekunder/Tersier:",
          conclusion_label: "Kesimpulan:",

          // Log
          btn_sort: "Urutkan",
          btn_export_csv: "Ekspor CSV",
          btn_import_csv: "Impor CSV",
          log_col_node: "Node",
          log_col_material: "Material",
          log_col_volume: "Volume",
          log_col_distance: "Jarak",
          log_footnote: "Klik \"Simpan\" untuk mencatat hasil perhitungan. 10 entri terakhir akan disimpan di browser Anda.",
          log_placeholder: "Data simulasi tidak tersedia.",
         
          // Footer
          footer_guide: "Panduan",
          footer_journal: "Jurnal",
          footer_profile: "Profil",
          footer_copyright: "Hak Cipta © 2025 oleh",
          footer_dedication1: "Aplikasi ini didedikasikan untuk orang tua saya atas dukungan dan bimbingan sabar mereka sepanjang perjalanan JavaScript saya. ",
          footer_dedication2: "Aplikasi ini juga dipersembahkan kepada komunitas akademik di ",
          footer_dedication_itb: "Institut Teknologi Bandung",
          footer_dedication3: " sebagai kontribusi untuk menginspirasi kemajuan lebih lanjut dalam teknologi JavaScript.",
         
          // Quick Control Panel
          quick_control_panel: "Panel Kontrol Cepat",
          btn_save: "Simpan",
          btn_add_result: "Tambahkan ke Log & Peta",
          float_overpressure_label: "Tekanan Berlebih (Po)",
         
          // Status Messages
          status_success: "Perhitungan telah berhasil diselesaikan.",
          status_error_range: "Pastikan properti dimasukkan dalam rentang yang sesuai.",
          status_error_invalid_ze: "Hasil perhitungan tidak valid (Ze tidak positif).",
          status_loaded_defaults: "Nilai default telah dimuat.",
          status_log_empty_export: "Tidak ada data log yang tersedia untuk diekspor.",
          status_import_success: "Data log dari file CSV berhasil diimpor!",
          status_import_error: "File tidak dapat diimpor: ",
          status_import_error_empty: "File CSV tidak valid atau kosong.",
          status_import_error_missing_cols: "Kolom yang diperlukan tidak ada: ",
          status_import_error_no_data: "Tidak ada data valid yang dapat diambil dari file CSV.",
          status_log_saved: "Entri log berhasil disimpan di penyimpanan browser.",
          status_export_success: "Ekspor Berhasil.",
         
          // Damage & Injury Categories and Descriptions (as keys)
          cat_catastrophic: "Kacau Total",
          cat_major: "Mayor",
          cat_severe: "Parah",
          cat_serious: "Serius",
          cat_moderate: "Sedang",
          cat_minor: "Ringan",
          cat_insignificant: "Tidak Berarti",
          cat_no_effect: "Tidak Ada Efek",

          injury_cat_invalid: "Input Tidak Valid",
          injury_cat_no_effect: "Tidak Ada Efek",
          injury_cat_minor: "Cedera Ringan",
          injury_cat_moderate: "Cedera Sedang",
          injury_cat_serious: "Cedera Serius",
          injury_cat_severe: "Cedera Parah",
          injury_cat_fatality: "Kematian",
         
          injury_awaiting_input: "Menunggu masukan...",
          injury_no_serious: "Tidak ada cedera serius; kerusakan gendang telinga tidak signifikan.",
          injury_glass_fragments: "Kaca mulai pecah pada 3–5 kPa, di mana pecahan dapat menyebabkan cedera kulit/mata.",
          injury_unlikely_primary: "Cedera primer tidak mungkin terjadi, tetapi risiko cedera sekunder dari pecahan kaca tetap ada.",
          injury_minor_contusions: "Memar ringan.",
          injury_moderate_damage: "Kerusakan struktur tingkat sedang dapat menyebabkan langit-langit runtuh dan benda-benda kecil jatuh.",
          injury_combo_minor: "Kombinasi memar ringan dan cedera sekunder dari pecahan/puing-puing.",
          injury_eardrum_rupture: "Gendang telinga pecah, memar sedang.",
          injury_flying_debris: "Kerusakan struktural yang lebih luas menciptakan puing-puing beterbangan, yang dapat menyebabkan patah tulang.",
          injury_increased_severity: "Tingkat keparahan cedera meningkat karena efek gabungan dari gelombang ledakan dan puing-puing yang beterbangan.",
          injury_serious_internal: "Memar internal yang serius dan berpotensi fatal.",
          injury_entrapment: "Sebagian besar bangunan kemungkinan besar akan hancur total, menciptakan skenario terperangkap di bawah reruntuhan.",
          injury_highly_fatal: "Gabungan cedera internal dan kondisi terperangkap berpotensi sangat fatal.",
          injury_high_mortality: "Tingkat kematian sangat tinggi bagi orang tanpa pelindung; 90%–100% fatal.",
          injury_total_collapse: "Keruntuhan total bangunan; puing-puing besar bergerak dengan kecepatan tinggi.",
          injury_extreme_fatality_risk: "Interaksi antara gelombang ledakan dan kegagalan struktural menimbulkan risiko kematian yang sangat tinggi.",
          injury_no_significant_effects: "Tidak ada efek signifikan yang dilaporkan.",
          injury_none_anticipated: "Tidak ada cedera yang diperkirakan.",
          // == MULAI TAMBAHKAN DARI SINI ==
          injury_table_p1: "Tidak ada cedera serius; pecahnya gendang telinga tidak signifikan.",
          injury_table_s1: "Kaca bisa mulai retak sekitar 1–1.5 kPa [4]; kerusakan yang lebih luas biasanya terjadi pada 3.5–7.6 kPa [4].",
          injury_table_c1: "Cedera primer tidak mungkin terjadi, namun risiko cedera sekunder dari pecahan kaca tetap ada.",
          injury_table_p2: "Memar ringan [1]; 1% pecah gendang telinga (20–30 kPa) [4].",
          injury_table_s2: "Kerusakan struktur sedang dapat menyebabkan bagian langit-langit runtuh dan benda-benda kecil jatuh [2].",
          injury_table_c2: "Kombinasi memar ringan dan cedera sekunder dari pecahan/puing-puing.",
          injury_table_p3: "Memar sedang [1]; probabilitas pecah gendang telinga 50% sekitar 110 kPa [4].",
          injury_table_s3: "Kerusakan struktur yang lebih luas menciptakan puing-puing beterbangan [2], yang dapat menyebabkan patah tulang.",
          injury_table_c3: "Tingkat keparahan cedera meningkat karena efek gabungan dari gelombang ledakan dan puing-puing beterbangan.",
          injury_table_p4: "Memar internal yang serius dan berpotensi fatal [1]; risiko kerusakan paru-paru akibat ledakan bergantung pada durasi fase positif dengan tekanan berlebih 70 kPa pada 50 ms atau 140–200 kPa pada 3 ms [4].",
          injury_table_s4: "Banyak bangunan rusak berat; beberapa mungkin hancur total [2], menciptakan situasi terperangkap di bawah reruntuhan.",
          injury_table_c4: "Gabungan cedera internal dan kondisi terperangkap berpotensi fatal.",
          injury_table_p5: "Tingkat kematian tinggi bagi orang tanpa pelindung, namun ambang batas bergantung pada durasi fase positif: 1% kematian pada 190 kPa selama 50 ms atau 400–500 kPa selama 3 ms [4].",
          injury_table_s5: "Keruntuhan total bangunan; puing-puing besar bergerak dengan cepat [2].",
          injury_table_c5: "Risiko kematian meningkat tajam ketika tekanan berlebih dan durasinya melampaui ambang batas.",
          // == AKHIR BAGIAN TAMBAHAN ==
         
          damage_no_significant: "Tidak ada kerusakan struktural signifikan yang diprediksi.",
          equipment_no_significant: "Tidak ada kerusakan peralatan signifikan yang diprediksi.",
          alonso_warning: "Peringatan: Hasil diekstrapolasi di luar rentang valid model Alonso (1 ≤ ze ≤ 200).",
          sadovski_warning: "Peringatan: Hasil diekstrapolasi di luar rentang valid model Sadovski (1 ≤ ze ≤ 15).",
          crowl_warning: "Peringatan: Hasil diekstrapolasi di luar rentang valid model Crowl (0.01 ≤ Ze ≤ 100).",

          damage_accidental_glass: "Kerusakan kaca yang tidak disengaja [1].",
          damage_minor_glass_architectural: "Pecahan kaca kecil dan kerusakan arsitektur ringan seperti pergeseran genteng dan plester yang jatuh [1].",
          damage_widespread_glass_nonstructural: "Pecahan kaca yang luas dan kerusakan signifikan pada elemen non-struktural seperti pintu, jendela, dan atap [1].",
          damage_collapse_unreinforced_walls: "Runtuhnya dinding beton tak bertulang atau balok semen [2].",
          damage_steel_panels_destroyed_tanks_ruptured_1: "Panel baja tanpa rangka hancur; tangki penyimpanan minyak pecah (20.7 kPa - ≤25 kPa) [2].",
          damage_steel_panels_destroyed_tanks_ruptured_2: "Panel baja tanpa rangka hancur; tangki penyimpanan minyak pecah (25 kPa - 27.6 kPa) [2].",
          damage_extensive_nonstructural: "Kerusakan luas pada elemen non-struktural seperti fasad bata, atap, dan langit-langit [1].",
          damage_total_destruction_houses_1: "Kehancuran mendekati total pada rumah tinggal (34.5 kPa - ≤40 kPa) [2].",
          damage_total_destruction_houses_2: "Kehancuran mendekati total pada rumah tinggal (40 kPa - 48.2 kPa) [2].",
          damage_heavy_nonstructural_ceiling_collapse: "Kerusakan berat pada elemen non-struktural yang menyebabkan langit-langit runtuh [1].",
          damage_brick_panels_fail_1: "Panel bata tak bertulang setebal 8-12 inci gagal akibat geser atau lentur (48.2 kPa - ≤55 kPa) [2].",
          damage_brick_panels_fail_2: "Panel bata tak bertulang setebal 8-12 inci gagal akibat geser atau lentur (55 kPa - 55.1 kPa) [2].",
          damage_partial_collapse_concrete_columns: "Runtuh parsial elemen non-struktural dan kerusakan signifikan pada kolom beton [1].",
          damage_total_collapse_all_elements: "Runtuh mendekati total semua elemen bangunan, termasuk kerusakan berat pada kolom beton penahan beban [1].",

          desc_annoying_noise: "Kebisingan yang mengganggu (137 dB jika frekuensi rendah, 10–15 Hz)",
          desc_breakage_large_windows: "Pecahnya jendela besar yang sebelumnya mengalami tegangan",
          desc_loud_noise_glass_failure: "Suara keras (143 dB), ledakan sonik, kegagalan kaca",
          desc_small_windows_break: "Jendela kecil pecah karena tekanan",
          desc_typical_pressure_break_glass: "Tekanan tipikal untuk memecahkan kaca",
          desc_safe_distance: '"Jarak aman," probabilitas 95% tidak ada kerusakan serius di bawah tingkat ini, batas proyektil, kerusakan langit-langit kecil, 10% jendela pecah',
          desc_limited_minor_structural_damage: "Kerusakan struktural ringan terbatas",
          desc_minor_structural_damage_houses: "Kerusakan struktural ringan pada rumah",
          desc_partial_house_collapse: "Rumah runtuh sebagian, tidak dapat dihuni",
          desc_slight_distortion_steel_frames: "Distorsi ringan pada rangka baja berlapis",
          desc_partial_collapse_roof_walls: "Runtuh sebagian atap dan dinding",
          desc_lower_limit_serious_damage: "Batas bawah kerusakan struktural serius",
          desc_50_percent_brick_walls_collapse: "50% dinding bata runtuh",
          desc_heavy_machinery_damaged: "Mesin berat (3.000 lb) sedikit rusak di gedung industri; rangka baja terdistorsi atau terlepas dari fondasi",
          desc_light_industrial_structures_collapse: "Struktur industri ringan runtuh",
          desc_utility_poles_break: "Tiang listrik patah; peralatan hidrolik 40.000 lb sedikit rusak",
          desc_freight_train_cars_destroyed: "Gerbong kereta barang hancur total",
          desc_fully_loaded_train_cars_destroyed: "Gerbong kereta bermuatan penuh hancur total",
          desc_likely_total_damage: "Kemungkinan kerusakan total pada struktur; peralatan 7.000 lb bergeser dan rusak parah; mesin 12.000 lb masih ada",

          equip_no_damage: "Tidak ada kerusakan signifikan yang tercatat",
          equip_control_house_steel_roof_windows_broken: "Rumah kontrol atap baja. Jendela dan alat ukur pecah. Menara pendingin. Kisi-kisi jatuh (1.37855 - 2.44738 kPa).",
          equip_switchgear_damaged_tank_roof_collapses: "Rumah kontrol atap baja. Switchgear rusak akibat atap runtuh. Rumah kontrol atap beton. Jendela pecah. Atap tangki (kerucut). Atap runtuh.",
          equip_control_house_roof_collapses_instruments_damaged: "Rumah kontrol atap baja. Atap runtuh. Rumah kontrol atap beton. Rangka berubah bentuk. Instrumen. Rusak. Jendela dan alat ukur pecah.",
          equip_concrete_roof_collapses_fire_heater_cracks: "Rumah kontrol atap beton. Atap runtuh. Instrumen. Rusak. Jendela dan alat ukur pecah. Pemanas api. Bata retak. Filter. Kerusakan akibat serpihan proyektil.",
          equip_fire_heater_moves: "Pemanas api. Unit bergerak dan pipa pecah.",
          equip_tank_uplifts_instruments_damaged: "Atap tangki (kerucut). Unit terangkat (setengah miring). Instrumen. Unit rusak. Unit bergerak dan pipa pecah. Kontrol rusak. Menara pendingin. Rangka runtuh. Rumah kontrol atap baja. Dinding balok jatuh. Penopang pinus. Unit bergerak dan pipa pecah.",
          equip_cooling_tower_collapses: "Menara pendingin. Rangka runtuh. Penopang pinus. Rangka berubah bentuk.",
          equip_reactor_moves: "Reaktor (kimia). Unit bergerak dan pipa pecah.",
          equip_filter_inner_parts_damaged: "Filter. Bagian dalam rusak. Utilitas (regulator gas). Kontrol rusak. Utilitas (transformator elektronik). Kerusakan akibat serpihan proyektil.",
          equip_fire_heater_overturns: "Pemanas api. Unit terbalik atau hancur. Reaktor (kimia). Rangka berubah bentuk. Motor listrik. Kerusakan akibat serpihan proyektil. Blower. Unit berada di atas fondasi.",
          equip_fractionation_column_cracks: "Kolom fraksinasi. Rangka retak.",
          equip_instrument_cubicle_overturns: "Kubikel instrumen. Unit terbalik atau hancur. Penopang pinus. Pipa pecah. Rangka runtuh. Kolom fraksinasi. Unit bergerak dan pipa pecah.",
          equip_tank_uplifts_reactor_destroyed: "Atap tangki (kerucut). Unit terangkat (0.9 miring). Reaktor (kimia). Unit hancur. Kolom fraksinasi. Unit bergerak dan pipa pecah. Kolom ekstraksi. Unit bergerak dan pipa pecah.",
          equip_reactor_cracking_moves: "Reaktor (perengkahan). Unit bergerak dan pipa pecah. Kolom fraksinasi. Unit terbalik atau hancur.",
          equip_generator_overturns: "Generator. Unit terbalik atau hancur. Utilitas (transformator elektronik). Unit bergerak dan pipa pecah. Penukar panas. Unit bergerak dan pipa pecah.",
          equip_tank_sphere_moves: "Tangki bola. Unit bergerak dan pipa pecah.",
          equip_reactor_chemical_overturns: "Reaktor (kimia). Unit terbalik atau hancur. Motor listrik. Unit bergerak dan pipa pecah. Kolom ekstraksi. Unit terbalik atau hancur. Penukar panas. Unit terbalik atau hancur.",
          equip_filter_uplifts: "Filter. Unit terangkat (0.9 miring).",
          equip_utilities_overturns: "Utilitas (transformator elektronik). Unit terbalik atau hancur. Utilitas (regulator gas). Kontrol rusak. Casing rusak. Turbin uap. Pipa pecah. Casing rusak.",
          equip_filter_overturns: "Filter. Unit terbalik atau hancur. Reaktor (perengkahan). Unit terbalik atau hancur. Turbin uap. Unit terbalik atau hancur. Turbin uap. Kontrol rusak.",
          equip_steam_turbine_piping_breaks: "Turbin uap. Pipa pecah. Tangki bola. Unit bergerak dan pipa pecah. Bejana tekan (vertikal). Unit terbalik atau hancur.",
          equip_tank_sphere_overturns: "Tangki bola. Unit terbalik atau hancur. Pompa. Unit bergerak di atas fondasi.",
          equip_floating_roof_collapses: "Tangki (atap apung). Atap runtuh. Reaktor (perengkahan). Unit terbalik atau hancur. Turbin uap. Unit bergerak di atas fondasi."
        }
      };

      let currentLanguage = 'en'; // Default language

      function setLanguage(lang) {
        if (!translations[lang]) return;
        currentLanguage = lang;
        try {
          localStorage.setItem('preferredLanguage', lang);
        } catch (e) {
          console.warn("Could not save language preference to local storage:", e);
        }
       
        document.documentElement.lang = lang;

        document.querySelectorAll('[data-lang-key]').forEach(el => {
          const key = el.getAttribute('data-lang-key');
          const translation = translations[lang][key];
          if (translation !== undefined) {
            if (el.placeholder !== undefined && el.tagName === 'INPUT') {
                el.placeholder = translation;
            } else {
                el.innerHTML = translation;
            }
          }
        });

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === lang);
        });

        if ($('material').value) {
          renderEquation($('material').value);
        }
        if (chartController) {
            // Memperbaiki bug: Memanggil fungsi update yang benar alih-alih fungsi yang tidak ada.
            updatePsVsZeChart();
        }
        if (overpressureChartController) {
            updateOverpressureChartFromLog();
        }
        const Po_crowl = parseFloat($("Po_crowl")?.value);
        const Po_alonso = parseFloat($("Po_alonso")?.value);
        const Po_sadovski = parseFloat($("Po_sadovski")?.value);
        const isAlonsoExtrapolated = (parseFloat($("Ze")?.value) < 1 || parseFloat($("Ze")?.value) > 200);
        updateEstimationPanels(Po_crowl, Po_alonso, Po_sadovski, isAlonsoExtrapolated);
        updateInjuryPanels(Po_crowl, Po_alonso, Po_sadovski);
        setupFloatingPanel(); 
      }

      function initLanguage() {
        let preferredLanguage = 'en';
        try {
            preferredLanguage = localStorage.getItem('preferredLanguage') || 'en';
        } catch (e) {
            console.warn("Could not read language preference from local storage:", e);
        }
        setLanguage(preferredLanguage);

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                setLanguage(btn.dataset.lang);
            });
        });
      }
      /*
      ================================================================================
      | END: BILINGUAL TRANSLATION SCRIPT                                            |
      ================================================================================
      */   
      function getDamageDescriptionKeys(kPa) {
        const keys = [];
        if (kPa >= 0.14 && kPa <= 2) keys.push("damage_accidental_glass");
        if (kPa > 2 && kPa <= 9) keys.push("damage_minor_glass_architectural");
        if (kPa > 9 && kPa <= 25) keys.push("damage_widespread_glass_nonstructural");
        if (kPa >= 13.8 && kPa <= 20.7) keys.push("damage_collapse_unreinforced_walls");
        if (kPa > 20.7 && kPa <= 25) keys.push("damage_steel_panels_destroyed_tanks_ruptured_1");
        if (kPa > 25 && kPa <= 27.6) keys.push("damage_steel_panels_destroyed_tanks_ruptured_2");
        if (kPa > 25 && kPa <= 40) keys.push("damage_extensive_nonstructural");
        if (kPa >= 34.5 && kPa <= 40) keys.push("damage_total_destruction_houses_1");
        if (kPa > 40 && kPa <= 48.2) keys.push("damage_total_destruction_houses_2");
        if (kPa > 40 && kPa <= 55) keys.push("damage_heavy_nonstructural_ceiling_collapse");
        if (kPa > 48.2 && kPa <= 55) keys.push("damage_brick_panels_fail_1");
        if (kPa > 55 && kPa <= 55.1) keys.push("damage_brick_panels_fail_2");
        if (kPa > 55 && kPa <= 76) keys.push("damage_partial_collapse_concrete_columns");
        if (kPa > 76) keys.push("damage_total_collapse_all_elements");
        return keys;
      }
     
      const overpressureDamageLevels = [
        { minPo: 0.14, maxPo: 0.21, descriptionKey: "desc_annoying_noise", citation_ref: 2 },
        { minPo: 0.21, maxPo: 0.28, descriptionKey: "desc_breakage_large_windows", citation_ref: 2 },
        { minPo: 0.28, maxPo: 0.69, descriptionKey: "desc_loud_noise_glass_failure", citation_ref: 2 },
        { minPo: 0.69, maxPo: 1.03, descriptionKey: "desc_small_windows_break", citation_ref: 2 },
        { minPo: 1.03, maxPo: 2.07, descriptionKey: "desc_typical_pressure_break_glass", citation_ref: 2 },
        { minPo: 2.07, maxPo: 2.76, descriptionKey: "desc_safe_distance", citation_ref: 2 },
        { minPo: 2.76, maxPo: 4.8, descriptionKey: "desc_limited_minor_structural_damage", citation_ref: 2 },
        { minPo: 4.8, maxPo: 6.9, descriptionKey: "desc_minor_structural_damage_houses", citation_ref: 2 },
        { minPo: 6.9, maxPo: 9, descriptionKey: "desc_partial_house_collapse", citation_ref: 2 },
        { minPo: 9, maxPo: 13.8, descriptionKey: "desc_slight_distortion_steel_frames", citation_ref: 2 },
        { minPo: 13.8, maxPo: 15.8, descriptionKey: "desc_partial_collapse_roof_walls", citation_ref: 2 },
        { minPo: 15.8, maxPo: 17.2, descriptionKey: "desc_lower_limit_serious_damage", citation_ref: 2 },
        { minPo: 17.2, maxPo: 20.7, descriptionKey: "desc_50_percent_brick_walls_collapse", citation_ref: 2 },
        { minPo: 20.7, maxPo: 25, descriptionKey: "desc_heavy_machinery_damaged", citation_ref: 2 },
        { minPo: 25, maxPo: 34.5, descriptionKey: "desc_light_industrial_structures_collapse", citation_ref: 2 },
        { minPo: 34.5, maxPo: 48.2, descriptionKey: "desc_utility_poles_break", citation_ref: 2 },
        { minPo: 48.2, maxPo: 62, descriptionKey: "desc_freight_train_cars_destroyed", citation_ref: 2 },
        { minPo: 62, maxPo: 68.9, descriptionKey: "desc_fully_loaded_train_cars_destroyed", citation_ref: 2 },
        { minPo: 68.9, maxPo: Infinity, descriptionKey: "desc_likely_total_damage", citation_ref: 2 },
      ];
     
      const processEquipmentDamage = [
        { po: 0, descriptionKey: "equip_no_damage", citation_ref: 3 },
        { po: 3.46, descriptionKey: "equip_control_house_steel_roof_windows_broken", citation_ref: 3 },
        { po: 6.89, descriptionKey: "equip_switchgear_damaged_tank_roof_collapses", citation_ref: 3 },
        { po: 10.34, descriptionKey: "equip_control_house_roof_collapses_instruments_damaged", citation_ref: 3 },
        { po: 13.79, descriptionKey: "equip_concrete_roof_collapses_fire_heater_cracks", citation_ref: 3 },
        { po: 17.24, descriptionKey: "equip_fire_heater_moves", citation_ref: 3 },
        { po: 20.68, descriptionKey: "equip_tank_uplifts_instruments_damaged", citation_ref: 3 },
        { po: 24.13, descriptionKey: "equip_cooling_tower_collapses", citation_ref: 3 },
        { po: 27.58, descriptionKey: "equip_reactor_moves", citation_ref: 3 },
        { po: 31.03, descriptionKey: "equip_filter_inner_parts_damaged", citation_ref: 3 },
        { po: 34.47, descriptionKey: "equip_fire_heater_overturns", citation_ref: 3 },
        { po: 37.92, descriptionKey: "equip_fractionation_column_cracks", citation_ref: 3 },
        { po: 41.37, descriptionKey: "equip_instrument_cubicle_overturns", citation_ref: 3 },
        { po: 44.82, descriptionKey: "equip_tank_uplifts_reactor_destroyed", citation_ref: 3 },
        { po: 48.26, descriptionKey: "equip_reactor_cracking_moves", citation_ref: 3 },
        { po: 51.71, descriptionKey: "equip_generator_overturns", citation_ref: 3 },
        { po: 55.16, descriptionKey: "equip_tank_sphere_moves", citation_ref: 3 },
        { po: 62.05, descriptionKey: "equip_reactor_chemical_overturns", citation_ref: 3 },
        { po: 65.5, descriptionKey: "equip_filter_uplifts", citation_ref: 3 },
        { po: 68.95, descriptionKey: "equip_utilities_overturns", citation_ref: 3 },
        { po: 82.74, descriptionKey: "equip_filter_overturns", citation_ref: 3 },
        { po: 96.53, descriptionKey: "equip_steam_turbine_piping_breaks", citation_ref: 3 },
        { po: 110.32, descriptionKey: "equip_tank_sphere_overturns", citation_ref: 3 },
        { po: 137.9, descriptionKey: "equip_floating_roof_collapses", citation_ref: 3 }
      ];

      // GANTI DENGAN BLOK DI BAWAH INI
      const simulationScenarios = {
        // =================== SKENARIO AMONIUM NITRATE EXPLOSION ===================
        beirut: {
          name: "2020 Beirut AN Explosion",
          data: [
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1734.8209', dist: '300', w_tnt: '576999.986', ze: '3.604', ps: '1.096', po_crowl: '111.073', po_alonso: '85.912', po_sadovski: '63.787', lat: '33.901404', lon: '35.519039', poModel: 'crowl' },
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1734.8209', dist: '500', w_tnt: '576999.986', ze: '6.006', ps: '0.419', po_crowl: '42.468', po_alonso: '30.771', po_sadovski: '26.163', lat: '33.901404', lon: '35.519039', poModel: 'crowl' },
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1734.8209', dist: '700', w_tnt: '576999.986', ze: '8.408', ps: '0.250', po_crowl: '25.310', po_alonso: '15.647', po_sadovski: '15.698', lat: '33.901404', lon: '35.519039', poModel: 'crowl' },
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1734.8209', dist: '1000', w_tnt: '576999.986', ze: '12.012', ps: '0.156', po_crowl: '15.813', po_alonso: '10.235', po_sadovski: '9.617', lat: '33.901404', lon: '35.519039', poModel: 'crowl' },
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1734.8209', dist: '1500', w_tnt: '576999.986', ze: '18.018', ps: '0.097', po_crowl: '9.857', po_alonso: '6.395', po_sadovski: '5.778', lat: '33.901404', lon: '35.519039', poModel: 'crowl' }
          ]
        },
        tianjin: {
          name: "2015 Tianjin AN Explosion",
          data: [
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1495.6', dist: '300', w_tnt: '450000', ze: '3.915', ps: '0.941', po_crowl: '95.38', po_alonso: '73.21', po_sadovski: '56.12', lat: '39.039677', lon: '117.736059', poModel: 'crowl' },
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1495.6', dist: '600', w_tnt: '450000', ze: '7.830', ps: '0.288', po_crowl: '29.18', po_alonso: '18.99', po_sadovski: '17.73', lat: '39.039677', lon: '117.736059', poModel: 'crowl' },
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1495.6', dist: '900', w_tnt: '450000', ze: '11.74', ps: '0.162', po_crowl: '16.42', po_alonso: '10.74', po_sadovski: '10.22', lat: '39.039677', lon: '117.736059', poModel: 'crowl' },
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1495.6', dist: '1300', w_tnt: '450000', ze: '16.96', ps: '0.104', po_crowl: '10.51', po_alonso: '6.85', po_sadovski: '6.32', lat: '39.039677', lon: '117.736059', poModel: 'crowl' },
            { material: 'AN', eta: '0.35', e_tnt: '4500', rho: '1725', dh: '2479', vol: '1495.6', dist: '2800', w_tnt: '450000', ze: '36.54', ps: '0.042', po_crowl: '4.29', po_alonso: '2.77', po_sadovski: '2.59', lat: '39.039677', lon: '117.736059', poModel: 'crowl' }
          ]
        },
        // =================== SKENARIO LPG EXPLOSION ===================
        sanJuanico: {
          name: "1984 San Juanico LPG Explosion",
          data: [
            { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '50000', vol: '118947.368', dist: '300', w_tnt: '339000', ze: '4.32', ps: '0.78', po_crowl: '79.02', po_alonso: '62.11', po_sadovski: '50.18', lat: '19.523999', lon: '-99.109216', poModel: 'crowl' },
            { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '50000', vol: '118947.368', dist: '550', w_tnt: '339000', ze: '7.92', ps: '0.28', po_crowl: '28.38', po_alonso: '18.87', po_sadovski: '17.65', lat: '19.523999', lon: '-99.109216', poModel: 'crowl' },
            { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '50000', vol: '118947.368', dist: '1000', w_tnt: '339000', ze: '14.4', ps: '0.12', po_crowl: '12.16', po_alonso: '8.23', po_sadovski: '8.44', lat: '19.523999', lon: '-99.109216', poModel: 'crowl' },
            { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '50000', vol: '118947.368', dist: '1300', w_tnt: '339000', ze: '18.72', ps: '0.08', po_crowl: '8.1', po_alonso: '5.65', po_sadovski: '5.43', lat: '19.523999', lon: '-99.109216', poModel: 'crowl' }
          ]
        },
        borgoItaly: {
            name: "2018 Borgo Italy LPG Explosion",
            data: [
                { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '46000', vol: '50.71', dist: '15', w_tnt: '7582.427', ze: '0.764', ps: '35.096', po_crowl: '3556.064', po_alonso: '1943.598', po_sadovski: '2423.251', lat: '44.515030', lon: '11.280008', poModel: 'crowl' },
                { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '46000', vol: '50.71', dist: '64', w_tnt: '7582.427', ze: '3.258', ps: '1.358', po_crowl: '137.598', po_alonso: '105.227', po_sadovski: '77.5', lat: '44.515030', lon: '11.280008', poModel: 'crowl' },
                { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '46000', vol: '50.71', dist: '100', w_tnt: '7582.427', ze: '5.09', ps: '0.559', po_crowl: '56.61', po_alonso: '42.909', po_sadovski: '34.344', lat: '44.515030', lon: '11.280008', poModel: 'crowl' },
                { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '46000', vol: '50.71', dist: '200', w_tnt: '7582.427', ze: '10.18', ps: '0.193', po_crowl: '19.508', po_alonso: '12.401', po_sadovski: '12.002', lat: '44.515030', lon: '11.280008', poModel: 'crowl' },
                { material: 'LPG', eta: '0.03', e_tnt: '4550', rho: '493', dh: '46000', vol: '50.71', dist: '500', w_tnt: '7582.427', ze: '25.451', ps: '0.067', po_crowl: '6.784', po_alonso: '4.284', po_sadovski: '3.851', lat: '44.515030', lon: '11.280008', poModel: 'crowl' }
            ]
        },
        // =================== SKENARIO H2 EXPLOSION ===================
        muskingum: {
            name: "2007 Muskingum H2 Plant Explosion",
            data: [
                { material: 'H₂', eta: '0.05', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '418', dist: '10', w_tnt: '50.878', ze: '2.699', ps: '2.58', po_crowl: '208.566', po_alonso: '153.621', po_sadovski: '113.39', lat: '39.585229', lon: '-81.677566', poModel: 'crowl' },
                { material: 'H₂', eta: '0.05', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '418', dist: '15', w_tnt: '50.878', ze: '4.048', ps: '0.864', po_crowl: '87.568', po_alonso: '68', po_sadovski: '51.365', lat: '39.585229', lon: '-81.677566', poModel: 'crowl' },
                { material: 'H₂', eta: '0.05', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '418', dist: '25', w_tnt: '50.878', ze: '6.747', ps: '0.347', po_crowl: '35.169', po_alonso: '24.355', po_sadovski: '21.794', lat: '39.585229', lon: '-81.677566', poModel: 'crowl' },
                { material: 'H₂', eta: '0.05', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '418', dist: '50', w_tnt: '50.878', ze: '13.494', ps: '0.136', po_crowl: '13.735', po_alonso: '8.943', po_sadovski: '8.273', lat: '39.585229', lon: '-81.677566', poModel: 'crowl' },
                { material: 'H₂', eta: '0.05', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '418', dist: '100', w_tnt: '50.878', ze: '26.987', ps: '0.063', po_crowl: '6.377', po_alonso: '4.002', po_sadovski: '3.602', lat: '39.585229', lon: '-81.677566', poModel: 'crowl' }
            ]
        },
        stclara: {
            name: "2019 Santa Clara H2 Explosion",
            data: [
                { material: 'H₂', eta: '0.03', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '3000', dist: '10', w_tnt: '219.09', ze: '1.659', ps: '5.348', po_crowl: '643.224', po_alonso: '408.597', po_sadovski: '335.542', lat: '37.3865991655481', lon: '-121.95744540904', poModel: 'crowl' },
                { material: 'H₂', eta: '0.03', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '3000', dist: '20', w_tnt: '219.09', ze: '3.318', ps: '1.306', po_crowl: '132.312', po_alonso: '101.444', po_sadovski: '74.787', lat: '37.3865991655481', lon: '-121.95744540904', poModel: 'crowl' },
                { material: 'H₂', eta: '0.03', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '3000', dist: '25', w_tnt: '219.09', ze: '4.147', ps: '0.824', po_crowl: '83.463', po_alonso: '64.779', po_sadovski: '49.159', lat: '37.3865991655481', lon: '-121.95744540904', poModel: 'crowl' },
                { material: 'H₂', eta: '0.03', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '3000', dist: '35', w_tnt: '219.09', ze: '5.806', ps: '0.444', po_crowl: '44.959', po_alonso: '32.94', po_sadovski: '27.629', lat: '37.3865991655481', lon: '-121.95744540904', poModel: 'crowl' },
                { material: 'H₂', eta: '0.03', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '3000', dist: '45', w_tnt: '219.09', ze: '7.465', ps: '0.297', po_crowl: '30.108', po_alonso: '19.876', po_sadovski: '18.695', lat: '37.3865991655481', lon: '-121.95744540904', poModel: 'crowl' },
                { material: 'H₂', eta: '0.03', e_tnt: '4500', rho: '0.08375', dh: '130800', vol: '3000', dist: '70', w_tnt: '219.09', ze: '11.612', ps: '0.163', po_crowl: '16.491', po_alonso: '10.646', po_sadovski: '10.056', lat: '37.3865991655481', lon: '-121.95744540904', poModel: 'crowl' }
            ]
        }
      };
      
      let chartController;
      let overpressureChartController; 
      // simulationLog is now globally defined, so we remove the local 'let' declaration here.

      function showStatusMessage(messageKey, isError = false, extraInfo = '') {
          const msgEl = $("msg");
          if (!msgEl) return;
         
          const message = (translations[currentLanguage][messageKey] || messageKey) + extraInfo;
          msgEl.textContent = message;

          if (isError) {
              msgEl.classList.add("bad");
          } else {
              msgEl.classList.remove("bad");
          }
          msgEl.style.display = 'block';
         
          setTimeout(() => {
              if (msgEl.textContent === message) {
                  msgEl.style.display = 'none';
              }
          }, 5000);
      }

      function loadLogo() {
        const img = $("itbLogo"); if (!img) return;
        const fallback = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256"><circle cx="128" cy="128" r="120" fill="%230079c2"/><text x="50%" y="56%" font-family="Georgia, serif" font-size="88" text-anchor="middle" fill="white">ITB</text></svg>';
        img.onerror = () => { img.onerror = null; img.src = fallback; };
        img.src = "/img/Logo_Institut_Teknologi_Bandung.webp";
      }

      function goTop() { try { window.scrollTo({ top: 0, behavior: "smooth" }); } catch (e) { window.scrollTo(0, 0); } }

      function initializeChart() {
        const chartDom = document.getElementById('chart');
        if (!chartDom) return null;
        const chart = echarts.init(chartDom);
        new ResizeObserver(() => chart.resize()).observe(chartDom);

        const css = getComputedStyle(document.documentElement);
        const BLUE    = (css.getPropertyValue('--blue-itb') || '#0079c2').trim();
        const DANGER = (css.getPropertyValue('--danger')   || '#DC2626').trim();

        const fPs = (ze) => (1616 * (1 + (ze/4.5)**2)) /
          (Math.sqrt(1 + (ze/0.048)**2) * Math.sqrt(1 + (ze/0.32)**2) * Math.sqrt(1 + (ze/1.35)**2));
        const logspace = (min, max, n=1000) =>
          Array.from({length: n}, (_, i) => 10**(Math.log10(min) + (Math.log10(max) - Math.log10(min)) * i / (n-1)));
        const refPairs = logspace(0.01, 100).map(z => [z, fPs(z)]);

        const btn = $('btnExport');
        if (btn) {
          btn.addEventListener('click', () => {
            const url = chart.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#FFFFFF' });
            const a = document.createElement('a'); a.href = url; a.download = 'plot-explosion-ps-vs-ze.png'; a.click();
          });
        }
       
        const getBaseOption = () => ({
            backgroundColor: 'transparent',
            tooltip: {
                confine: true, trigger: 'item',
                formatter: p => {
                    const v = Array.isArray(p.value) ? p.value : [];
                    const zeV = Number.isFinite(v[0]) ? v[0].toPrecision(4) : '—';
                    const psV = Number.isFinite(v[1]) ? v[1].toPrecision(4) : '—';
                    return `<b>${p.seriesName}</b><br/>ze: ${zeV}<br/>Ps: ${psV}`;
                },
                backgroundColor: '#FFFFFF', borderColor: '#cccccc', borderWidth: 1, textStyle: { color: '#212121' }
            },
            xAxis: {
                type: 'log', logBase: 10, min: 0.01, max: 100,
                axisLine: { lineStyle: { color: '#94a3b8' } },
                splitLine: { lineStyle: { color: 'rgba(0, 0, 0, 0.1)', width: 2 } },
                minorSplitLine: { show: true, lineStyle: { color: 'rgba(0, 0, 0, 0.05)' } }
            },
            yAxis: {
                type: 'log', logBase: 10, min: 0.01, max: 10000,
                nameRotate: 90,
                axisLine: { lineStyle: { color: '#94a3b8' } },
                splitLine: { lineStyle: { color: 'rgba(0, 0, 0, 0.1)', width: 2 } },
                minorSplitLine: { show: true, lineStyle: { color: 'rgba(0, 0, 0, 0.05)' } }
            },
            series: [ // Pre-define series structure
                {
                  name: translations[currentLanguage].chart_tooltip_ref_curve,
                  type: 'line', showSymbol: false,
                  lineStyle: { width: 2.5, color: BLUE, shadowColor: 'rgba(0, 0, 0, 0.2)', shadowBlur: 5, shadowOffsetY: 2 },
                  data: refPairs, zlevel: 1
                },
                {
                  name: 'Log Data',
                  type: 'scatter', symbolSize: 8,
                  itemStyle: { color: '#64748b', borderColor: '#ffffff', borderWidth: 1, opacity: 0.7 },
                  data: [], zlevel: 2
                },
                {
                  name: 'Current Calculation',
                  type: 'scatter', symbolSize: 12,
                  itemStyle: { color: DANGER, borderColor: '#ffffff', borderWidth: 2, shadowColor: 'rgba(0,0,0,0.3)', shadowBlur: 5 },
                  data: [], zlevel: 3
                }
            ],
            media: [
                {
                    query: { minWidth: 601 },
                    option: {
                        grid: { left: 72, right: 35, top: 80, bottom: 70 },
                        title: { text: translations[currentLanguage].chart_title_main, subtext: translations[currentLanguage].chart_subtitle_main, left: 'center', top: 10, textStyle: { color: '#212121', fontSize: 20 }, subtextStyle: { color: '#424242' }},
                        xAxis: { name: translations[currentLanguage].chart_x_axis_label, nameLocation: 'middle', nameGap: 35, nameTextStyle: { color: '#212121', fontSize: 16, fontWeight: 'bold' }, axisLabel: { color: '#424242' }},
                        yAxis: { name: translations[currentLanguage].chart_y_axis_label, nameLocation: 'middle', nameGap: 50, nameTextStyle: { color: '#212121', fontSize: 16, fontWeight: 'bold' }, axisLabel: { color: '#424242' }}
                    }
                },
                {
                    query: { maxWidth: 600 },
                    option: {
                        grid: { left: 55, right: 20, top: 70, bottom: 60 },
                        title: { text: translations[currentLanguage].chart_title_mobile, subtext: translations[currentLanguage].chart_subtitle_mobile, left: 'center', top: 10, textStyle: { color: '#212121', fontSize: 16 }, subtextStyle: { color: '#424242', fontSize: 12 }},
                        xAxis: { name: translations[currentLanguage].chart_x_axis_label_mobile, nameLocation: 'middle', nameGap: 30, nameTextStyle: { color: '#212121', fontSize: 14, fontWeight: 'bold' }, axisLabel: { color: '#424242', fontSize: 10 }},
                        yAxis: { name: translations[currentLanguage].chart_y_axis_label_mobile, nameLocation: 'middle', nameGap: 35, nameTextStyle: { color: '#212121', fontSize: 14, fontWeight: 'bold' }, axisLabel: { color: '#424242', fontSize: 10 }}
                    }
                }
            ]
        });
       
        chart.setOption(getBaseOption());

        return {
          updateChart: function(currentCalcPoint, logDataPoints) {
            chart.setOption(getBaseOption()); 
            const materialSel = $('material');
            const selectedOption = materialSel ? materialSel.options[materialSel.selectedIndex] : null;
            const compoundName = (selectedOption && selectedOption.value) ? selectedOption.text : 'Calculation';

            const currentSeriesData = (currentCalcPoint && Number.isFinite(currentCalcPoint.ze) && Number.isFinite(currentCalcPoint.ps))
              ? [[currentCalcPoint.ze, currentCalcPoint.ps]]
              : [];

            chart.setOption({
              series: [
                { name: translations[currentLanguage].chart_tooltip_ref_curve, data: refPairs },
                { name: 'Log Data', data: logDataPoints || [] },
                { name: `${translations[currentLanguage].chart_tooltip_compound}: ${compoundName}`, data: currentSeriesData }
              ]
            });
          }
        };
      }
     
      // Overwrite the placeholder with the actual function implementation
      updatePsVsZeChart = function() {
          if (!chartController) return;

          const pa = parseFloat($("pa").value);
          if (isNaN(pa)) return;

          // 1. Dapatkan Data Log - SELALU gunakan 'po_crowl' untuk konsistensi.
          const logPoints = simulationLog.map(log => {
              const ze = parseFloat(log.ze);
              const po = parseFloat(log.po_crowl); // Revisi: Dikunci ke model Crowl
              if (!isNaN(ze) && !isNaN(po)) {
                  const ps = po / pa;
                  return [ze, ps];
              }
              return null;
          }).filter(Boolean);

          // 2. Dapatkan Data Perhitungan Saat Ini - SELALU gunakan 'Po_crowl'.
          const currentZe = parseFloat($("Ze")?.value);
          
          let currentPs;
          if (!isNaN(currentZe) && pa > 0) {
              const currentPoCrowl = parseFloat($("Po_crowl")?.value); // Revisi: Hanya menggunakan Crowl
              if (!isNaN(currentPoCrowl)) {
                  currentPs = currentPoCrowl / pa;
              }
          }
          
          const currentCalcPoint = { ze: currentZe, ps: currentPs };
          
          // 3. Perbarui grafik
          chartController.updateChart(currentCalcPoint, logPoints);
      }

      function initializeOverpressureChart() {
          const ctx = document.getElementById('overpressureChart');
          if (!ctx) return null;

          const chart = new Chart(ctx, {
              type: 'line',
              data: {
                  datasets: [
                      { label: 'Crowl', data: [], borderColor: 'rgb(255, 99, 132)', borderWidth: 2.5, tension: 0.4, pointRadius: 3, pointHoverRadius: 5 },
                      { label: 'Alonso', data: [], borderColor: 'rgb(54, 162, 235)', borderWidth: 2.5, tension: 0.4, pointRadius: 3, pointHoverRadius: 5 },
                      { label: 'Sadovski', data: [], borderColor: 'rgb(75, 192, 192)', borderWidth: 2.5, tension: 0.4, pointRadius: 3, pointHoverRadius: 5 }
                  ]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      title: { display: true, text: 'Overpressure vs Distance', font: { size: 20, weight: 'bold' }, padding: { top: 10, bottom: 20 } },
                      legend: { display: true, position: 'top', labels: { usePointStyle: true, pointStyle: 'line' } }
                  },
                  scales: {
                      x: { 
                          type: 'linear', 
                          title: { display: true, text: 'Distance [m]', font: { size: 14, weight: '500' } },
                          grid: { drawOnChartArea: true, color: 'rgba(0, 0, 0, 0.05)' },
                      },
                      y: { 
                          title: { display: true, text: 'Overpressure [kPa]', font: { size: 14, weight: '500' } },
                          grid: { drawOnChartArea: true, color: 'rgba(0, 0, 0, 0.05)' },
                      }
                  }
              }
          });
         
          return {
              chartInstance: chart
          };
      }
     
      function updateOverpressureChartFromLog() {
          if (!overpressureChartController || !overpressureChartController.chartInstance) return;

          const chart = overpressureChartController.chartInstance;
          const msgEl = $('overpressureChartMsg');
          const canvasEl = $('overpressureChart');
         
          chart.options.plugins.title.text = translations[currentLanguage].chart_title_po_vs_dist;
          chart.options.scales.x.title.text = translations[currentLanguage].overpressure_chart_x_axis_label;
          chart.options.scales.y.title.text = translations[currentLanguage].overpressure_chart_y_axis_label;

          canvasEl.style.display = 'block';
          msgEl.style.display = 'none';

          if (simulationLog.length === 0) {
              chart.data.datasets.forEach(dataset => {
                  dataset.data = [];
              });
              chart.options.scales.x.min = 0;
              chart.options.scales.x.max = 3000;
              chart.options.scales.y.min = 0;
              chart.options.scales.y.max = 100;
              chart.update();
              return;
          }

          const crowlPoints = [];
          const alonsoPoints = [];
          const sadovskiPoints = [];
          const allYValues = [];
          const allXValues = [];

          simulationLog.forEach(log => {
              const dist = parseFloat(log.dist);
              if (isNaN(dist)) return;
              allXValues.push(dist);

              const poCrowl = parseFloat(log.po_crowl);
              if (!isNaN(poCrowl)) {
                  crowlPoints.push({ x: dist, y: poCrowl });
                  allYValues.push(poCrowl);
              }

              const poAlonso = parseFloat(log.po_alonso);
              if (!isNaN(poAlonso)) {
                  alonsoPoints.push({ x: dist, y: poAlonso });
                  allYValues.push(poAlonso);
              }

              const poSadovski = parseFloat(log.po_sadovski);
              if (!isNaN(poSadovski)) {
                  sadovskiPoints.push({ x: dist, y: poSadovski });
                  allYValues.push(poSadovski);
              }
          });

          const sortByX = (a, b) => a.x - b.x;
          chart.data.datasets[0].data = crowlPoints.sort(sortByX);
          chart.data.datasets[1].data = alonsoPoints.sort(sortByX);
          chart.data.datasets[2].data = sadovskiPoints.sort(sortByX);
         
          if (allYValues.length > 0) {
              const minX = Math.min(...allXValues);
              const maxX = Math.max(...allXValues);
              const minY = Math.min(...allYValues);
              const maxY = Math.max(...allYValues);

              chart.options.scales.x.min = minX > 0 ? minX * 0.95 : 0;
              chart.options.scales.x.max = maxX * 1.05;
              chart.options.scales.y.min = minY > 0 ? minY * 0.95 : 0;
              chart.options.scales.y.max = maxY * 1.05;
          } else {
              chart.options.scales.x.min = 0;
              chart.options.scales.x.max = 3000;
              chart.options.scales.y.min = 0;
              chart.options.scales.y.max = 100;
          }
         
          chart.update();
      }

      // FUNGSI BARU: Untuk menyorot baris pertama dari tabel log
      function highlightFirstRow() {
        const logTbody = $('logTbody');
        if (!logTbody) return;

        // Hapus sorotan yang sudah ada dari baris lain
        const currentlySelected = logTbody.querySelector('.selected-row');
        if (currentlySelected) {
            currentlySelected.classList.remove('selected-row');
        }

        // Tambahkan kelas sorotan ke baris data pertama di tabel
        const firstRow = logTbody.querySelector('tr:not(.log-placeholder)');
        if (firstRow) {
            firstRow.classList.add('selected-row');
        }
      }      

      function getImpactCategory(Po) {
        if (Po > 76) return { nameKey: "cat_catastrophic", color: "#991B1B", textColor: "#FFFFFF" };
        if (Po > 55) return { nameKey: "cat_major", color: "#F87171", textColor: "#FFFFFF" };
        if (Po > 40) return { nameKey: "cat_severe", color: "#FCA5A5", textColor: "var(--ink)" };
        if (Po > 25) return { nameKey: "cat_serious", color: "#FCD34D", textColor: "var(--ink)" };
        if (Po > 9) return { nameKey: "cat_moderate", color: "#FDE68A", textColor: "var(--ink)" };
        if (Po > 2) return { nameKey: "cat_minor", color: "#A7F3D0", textColor: "var(--ink)" };
        if (Po >= 0.14) return { nameKey: "cat_insignificant", color: "#D1FAE5", textColor: "var(--ink)" };
        if (Po >= 0) return { nameKey: "cat_no_effect", color: "#E5E7EB", textColor: "var(--ink)" };
        return { nameKey: "unknown", color: "var(--muted)", textColor: "#FFFFFF" };
      }

      function getInjuryRiskCategory(Po) {
          const poValue = parseFloat(Po);
          if (isNaN(poValue)) {
              return { nameKey: "injury_cat_invalid", color: "var(--muted)", textColor: "#FFFFFF" };
          }

          if (poValue < 0.14) {
              return { nameKey: "injury_cat_no_effect", color: "#D1FAE5", textColor: "var(--ink)" };
          } else if (poValue <= 20) {
              return { nameKey: "injury_cat_minor", color: "#FACC15", textColor: "var(--ink)" };
          } else if (poValue <= 30) {
              return { nameKey: "injury_cat_moderate", color: "#FDBA74", textColor: "var(--ink)" };
          } else if (poValue <= 50) {
              return { nameKey: "injury_cat_serious", color: "#FB7185", textColor: "#FFFFFF" };
          } else if (poValue <= 100) {
              return { nameKey: "injury_cat_severe", color: "#EF4444", textColor: "#FFFFFF" };
          } else { // > 100
              return { nameKey: "injury_cat_fatality", color: "#7F1D1D", textColor: "#FFFFFF" };
          }
      }

// GANTI FUNGSI LAMA DENGAN YANG INI
function updateEstimationPanels(PoCrowl, PoAlonso, PoSadovski, isAlonsoExtrapolated = false) {
  const methods = { crowl: PoCrowl, alonso: PoAlonso, sadovski: PoSadovski };

  Object.entries(methods).forEach(([method, Po]) => {
      const isPoValid = Number.isFinite(Po);
      const lang = translations[currentLanguage];
      
      const valPoEl = $(`val-Po-${method}`);
      const sevEl = $(`sev-${method}`);
      const structuralListEl = $(`structural-damage-${method}`);
      const equipmentListEl = $(`equipment-damage-${method}`);

      if (!valPoEl || !sevEl || !structuralListEl || !equipmentListEl) {
          console.error(`One or more elements for damage panel '${method}' not found.`);
          return;
      }
      
      if (!isPoValid) {
          valPoEl.textContent = '—';
          const impact = getImpactCategory(NaN);
          sevEl.textContent = lang[impact.nameKey] || impact.nameKey;
          sevEl.style.backgroundColor = impact.color;
          sevEl.style.color = impact.textColor;
          structuralListEl.innerHTML = `<li>${lang.awaiting_input}</li>`;
          equipmentListEl.innerHTML = `<li>${lang.awaiting_input}</li>`;
      } else {
          valPoEl.textContent = Po.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
          const impact = getImpactCategory(Po);
          sevEl.textContent = lang[impact.nameKey] || impact.nameKey;
          sevEl.style.backgroundColor = impact.color;
          sevEl.style.color = impact.textColor;
          
          const structuralKeys = getDamageDescriptionKeys(Po);
          const structuralRangeDesc = overpressureDamageLevels.find(range => Po >= range.minPo && Po < range.maxPo);
          let structuralHtml = structuralKeys.map(key => `<li>${(lang[key] || key).replace(/\[(\d+)\]/g, (match, p1) => `(${citations[p1]})`)}</li>`).join('');
          if (structuralRangeDesc) {
              structuralHtml += `<li>${(lang[structuralRangeDesc.descriptionKey] || structuralRangeDesc.descriptionKey)} (${citations[structuralRangeDesc.citation_ref]})</li>`;
          }
          structuralListEl.innerHTML = structuralHtml || `<li>${lang.damage_no_significant}</li>`;

          const equipmentDamage = processEquipmentDamage.slice().reverse().find(item => Po >= item.po);
          equipmentListEl.innerHTML = equipmentDamage ?
              `<li>${(lang[equipmentDamage.descriptionKey] || equipmentDamage.descriptionKey)} (${citations[equipmentDamage.citation_ref]})</li>` :
              `<li>${lang.equipment_no_significant}</li>`;
      }

      // --- MODIFIKASI DIMULAI: Logika untuk peringatan ekstrapolasi Crowl ---
      if (method === 'crowl') {
          const panelContentEl = $('panel-damage-crowl').querySelector('.pad');
          let existingWarning = panelContentEl.querySelector('.extrapolation-warning-crowl');
          
          if (existingWarning) existingWarning.remove();

          const zeValue = parseFloat($("Ze")?.value);
          const isCrowlExtrapolated = !isNaN(zeValue) && (zeValue < 0.01 || zeValue > 100);

          if (isCrowlExtrapolated && isPoValid) {
              const poValueParagraph = valPoEl.parentElement;
              if (poValueParagraph) {
                  const warningDiv = document.createElement('div');
                  warningDiv.className = 'extrapolation-warning-crowl'; 
                  warningDiv.style.cssText = 'color: var(--danger); font-weight: bold; font-style: italic; font-size: 13px; margin: 4px 0 10px;';
                  warningDiv.textContent = lang.crowl_warning; // Menggunakan kunci terjemahan
                  poValueParagraph.insertAdjacentElement('afterend', warningDiv);
              }
          }
      }
      // --- MODIFIKASI SELESAI ---

      // --- Logika untuk peringatan ekstrapolasi Alonso ---
      if (method === 'alonso') {
          const panelContentEl = $('panel-damage-alonso').querySelector('.pad');
          let existingWarning = panelContentEl.querySelector('.extrapolation-warning');
          
          if (existingWarning) existingWarning.remove();

          if (isAlonsoExtrapolated && isPoValid) {
              const poValueParagraph = valPoEl.parentElement; 
              if (poValueParagraph) {
                  const warningDiv = document.createElement('div');
                  warningDiv.className = 'extrapolation-warning';
                  warningDiv.style.cssText = 'color: var(--danger); font-weight: bold; font-style: italic; font-size: 13px; margin: 4px 0 10px;';
                  warningDiv.textContent = lang.alonso_warning;
                  poValueParagraph.insertAdjacentElement('afterend', warningDiv);
              }
          }
      }
      
      // --- Logika untuk peringatan ekstrapolasi Sadovski ---
      if (method === 'sadovski') {
          const panelContentEl = $('panel-damage-sadovski').querySelector('.pad');
          let existingWarning = panelContentEl.querySelector('.extrapolation-warning-sadovski');
          
          if (existingWarning) existingWarning.remove();

          const zeValue = parseFloat($("Ze")?.value);
          const isSadovskiExtrapolated = !isNaN(zeValue) && (zeValue < 1 || zeValue > 15);

          if (isSadovskiExtrapolated && isPoValid) {
              const poValueParagraph = valPoEl.parentElement;
              if (poValueParagraph) {
                  const warningDiv = document.createElement('div');
                  warningDiv.className = 'extrapolation-warning-sadovski'; 
                  warningDiv.style.cssText = 'color: var(--danger); font-weight: bold; font-style: italic; font-size: 13px; margin: 4px 0 10px;';
                  warningDiv.textContent = lang.sadovski_warning;
                  poValueParagraph.insertAdjacentElement('afterend', warningDiv);
              }
          }
      }
  });
}
     
// GANTI FUNGSI LAMA DENGAN YANG INI
function getInjuryEffects(Po) {
  const poValue = parseFloat(Po);
  if (isNaN(poValue) || poValue < 0) {
    return {
      primaryKey: "injury_awaiting_input",
      secondaryKey: null,
      conclusionKey: null
    };
  }

  // Logika baru berdasarkan tabel
  if (poValue < 20) {
    return {
      primaryKey: "injury_table_p1",
      secondaryKey: "injury_table_s1",
      conclusionKey: "injury_table_c1"
    };
  } else if (poValue <= 30) { // Rentang 20-30
    return {
      primaryKey: "injury_table_p2",
      secondaryKey: "injury_table_s2",
      conclusionKey: "injury_table_c2"
    };
  } else if (poValue <= 50) { // Rentang 30-50
    return {
      primaryKey: "injury_table_p3",
      secondaryKey: "injury_table_s3",
      conclusionKey: "injury_table_c3"
    };
  } else if (poValue <= 100) { // Rentang 50-100
    return {
      primaryKey: "injury_table_p4",
      secondaryKey: "injury_table_s4",
      conclusionKey: "injury_table_c4"
    };
  } else { // Rentang > 100
    return {
      primaryKey: "injury_table_p5",
      secondaryKey: "injury_table_s5",
      conclusionKey: "injury_table_c5"
    };
  }
}

// GANTI FUNGSI LAMA DENGAN YANG INI
function updateInjuryPanels(PoCrowl, PoAlonso, PoSadovski, isAlonsoExtrapolated = false) {
  const updateSinglePanel = (method, Po) => {
      const isPoValid = Number.isFinite(Po);
      const lang = translations[currentLanguage];

      const valPoEl = $(`val-Po-${method}-inj`);
      const effectsListEl = $(`injury-effects-${method}`);
      const sevFootEl = $(`sev-injury-${method}`);

      if (!valPoEl || !effectsListEl || !sevFootEl) {
          console.error(`One or more injury elements for method '${method}' not found.`);
          return;
      }
      
      const severity = getInjuryRiskCategory(Po);
      sevFootEl.textContent = lang[severity.nameKey] || severity.nameKey;
      sevFootEl.style.backgroundColor = severity.color;
      sevFootEl.style.color = severity.textColor;
      
      if (!isPoValid) {
          valPoEl.textContent = "—";
          effectsListEl.innerHTML = `<li>${lang.awaiting_input}</li>`;
      } else {
          valPoEl.textContent = Po.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
          
          const effectKeys = getInjuryEffects(Po);
          let html = '';

          // FUNGSI HELPER UNTUK MENGGANTI SITASI
          const processText = (key) => {
            if (!key) return '';
            const text = lang[key] || key;
            // Ini adalah baris kunci yang mencari [angka] dan menggantinya
            return text.replace(/\[(\d+)\]/g, (match, citationKey) => {
              return citations[citationKey] ? ` (${citations[citationKey]})` : match;
            });
          };
          
          if (effectKeys.primaryKey) {
              html += `<li><strong>${lang.primary_effects_label}</strong> ${processText(effectKeys.primaryKey)}</li>`;
          }
          if (effectKeys.secondaryKey) {
              html += `<li><strong>${lang.secondary_tertiary_effects_label}</strong> ${processText(effectKeys.secondaryKey)}</li>`;
          }
          if (effectKeys.conclusionKey) {
              html += `<li><strong>${lang.conclusion_label}</strong> ${processText(effectKeys.conclusionKey)}</li>`;
          }

          effectsListEl.innerHTML = html || `<li>${lang.injury_no_significant_effects}</li>`;
      }

      // --- Logika untuk peringatan ekstrapolasi (TIDAK BERUBAH) ---
      if (method === 'crowl') {
          const panelContentEl = $('panel-injury-crowl').querySelector('.pad');
          let existingWarning = panelContentEl.querySelector('.extrapolation-warning-crowl-inj');

          if (existingWarning) existingWarning.remove();

          const zeValue = parseFloat($("Ze")?.value);
          const isCrowlExtrapolated = !isNaN(zeValue) && (zeValue < 0.01 || zeValue > 100);

          if (isCrowlExtrapolated && isPoValid) {
              const poValueParagraph = valPoEl.parentElement;
              if (poValueParagraph) {
                  const warningDiv = document.createElement('div');
                  warningDiv.className = 'extrapolation-warning-crowl-inj';
                  warningDiv.style.cssText = 'color: var(--danger); font-weight: bold; font-style: italic; font-size: 13px; margin: 4px 0 10px;';
                  warningDiv.textContent = lang.crowl_warning;
                  poValueParagraph.insertAdjacentElement('afterend', warningDiv);
              }
          }
      }
      
      if (method === 'alonso') {
          const panelContentEl = $('panel-injury-alonso').querySelector('.pad');
          let existingWarning = panelContentEl.querySelector('.extrapolation-warning');

          if (existingWarning) existingWarning.remove();
          
          if (isAlonsoExtrapolated && isPoValid) {
              const poValueParagraph = valPoEl.parentElement;
              if (poValueParagraph) {
                  const warningDiv = document.createElement('div');
                  warningDiv.className = 'extrapolation-warning';
                  warningDiv.style.cssText = 'color: var(--danger); font-weight: bold; font-style: italic; font-size: 13px; margin: 4px 0 10px;';
                  warningDiv.textContent = lang.alonso_warning;
                  poValueParagraph.insertAdjacentElement('afterend', warningDiv);
              }
          }
      }
      
      if (method === 'sadovski') {
          const panelContentEl = $('panel-injury-sadovski').querySelector('.pad');
          let existingWarning = panelContentEl.querySelector('.extrapolation-warning-sadovski-inj');

          if (existingWarning) existingWarning.remove();

          const zeValue = parseFloat($("Ze")?.value);
          const isSadovskiExtrapolated = !isNaN(zeValue) && (zeValue < 1 || zeValue > 15);

          if (isSadovskiExtrapolated && isPoValid) {
              const poValueParagraph = valPoEl.parentElement;
              if (poValueParagraph) {
                  const warningDiv = document.createElement('div');
                  warningDiv.className = 'extrapolation-warning-sadovski-inj';
                  warningDiv.style.cssText = 'color: var(--danger); font-weight: bold; font-style: italic; font-size: 13px; margin: 4px 0 10px;';
                  warningDiv.textContent = lang.sadovski_warning;
                  poValueParagraph.insertAdjacentElement('afterend', warningDiv);
              }
          }
      }
  };

  updateSinglePanel('crowl', PoCrowl);
  updateSinglePanel('alonso', PoAlonso);
  updateSinglePanel('sadovski', PoSadovski);
}

      function calculateValues(isInitialLoad = false) {
        const btnSaveFloat = $('btnSaveResultFloat');
        const btnAddResult = $('btnAddResult');
        fields.forEach(id => $(id)?.classList.remove('input-error'));
        let hasError = false;
        const getFloat = (id) => {
          const el = $(id);
          const val = parseFloat(el.value);
          if (isNaN(val)) { el.classList.add('input-error'); hasError = true; }
          return val;
        };
        const [rho, vol, dh, eta, e_tnt, dist, pa] = fields.map(getFloat);

        if (!(eta >= 0 && eta <= 1)) { $('eta').classList.add('input-error'); hasError = true; }
        if (!(e_tnt > 0)) { $('e_tnt').classList.add('input-error'); hasError = true; }

        const resetAll = (msgKey) => {
          ["W_mass", "E_total", "W_tnt", "Ze", "Ps", "Po_crowl", "Po_alonso", "Po_sadovski"].forEach(id => $(id).value = "");
          showStatusMessage(msgKey, true);
          updateEstimationPanels(NaN, NaN, NaN);
          updateInjuryPanels(NaN, NaN, NaN);
          updateFloatingPanelOutputs(NaN, NaN, NaN, false);
          updatePsVsZeChart(); // Clear chart
          if (btnSaveFloat) btnSaveFloat.disabled = true;
          if (btnAddResult) btnAddResult.disabled = true;
        };

        if (hasError) return resetAll("status_error_range");

        const W_mass = rho * vol;
        const E_total = W_mass * dh * eta;
        const W_tnt = E_total / e_tnt;
        const Ze = dist > 0 && W_tnt > 0 ? dist / Math.cbrt(W_tnt) : NaN;

        if (!Number.isFinite(Ze) || Ze <= 0) return resetAll("status_error_invalid_ze");

        $("W_mass").value = W_mass.toFixed(3);
        $("E_total").value = E_total.toFixed(3);
        $("W_tnt").value = W_tnt.toFixed(3);
        $("Ze").value = Ze.toFixed(3);

        const PoPa_crowl = (1616 * (1 + (Ze/4.5)**2)) /
          (Math.sqrt(1 + (Ze/0.048)**2) * Math.sqrt(1 + (Ze/0.32)**2) * Math.sqrt(1 + (Ze/1.35)**2));
        $("Ps").value = PoPa_crowl.toFixed(3);
        
        const Po_crowl = PoPa_crowl * pa;
        const isAlonsoExtrapolated = Ze < 1 || Ze > 200; // This line already exists
        const Po_alonso = ((z) => {
            if (z < 10) return 1.13e6 * z**-2.01;
            return 1.83e5 * z**-1.16;
        })(Ze) / 1000;
       
        const Po_sadovski = ((w, d) => {
            if (!(d > 0 && w > 0)) return NaN;
            const r = Math.cbrt(w) / d;
            return (0.085 * r + 0.3 * r**2 + 0.8 * r**3) * 1000;
        })(W_tnt, dist);

        $("Po_crowl").value = Po_crowl.toFixed(3);
        $("Po_alonso").value = isNaN(Po_alonso) ? "" : Po_alonso.toFixed(3);
        $("Po_sadovski").value = isNaN(Po_sadovski) ? "" : Po_sadovski.toFixed(3);

        updateEstimationPanels(Po_crowl, Po_alonso, Po_sadovski, isAlonsoExtrapolated);
        // MODIFICATION: Add 'isAlonsoExtrapolated' as the fourth argument here
        updateInjuryPanels(Po_crowl, Po_alonso, Po_sadovski, isAlonsoExtrapolated);
        updateFloatingPanelOutputs(Po_crowl, Po_alonso, Po_sadovski, true);
        updatePsVsZeChart(); // Update chart with new calculation

        showStatusMessage("status_success");
        if (btnSaveFloat) btnSaveFloat.disabled = false;
        if (btnAddResult) btnAddResult.disabled = false;

        if (!isInitialLoad) {
          //saveStateToURL();
        }
      }

      function compute(isInitialLoad = false) {
        if ($("pa").value === "" || isNaN(parseFloat($("pa").value))) $("pa").value = "101.325";
        calculateValues(isInitialLoad);
      }

      function renderEquation(material) {
        const box = $("eq-text"); if (!box) return;
        if (!material || !eqMap[material]) { 
            box.innerHTML = translations[currentLanguage].eq_panel_placeholder; 
            return; 
        }
        box.innerHTML = eqMap[material].map(item => `<div class="rxn"><small>${translations[currentLanguage][item.labelKey]}</small><div class="rxn-eq">${item.eq}</div></div>`).join("");
      }

      function saveStateToURL() {
        try {
          const params = new URLSearchParams();
          inputFields.forEach(id => {
            const el = $(id);
            if (el && el.value !== undefined && el.value !== "") params.set(id, el.value);
          });
          const q = params.toString();
          const url = q ? `${window.location.pathname}?${q}` : window.location.pathname;
          window.history.replaceState({}, '', url);
        } catch (error) {
          console.warn("Could not save state to URL:", error.message);
        }
      }

      function loadStateFromURL() {
        // Hapus semua logika URL, kita fokus ke localStorage
        let stateLoaded = false;
        try {
          const savedStateJSON = localStorage.getItem('explosionSimState');
          if (savedStateJSON) {
            const savedState = JSON.parse(savedStateJSON);
            
            // Langkah 1: Isi form dari localStorage
            inputFields.forEach(id => {
              if (savedState[id] !== undefined) {
                const el = $(id);
                if (el) el.value = savedState[id];
              }
            });
            stateLoaded = true;
          }
        } catch (error) {
          console.error("Gagal memuat state dari localStorage:", error);
          localStorage.removeItem('explosionSimState');
        }

        // Langkah 2: Jika tidak ada state tersimpan (pengguna baru), muat default Beirut
        if (!stateLoaded) {
          if (simulationLog.length > 0) {
            const firstLog = simulationLog[0]; // Ini adalah data Beirut node 1
            const materialValue = Array.from($('material').options).find(opt => 
                (materialAbbreviationMap[opt.text] || opt.value) === firstLog.material
            )?.value;

            if (materialValue) {
              const materialSelect = $('material');
              materialSelect.value = materialValue;
              
              // Penting: Panggil 'change' untuk memuat preset (rho, dh, dll)
              materialSelect.dispatchEvent(new Event('change'));
              
              // Setelah preset dimuat, baru kita timpa vol & dist sesuai data log
              $('vol').value = firstLog.vol;
              $('dist').value = firstLog.dist;
            }
          }
        }

        renderEquation($('material').value);
        compute(true);
        syncFloatingPanelInputs();
      }
     
      function renderLogTable() {
        const logTbody = $('logTbody');
        if (!logTbody) return;

        logTbody.innerHTML = ''; 

        if (simulationLog.length === 0) {
            logTbody.innerHTML = `<tr class="log-placeholder"><td colspan="18">${translations[currentLanguage].log_placeholder}</td></tr>`;
            return;
        }

        simulationLog.forEach((log, index) => {
            const row = document.createElement('tr');
            if (log.isNew) {
              row.classList.add('new-row-animation');
              delete log.isNew;
            }
            row.innerHTML = `
                <td data-label="${translations[currentLanguage].log_col_node}">${index + 1}</td>
                <td data-label="${translations[currentLanguage].log_col_material}">${log.material}</td>
                <td data-label="ηE">${log.eta}</td>
                <td data-label="ETNT (kJ/kg)">${log.e_tnt}</td>
                <td data-label="ρ (kg/m³)">${log.rho}</td>
                <td data-label="ΔHexp (kJ/kg)">${log.dh}</td>
                <td data-label="${translations[currentLanguage].log_col_volume} (m³)">${log.vol}</td>
                <td data-label="${translations[currentLanguage].log_col_distance} (m)">${log.dist}</td>
                <td data-label="WTNT (kg)">${log.w_tnt}</td>
                <td data-label="ze">${log.ze}</td>
                <td data-label="Ps">${log.ps}</td>
                <td data-label="Crowl (kPa)">${log.po_crowl}</td>
                <td data-label="Alonso (kPa)">${log.po_alonso}</td>
                <td data-label="Sadovski (kPa)">${log.po_sadovski}</td>
                <td data-label="Lat">${log.lat}</td>
                <td data-label="Lon">${log.lon}</td>
                <td data-label="Po Model">${log.poModel}</td>
                <td class="col-action">
                    <button class="btn-delete" data-index="${index}" title="Delete this line">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </td>
            `;
            logTbody.appendChild(row);
        });
        
        updatePsVsZeChart(); // Update chart whenever the log table is re-rendered
      }

      function saveLogToLocalStorage() {
        try {
          if(simulationLog.length > 0) {
            localStorage.setItem('explosionSimLog', JSON.stringify(simulationLog));
          } else {
            localStorage.removeItem('explosionSimLog');
          }
        } catch (e) {
          console.warn("Could not save simulation log to local storage:", e);
        }
      }

      function loadLog() {
        const savedLog = localStorage.getItem('explosionSimLog');
        if (savedLog) {
            try {
                const parsedLog = JSON.parse(savedLog);
                if (Array.isArray(parsedLog) && parsedLog.length > 0) {
                    simulationLog = parsedLog;
                    return;
                }
            } catch (e) {
                console.error("Failed to load log from local storage:", e);
            }
        }
        // Fallback to the default scenario (Beirut)
        simulationLog = [...simulationScenarios.beirut.data]; 
      }     
      const toTopBtn = $('toTop');
      if (toTopBtn) {
        window.addEventListener('scroll', () => {
          if (window.scrollY > 200) {
            toTopBtn.classList.add('show');
          } else {
            toTopBtn.classList.remove('show');
          }
        });
      }

      const dropdown = document.querySelector('.dropdown-menu');
      // Pastikan elemen dropdown ada sebelum menambahkan event listener
      if (dropdown) {
        const dropdownToggle = dropdown.querySelector('.dropdown-toggle');

        // Event listener untuk tombol menu
        if (dropdownToggle) {
          dropdownToggle.addEventListener('click', (event) => {
            // Mencegah event klik menyebar ke elemen lain
            event.stopPropagation();
            // Toggle class 'is-active' untuk menampilkan atau menyembunyikan menu
            dropdown.classList.toggle('is-active');
          });
        }

        // Event listener pada dokumen untuk menutup menu saat klik di luar area menu
        document.addEventListener('click', (event) => {
          // Cek jika menu sedang aktif dan klik terjadi di luar area '.dropdown-menu'
          if (dropdown.classList.contains('is-active') && !dropdown.contains(event.target)) {
            dropdown.classList.remove('is-active');
          }
        });
      }
     
      function setupFloatingPanel() {
        const floatInputs = $('floatPanelInputs');
        const floatOutputs = $('floatPanelOutputs');
        const lang = translations[currentLanguage];
       
        floatInputs.innerHTML = `
          <div class="floating-group material">
            <label for="float_material" class="label">${lang.label_select_material}</label>
            <select id="float_material"></select>
          </div>
          <div class="floating-group volume">
            <label for="float_vol" class="label">${lang.label_volume}</label>
            <input id="float_vol" type="number" min="0" step="any" />
          </div>
          <div class="floating-group distance">
            <label for="float_dist" class="label">${lang.label_distance}</label>
            <input id="float_dist" type="number" min="0" step="any" />
          </div>
        `;

        floatOutputs.innerHTML = `
            <label class="label">${lang.float_overpressure_label}</label>
            <div class="output-values">
                <div class="floating-output-col"><span>Crowl</span><span id="float_po_crowl">—</span></div>
                <div class="floating-output-col"><span>Alonso</span><span id="float_po_alonso">—</span></div>
                <div class="floating-output-col"><span>Sadovski</span><span id="float_po_sadovski">—</span></div>
            </div>
            <div style="margin-top: 12px;">
                <button class="btn" id="btnSaveResultFloat" disabled style="width: 100%;">${lang.btn_add_result}</button>
            </div>
        `;
       
        const originalSelect = $('material');
        const floatSelect = $('float_material');
        floatSelect.innerHTML = originalSelect.innerHTML;
       
        const syncValues = (source, target) => {
            if (source.value !== target.value) {
                target.value = source.value;
                const changeEvent = new Event('change', { bubbles: true });
                const inputEvent = new Event('input', { bubbles: true });
                target.dispatchEvent(changeEvent);
                target.dispatchEvent(inputEvent);
            }
        };
       
        ['material', 'vol', 'dist'].forEach(id => {
            const original = $(id);
            const float = $(`float_${id}`);
           
            original.addEventListener('input', () => { if(float.value !== original.value) float.value = original.value; });
            original.addEventListener('change', () => { if(float.value !== original.value) float.value = original.value; });
           
            float.addEventListener('input', () => syncValues(float, original));
            float.addEventListener('change', () => syncValues(float, original));
        });
      }

      function syncFloatingPanelInputs() {
        $('float_material').value = $('material').value;
        $('float_vol').value = $('vol').value;
        $('float_dist').value = $('dist').value;
      }

      function updateFloatingPanelOutputs(crowl, alonso, sadovski, enabled) {
          const floatCrowl = $('float_po_crowl');
          const floatAlonso = $('float_po_alonso');
          const floatSadovski = $('float_po_sadovski');
          const btnSaveFloat = $('btnSaveResultFloat');
         
          if(floatCrowl) floatCrowl.textContent = isNaN(crowl) ? '—' : crowl.toFixed(3);
          if(floatAlonso) floatAlonso.textContent = isNaN(alonso) ? '—' : alonso.toFixed(3);
      if(floatSadovski) floatSadovski.textContent = isNaN(sadovski) ? '—' : sadovski.toFixed(3);
          if(btnSaveFloat) btnSaveFloat.disabled = !enabled;

      }

      function makeDraggable(panel, handle) {
          let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
          let isDragging = false;

          const dragStart = (e) => {
              if (panel.classList.contains('collapsed')) return;
              isDragging = true;
              panel.style.transition = 'none'; 
             
              const rect = panel.getBoundingClientRect();
              panel.style.width = rect.width + 'px';
              panel.style.left = rect.left + 'px';
              panel.style.transform = 'none';

              let currentEvent = e.type.startsWith('touch') ? e.touches[0] : e;
              pos3 = currentEvent.clientX;
              pos4 = currentEvent.clientY;
             
              document.addEventListener('mouseup', dragEnd);
              document.addEventListener('mousemove', elementDrag);
              document.addEventListener('touchend', dragEnd);
              document.addEventListener('touchmove', elementDrag, { passive: false });
              document.body.classList.add('dragging');
          };
         
          handle.addEventListener('mousedown', dragStart);
          // BUG FIX: Pindahkan event listener 'touchstart' ke luar dari fungsi 'dragStart'
          // untuk mencegah penambahan listener berulang kali (memory leak).
          handle.addEventListener('touchstart', dragStart, { passive: false });

          function elementDrag(e) {
              if (!isDragging) return;
              if (e.type === 'touchmove') e.preventDefault();
             
              let currentEvent = e.type.startsWith('touch') ? e.touches[0] : e;
              if (!currentEvent.clientX) return; 
             
              pos1 = pos3 - currentEvent.clientX;
              pos2 = pos4 - currentEvent.clientY;
              pos3 = currentEvent.clientX;
              pos4 = currentEvent.clientY;
             
              panel.style.top = (panel.offsetTop - pos2) + "px";
              panel.style.left = (panel.offsetLeft - pos1) + "px";
              panel.style.bottom = 'auto'; 
          }

          function dragEnd() {
              if (!isDragging) return;
              isDragging = false;
              panel.style.transition = '';
              panel.style.width = ''; // Reset width to be responsive
              document.removeEventListener('mouseup', dragEnd);
              document.removeEventListener('mousemove', elementDrag);
              document.removeEventListener('touchend', dragEnd);
              document.removeEventListener('touchmove', elementDrag);
              document.body.classList.remove('dragging');
          }
      }
     
      const floatingPanel = $('floatingControlPanel');
      makeDraggable(floatingPanel, floatingPanel.querySelector('.floating-panel-header'));
     
      // --- FINAL ROBUSTNESS CHECK FOR CHART LIBRARIES ---
      if (typeof echarts !== 'undefined') {
        chartController = initializeChart();
      } else {
        console.error("ECharts library failed to load.");
        const chartContainer = $('chart');
        if (chartContainer) chartContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--danger);">Failed to load Ps vs ze chart library. Please check your internet connection.</p>';
      }

      if (typeof Chart !== 'undefined') {
        overpressureChartController = initializeOverpressureChart();
      } else {
        console.error("Chart.js library failed to load.");
        const overpressureChartContainer = $('overpressureChart');
        if (overpressureChartContainer) overpressureChartContainer.parentElement.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--danger);">Failed to load Po vs Distance chart library. Please check your internet connection.</p>';
      }
      
      let isInitializing = true; // Tambahkan penanda (flag) global ini

      const debouncedCompute = debounce(() => compute(false), 250);
     
      inputFields.forEach(id => {
        const el = $(id);
        if (el && el.tagName === 'INPUT') {
          el.addEventListener("input", () => {
            // Tambahkan pengecekan ini:
            // Hanya jalankan kalkulasi jika proses inisialisasi sudah selesai.
            if (!isInitializing) {
              debouncedCompute();
            }
          });
        }
      });
     
      const materialSel = $("material");
      materialSel.addEventListener("change", () => {
        const p = presets[materialSel.value];
        if (p) Object.keys(p).forEach(key => $(key).value = p[key]);
        renderEquation(materialSel.value);
        showStatusMessage("status_loaded_defaults");
        compute(false);
      });

      materialSel.addEventListener("init-load", () => {
        const p = presets[materialSel.value];
        if (p) Object.keys(p).forEach(key => $(key).value = p[key]);
        renderEquation(materialSel.value);
        compute(true);
      });

      const saveAction = () => {
        const btnSaveFloat = $('btnSaveResultFloat');
        const btnAddResult = $('btnAddResult');
        if (btnSaveFloat.disabled && btnAddResult.disabled) return;
       
        const selectedOption = materialSel.options[materialSel.selectedIndex];
        const newLogEntry = {
            material: materialAbbreviationMap[selectedOption.text] || selectedOption.text,
            eta: $('eta').value,
            e_tnt: $('e_tnt').value,
            rho: $('rho').value,
            dh: $('dh').value,
            vol: $('vol').value,
            dist: $('dist').value,
            w_tnt: $('W_tnt').value,
            ze: $('Ze').value,
            ps: $('Ps').value,
            po_crowl: $('Po_crowl').value || 'N/A',
            po_alonso: $('Po_alonso').value || 'N/A',
            po_sadovski: $('Po_sadovski').value || 'N/A',
            lat: $('mapLat').value,
            lon: $('mapLon').value,
            poModel: $('poModelSelect').value,
            isNew: true
        };

        if (JSON.stringify(simulationLog) === JSON.stringify(simulationScenarios)) {
            simulationLog = [];
        }

        simulationLog.unshift(newLogEntry);

        if (simulationLog.length > 10) {
            simulationLog.pop(); 
        }

        renderLogTable();
        updateOverpressureChartFromLog();
        saveLogToLocalStorage();
        showStatusMessage('status_log_saved'); // Memberikan umpan balik yang jelas kepada pengguna
      };
     
      const btnAddResult = $('btnAddResult');
      if(btnAddResult) btnAddResult.addEventListener('click', saveAction);

      // Atur event listener untuk panel melayang di sini untuk mencegah penambahan ganda.
      // Menggunakan delegasi event, sehingga listener tetap berfungsi bahkan jika tombol di dalamnya dibuat ulang.
      const floatingPanelForEvent = $('floatingControlPanel');
      if(floatingPanelForEvent) {
        floatingPanelForEvent.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'btnSaveResultFloat') {
                saveAction();
            }
        });
      }

      const logTbody = $('logTbody');

      // *** MODIFICATION START ***
      // Fungsi ini akan dipanggil oleh handleLogRowClick untuk menampilkan popup.
      function showMapPopupForLog(logData) {
        // Memastikan peta dan fungsi-fungsi yang diperlukan tersedia di objek window.
        // Variabel-variabel ini diekspos oleh skrip peta (di blok window.load).
        if (typeof window.map === 'undefined' || typeof window.destPoint === 'undefined') {
          console.error("Objek peta (map) atau fungsi destPoint tidak tersedia. Pastikan skrip peta telah dimuat.");
          return;
        }

        const lat = parseFloat(logData.lat);
        const lon = parseFloat(logData.lon);
        const radius = parseFloat(logData.dist);

        if (isNaN(lat) || isNaN(lon) || isNaN(radius)) return;

        // Pilih nilai Po berdasarkan model yang aktif di peta.
        const poModelSelect = $('poModelSelect');
        const selectedModel = poModelSelect ? poModelSelect.value : 'crowl';
        const modelKeyMap = {
            crowl: 'po_crowl',
            alonso: 'po_alonso',
            sadovski: 'po_sadovski'
        };
        const poKey = modelKeyMap[selectedModel];
        const poValue = logData[poKey] ? parseFloat(logData[poKey]).toFixed(3) : 'N/A';

        // Konten popup.
        const popupContent = `<b>r = ${radius} m</b><br>Po: ${poValue}`;

        // Hitung posisi untuk popup di tepi lingkaran (misalnya, arah timur laut).
        const popupLatLng = window.destPoint(lat, lon, radius, 45); // 45 derajat bearing

        // Buka popup di peta. Leaflet akan menangani penutupan popup yang sudah ada.
        window.map.openPopup(popupContent, popupLatLng);
      }

      // Fungsi yang diperbarui untuk menangani klik pada baris log
      function handleLogRowClick(event) {
        const row = event.target.closest('tr');
        // Abaikan klik jika bukan pada baris data atau jika pada tombol hapus
        if (!row || row.classList.contains('log-placeholder') || event.target.closest('.btn-delete')) {
            return;
        }
        
        const deleteButton = row.querySelector('.btn-delete');
        if (!deleteButton) return;
        
        const index = parseInt(deleteButton.dataset.index, 10);
        if (isNaN(index) || !simulationLog[index]) return;

        // 1. Ambil data dari array simulationLog berdasarkan indeks
        const logData = simulationLog[index];
        
        // *** NEW FEATURE: Panggil fungsi untuk menampilkan popup di peta. ***
        showMapPopupForLog(logData);

        // 2. Perbarui nilai pada form input utama
        $('vol').value = logData.vol;
        $('dist').value = logData.dist;
        
        // Mengubah material sedikit lebih rumit karena perlu memicu event 'change'
        const materialSelect = $('material');
        // Temukan nilai <option> yang sesuai dengan singkatan material (misal: 'AN')
        const materialValue = Array.from(materialSelect.options).find(opt => 
            (materialAbbreviationMap[opt.text] || opt.value) === logData.material
        )?.value;

        if (materialValue && materialSelect.value !== materialValue) {
            materialSelect.value = materialValue;
            // 3. Memicu event 'change' secara manual untuk menjalankan semua logika terkait
            materialSelect.dispatchEvent(new Event('change'));
        } else {
            // Jika material tidak berubah, panggil `compute()` secara manual
            compute(true);
        }

        // 4. Atur sorotan visual pada baris yang dipilih
        document.querySelectorAll('#logTable tbody tr.selected-row').forEach(selectedRow => {
            selectedRow.classList.remove('selected-row');
        });
        row.classList.add('selected-row');

        // 5. Beri notifikasi kepada pengguna
        showStatusMessage(`Data dari log #${index + 1} telah dimuat ke kalkulator.`);
      }
      // *** MODIFICATION END ***

      // Tambahkan event listener ke <tbody>
      logTbody.addEventListener('click', handleLogRowClick);

      logTbody.addEventListener('click', (event) => {
        const deleteButton = event.target.closest('.btn-delete');
        if (deleteButton) {
            const indexToDelete = parseInt(deleteButton.dataset.index, 10);
            if (!isNaN(indexToDelete)) {
                simulationLog.splice(indexToDelete, 1);
                renderLogTable();
                updateOverpressureChartFromLog();
                saveLogToLocalStorage();
            }
        }
      });
     
      const btnSortLog = $('btnSortLog');
      btnSortLog.addEventListener('click', () => {
          if (simulationLog.length > 1) {
              simulationLog.sort((a, b) => parseFloat(a.dist) - parseFloat(b.dist));
              renderLogTable();
              updateOverpressureChartFromLog();
              saveLogToLocalStorage();
          }
      });
     
      const btnExportLog = $('btnExportLog');
      const btnImportLog = $('btnImportLog');
      const importFileInput = $('importFile');

      btnExportLog.addEventListener('click', () => {
          if (simulationLog.length === 0) {
              showStatusMessage('status_log_empty_export', true);
              return;
          }

          const headers = Object.keys(simulationLog[0]).filter(key => key !== 'isNew');
          
          const escapeCsvCell = (cell) => {
              const strCell = (cell === null || cell === undefined) ? '' : String(cell);
              if (/[",\n\r]/.test(strCell)) {
                  return `"${strCell.replace(/"/g, '""')}"`;
              }
              return strCell;
          };

          const csvRows = [headers.join(',')];

          simulationLog.forEach(log => {
              const values = headers.map(header => escapeCsvCell(log[header]));
              csvRows.push(values.join(','));
          });

          const csvString = csvRows.join('\n');
          const dataBlob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(dataBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'simulation-log.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showStatusMessage('status_export_success');
      });

      btnImportLog.addEventListener('click', () => {
          importFileInput.click();
      });

      importFileInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
              try {
                  const csv = e.target.result;
                  const lines = csv.split(/\r\n|\n/).filter(line => line.trim() !== '');
                  
                  let newLat, newLon, newPoModel;
                  const dataLines = lines.filter(line => {
                      if (line.startsWith('#')) {
                          const parts = line.substring(1).split(',');
                          if (parts.length >= 2) {
                              const key = `#${parts[0].trim()}`;
                              const value = parts[1].trim();
                              if (key === '#mapLat') newLat = parseFloat(value);
                              else if (key === '#mapLon') newLon = parseFloat(value);
                              else if (key === '#poModel') newPoModel = value;
                          }
                          return false;
                      }
                      return true;
                  });

                  if (typeof newLat === 'number' && !isNaN(newLat) && typeof newLon === 'number' && !isNaN(newLon)) {
                      settings.lat = newLat;
                      settings.lon = newLon;
                      savePartial({ lat: newLat, lon: newLon });
                      updateCoordInputs(); 
                      if (typeof map !== 'undefined' && map.setView) {
                          map.setView([newLat, newLon]);
                      }
                  }

                  if (newPoModel && ['crowl', 'alonso', 'sadovski'].includes(newPoModel)) {
                       const poModelSelect = document.getElementById('poModelSelect');
                       if(poModelSelect) poModelSelect.value = newPoModel;
                       settings.poModel = newPoModel;
                       savePartial({ poModel: newPoModel });
                  }

                  if (dataLines.length < 1) {
                      if (newLat !== undefined || newPoModel !== undefined) {
                          showStatusMessage('status_import_success');
                          simulationLog = [];
                      } else {
                          throw new Error(translations[currentLanguage].status_import_error_empty);
                      }
                  } else {
                    const headers = dataLines[0].split(',').map(h => h.trim());
                    const requiredHeaders = ['material', 'eta', 'e_tnt', 'rho', 'dh', 'vol', 'dist', 'w_tnt', 'ze', 'ps', 'po_crowl', 'po_alonso', 'po_sadovski', 'lat', 'lon', 'poModel'];
                    const missingHeaders = requiredHeaders.filter(rh => !headers.includes(rh));

                    if (missingHeaders.length > 0) {
                        throw new Error(`${translations[currentLanguage].status_import_error_missing_cols}${missingHeaders.join(', ')}`);
                    }

                    const importedData = [];
                    const numericalHeaders = ['eta', 'e_tnt', 'vol', 'dist', 'w_tnt', 'ze', 'ps'];
                    const poHeaders = ['po_crowl', 'po_alonso', 'po_sadovski'];

                    for (let i = 1; i < dataLines.length; i++) {
                        const rowNum = i + 1;
                        const values = dataLines[i].split(',').map(v => v.trim());
                        if (values.length !== headers.length) continue;

                        const logEntry = {};
                        for (let j = 0; j < headers.length; j++) {
                            const header = headers[j];
                            const value = values[j];

                            if (numericalHeaders.includes(header) && isNaN(parseFloat(value))) {
                                throw new Error(`Data tidak valid di baris ${rowNum} (kolom "${header}"). Harap masukkan angka yang valid.`);
                            }
                            if (poHeaders.includes(header) && isNaN(parseFloat(value)) && value.toUpperCase() !== 'N/A') {
                                throw new Error(`Data tidak valid di baris ${rowNum} (kolom "${header}"). Harap masukkan angka yang valid atau 'N/A'.`);
                            }
                            logEntry[header] = value;
                        }
                        importedData.push(logEntry);
                    }
                   
                    simulationLog = importedData.slice(0, 10);
                    showStatusMessage('status_import_success');
                  }

                  renderLogTable();
                  updateOverpressureChartFromLog();
                  saveLogToLocalStorage();

                  if (simulationLog.length > 0) {
                      try {
                          const firstLog = simulationLog[0];
                          const materialSelect = $('material');
                          
                          const findMaterialValue = (abbr) => {
                              const options = materialSelect.options;
                              for (let i = 0; i < options.length; i++) {
                                  if (materialAbbreviationMap[options[i].text.trim()] === abbr.trim()) {
                                      return options[i].value;
                                  }
                              }
                              return '';
                          };
                      
                          const materialValue = findMaterialValue(firstLog.material);
                          if (materialValue) {
                              materialSelect.value = materialValue;
                      
                              const p = presets[materialValue];
                              if (p) {
                                  Object.keys(p).forEach(key => {
                                      const el = $(key);
                                      if (el) el.value = p[key];
                                  });
                              }
                              renderEquation(materialValue);
                      
                              $('vol').value = firstLog.vol;
                              $('dist').value = firstLog.dist;
                      
                              compute(true);
                              
                              syncFloatingPanelInputs();
                          }
                      } catch (e) {
                          console.warn("Gagal memperbarui formulir utama dari CSV yang diimpor, tetapi log berhasil dimuat.", e);
                      }
                  }

              } catch (err) {
                  showStatusMessage('status_import_error', true, err.message);
              } finally {
                  importFileInput.value = '';
              }
          };
          reader.readAsText(file);
      });
     
      function setupCollapsePanel() {
        const panel = $('floatingControlPanel');
        const collapseBtn = $('floatPanelCollapseBtn');
        const header = panel.querySelector('.floating-panel-header');

        const setDockedPosition = () => {
            if (!materialCard) return;
            const materialCardRect = materialCard.getBoundingClientRect();
            let targetTop = Math.max(20, materialCardRect.top);
            panel.style.setProperty('--target-top', `${targetTop}px`);
        };

        collapseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isCollapsed = panel.classList.toggle('collapsed');
           
            if (isCollapsed) {
                const rect = panel.getBoundingClientRect();
                panel.style.setProperty('--target-top', `${rect.top}px`);
                panel.style.setProperty('--target-right', `${window.innerWidth - rect.right}px`);
            } else {
                panel.style.width = ''; // Reset width
            }
        });

        header.addEventListener('click', (e) => {
            if (panel.classList.contains('collapsed') && e.target !== collapseBtn && !collapseBtn.contains(e.target)) {
                panel.classList.remove('collapsed');
                panel.style.width = '';
            }
        });
       
        window.addEventListener('scroll', debounce(() => {
            if (panel.classList.contains('collapsed')) {
                setDockedPosition();
            }
        }, 100));

        window.addEventListener('resize', debounce(() => {
            if (panel.classList.contains('collapsed')) {
                const rect = panel.getBoundingClientRect();
                panel.style.setProperty('--target-right', `${window.innerWidth - rect.right}px`);
            }
        }, 100));
      }
     
      const materialCard = $('materialCard');
      function handlePanelVisibility() {
          if (!isPageLoaded) return; // Do not run until page has settled
          const floatingPanel = $('floatingControlPanel');
          if (!materialCard || !floatingPanel) return;
          const cardRect = materialCard.getBoundingClientRect();
          if (cardRect.bottom < 20) {
              syncFloatingPanelInputs();
              floatingPanel.classList.add('visible');
          } else {
              floatingPanel.classList.remove('visible');
          }
      }

      window.addEventListener('scroll', handlePanelVisibility);
     
      const updateOnResizeOrRotate = () => {
          handlePanelVisibility();
          const floatingPanel = $('floatingControlPanel');
          if (floatingPanel && !floatingPanel.classList.contains('collapsed')) {
              floatingPanel.style.width = '';
          }
      };

      const debouncedUpdateOnResizeOrRotate = debounce(updateOnResizeOrRotate, 150);
      window.addEventListener('resize', debouncedUpdateOnResizeOrRotate);
      window.addEventListener('orientationchange', debouncedUpdateOnResizeOrRotate);

      // =================== KODE BARU DIMULAI ===================
      function loadAndDisplayScenario(scenarioKey) {
          if (!simulationScenarios[scenarioKey]) return;

          // Ganti log saat ini dengan data skenario yang dipilih
          simulationLog = [...simulationScenarios[scenarioKey].data];

          // Perbarui semua elemen UI yang relevan
          renderLogTable();
          updateOverpressureChartFromLog();
          saveLogToLocalStorage();

          // Muat entri pertama dari skenario baru ke dalam kalkulator utama
          if (simulationLog.length > 0) {
              const firstLog = simulationLog[0];
              const materialSelect = $('material');
              const materialValue = firstLog.material; 
              const optionExists = Array.from(materialSelect.options).some(opt => opt.value === materialValue);

              if (optionExists) {
                  materialSelect.value = materialValue;
                  $('vol').value = firstLog.vol;
                  $('dist').value = firstLog.dist;
                  // Picu event 'change' agar kalkulator dan properti material ikut ter-update
                  materialSelect.dispatchEvent(new Event('change'));
              } else {
                  console.error(`Material "${materialValue}" dari data skenario tidak ditemukan di dropdown.`);
              }
          }
          // Panggil fungsi untuk menyorot baris pertama setelah tabel diperbarui
          highlightFirstRow();
      }

      function initializeSimulationState() {
          const selector = $('simulationSelector');
          // Coba dapatkan skenario terakhir yang dipilih dari localStorage
          const lastScenario = localStorage.getItem('lastSelectedScenario');

          if (lastScenario && simulationScenarios[lastScenario]) {
              // Jika skenario yang valid tersimpan, atur dropdown ke nilai tersebut
              selector.value = lastScenario;
              // Muat data untuk skenario yang tersimpan
              loadAndDisplayScenario(lastScenario);
          } else {
              // Jika tidak, ini adalah kunjungan pertama atau data tidak valid.
              // Atur dropdown ke skenario default 'beirut'
              selector.value = 'beirut';
              // Muat data untuk skenario default
              loadAndDisplayScenario('beirut');
          }
      }
      
      // Fungsi ini mengisi pilihan dropdown dan mengatur listener untuk menyimpan perubahan
      function populateSimulationSelector() {
          const selector = $('simulationSelector');
          if (!selector) return;

          selector.innerHTML = '';

          Object.keys(simulationScenarios).forEach(key => {
              const option = document.createElement('option');
              option.value = key;
              option.textContent = simulationScenarios[key].name;
              selector.appendChild(option);
          });

          selector.addEventListener('change', (event) => {
              const selectedScenarioKey = event.target.value;
              loadAndDisplayScenario(selectedScenarioKey);
              // Simpan kunci skenario yang dipilih ke localStorage setiap kali ada perubahan
              try {
                localStorage.setItem('lastSelectedScenario', selectedScenarioKey);
              } catch (e) {
                console.warn("Gagal menyimpan skenario terakhir ke localStorage:", e);
              }
          });
      }
      // =================== KODE BARU SELESAI ===================

      // --- INITIALIZATION SEQUENCE ---
      initLanguage(); 
      loadLogo();
      toTopBtn.addEventListener('click', goTop);
      populateSimulationSelector();
      initializeSimulationState(); // <-- Satu baris ini menggantikan pemanggilan loadLog() dan render...() yang lama
      loadStateFromURL();
      setupCollapsePanel(); 
      updatePsVsZeChart(); // Initial plot
      
      isInitializing = false;
     
      setTimeout(() => {
          isPageLoaded = true;
          handlePanelVisibility();
      }, 250);

    });

window.addEventListener('load', () => {
    // Periksa apakah pustaka Leaflet (objek 'L') telah berhasil dimuat.
    if (typeof L === 'undefined') {
        console.error("Pustaka Leaflet tidak dimuat. Peta tidak dapat diinisialisasi.");
        const mapContainer = document.getElementById('map');
        const mapCard = document.getElementById('mapCard');
        if (mapContainer) {
            mapContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--danger); font-weight: bold;">Kesalahan: Gagal memuat pustaka peta. Harap periksa koneksi internet Anda dan coba muat ulang halaman.</p>';
        }
        // Sembunyikan kontrol yang tidak relevan jika peta gagal dimuat
        const controls = document.getElementById('mapControls');
        if (controls) controls.style.display = 'none';
        if (mapCard) mapCard.style.backgroundColor = 'var(--bg)';
        return; // Hentikan eksekusi skrip peta
    }

    // ======= BUILT-IN DEFAULTS =======
    const BUILTIN_DEFAULTS = {
      lat: 33.901404, lon: 35.519039,
      csv: '', // Dihapus: Data sekarang akan selalu berasal dari simulationLog
      np: 90, iv: 250, os: 0.3, of: 0.2, sw: 0.3, pal: 'bright',
      showLabel: true,
      poModel: 'crowl'
    };
    const LS_KEY  = 'explosionContour:v1';
    const RG_KEY  = 'explosionContour:revgeo:v2';

    let notifTimer = null;
    function showNotification(message, isError = false){
        const el = document.getElementById('notification');
        el.textContent = message;
        el.className = 'notification'; // reset
        if (isError) el.classList.add('error');
        el.classList.add('show');
        if (notifTimer) clearTimeout(notifTimer);
        notifTimer = setTimeout(() => {
            el.classList.remove('show');
        }, 4000); 
    }

    // ======= QS read-only =======
    function b64urlToStr(b64u){
      try{
        const b64 = b64u.replace(/-/g,'+').replace(/_/g,'/') + '==='.slice(b64u.length%4);
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder().decode(bytes);
      }catch{ return ''; }
    }
    function readFromQS(){
      const sp = new URLSearchParams(location.search);
      if (!sp || [...sp].length===0) return {};
      const obj = {};
      if (sp.has('lat')) obj.lat = parseNumberLoose(sp.get('lat'));
      if (sp.has('lon')) obj.lon = parseNumberLoose(sp.get('lon'));
      if (sp.has('np'))  obj.np  = Math.max(16, Math.min(360, parseInt(sp.get('np'),10) || 0));
      if (sp.has('iv'))  obj.iv  = Math.max(0, parseInt(sp.get('iv'),10) || 0);
      if (sp.has('os'))  obj.os  = Math.max(0, Math.min(1, parseNumberLoose(sp.get('os'))));
      if (sp.has('of'))  obj.of  = Math.max(0, Math.min(1, parseNumberLoose(sp.get('of'))));
      if (sp.has('sw'))  obj.sw  = Math.max(0, parseNumberLoose(sp.get('sw')));
      if (sp.has('pal')) {
        const v = sp.get('pal').toLowerCase();
        if (['bright','cerah','default'].includes(v)) obj.pal = 'bright';
        else if (['bluegreen','biru-hijau','biru','hijau','bg'].includes(v)) obj.pal = 'bluegreen';
        else if (['heat','panas'].includes(v)) obj.pal = 'heat';
      }
      if (sp.has('label')) {
        const v = sp.get('label').toLowerCase();
        obj.showLabel = !(v==='0' || v==='false' || v==='no' || v==='off');
      }
      if (sp.has('csvb64')) { const s = b64urlToStr(sp.get('csvb64')||''); if (s) obj.csv = s; }
      else if (sp.has('csv')) { let v = sp.get('csv')||''; obj.csv = v.replace(/\|/g,'\n').replace(/;/g,'\n'); }
      return Object.fromEntries(Object.entries(obj).filter(([,v])=>v!==undefined && v!==null && v!==''));
    }

    // ======= localStorage =======
    function loadSaved(){
      try { const o = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); return (o && typeof o==='object') ? o : {}; }
      catch{ return {}; }
    }
    function savePartial(patch){
      settings = { ...settings, ...patch };
      try { 
        localStorage.setItem(LS_KEY, JSON.stringify(settings)); 
      } catch (e) {
        console.warn("Could not save map settings to local storage:", e);
      }
    }

    // ======= Compose settings (QS ➜ LS ➜ Built-in) =======
    let settings = { ...BUILTIN_DEFAULTS, ...loadSaved(), ...readFromQS() };

    // ======= Geodesic helpers =======
    const R_EARTH = 6371008.8; // m
    function destPoint(latDeg, lonDeg, distanceM, bearingDeg){
      const φ1 = latDeg * Math.PI/180, λ1 = lonDeg * Math.PI/180;
      const θ = bearingDeg * Math.PI/180, δ = distanceM / R_EARTH;
      const sinφ1 = Math.sin(φ1), cosφ1 = Math.cos(φ1);
      const sinδ = Math.sin(δ), cosδ = Math.cos(δ);
      const sinφ2 = sinφ1*cosδ + cosφ1*sinδ*Math.cos(θ);
      const φ2 = Math.asin(sinφ2);
      const y = Math.sin(θ)*sinδ*cosφ1, x = cosδ - sinφ1*sinφ2;
      let λ2 = λ1 + Math.atan2(y, x);
      λ2 = ((λ2 + 3*Math.PI) % (2*Math.PI)) - Math.PI;
      return [φ2 * 180/Math.PI, λ2 * 180/Math.PI];
    }
    window.destPoint = destPoint; // <-- TAMBAHKAN BARIS INI

    function circleCoordsGeodesic(lat0, lon0, Rm, n=90){
      const coords = [];
      for(let i=0;i<=n;i++){
        const bearing = 360 * i / n;
        const [lat, lon] = destPoint(lat0, lon0, Rm, bearing);
        coords.push([lat, lon]);
      }
      return coords;
    }

    // ======= Map init =======
    const map = L.map('map', {
      center:[settings.lat, settings.lon],
      zoom: 14,
      zoomControl: false
    });
    window.map = map; // <-- TAMBAHKAN BARIS INI

    const canvasRenderer = L.canvas({ padding: 0.3 });
    
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
      maxZoom:19, attribution:'Tiles © Esri'
    });

    satelliteLayer.on('tileerror', function(event) {
        console.error('Tile load error:', event);
        showNotification('Failed to load map data. Check your internet connection.', true);
        satelliteLayer.off('tileerror');
    });
    satelliteLayer.addTo(map);

    L.control.scale({imperial:false, position: 'bottomright'}).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const creditHTML =
      `<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a> · ` +
      `<span title="Author">Credit by <a href="https://id.linkedin.com/in/virdanurlulu" target="_blank" rel="nofollow noopener">Virda Nur Lu'lu</a></span>`;
    map.attributionControl.setPrefix(creditHTML);

    // ======= Palettes =======
    const palettes = {
      bright: ["#FF0000","#FFA500","#FFFF00","#00FF00","#00FFFF","#0000FF","#FF00FF","#800080","#FFC0CB","#A52A2A"],
      bluegreen: ["#203a8f","#2d6cdf","#3fb6ff","#27c3a4","#15a371","#0f7a54","#0b533b","#083b2c"],
      heat: ["#4b0d0d","#7a1f0e","#ad3510","#e65a0d","#ff8c00","#ffb200","#ffd000","#ffe680"]
    };

    // ======= Reverse Geocoding (Latin/EN, cache, fallback) =======
    function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function isRTL(str){ return /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/.test(str); }
    function rgKey(lat, lon){ return `${lat.toFixed(5)},${lon.toFixed(5)}`; }
    function rgLoadCache(){ try{ return JSON.parse(localStorage.getItem(RG_KEY)||'{}'); }catch{ return {}; } }
    function rgSaveCache(obj){ try{ localStorage.setItem(RG_KEY, JSON.stringify(obj)); }catch{} }

    let isProgrammaticMove = false; // Flag to prevent moveend recursion

    async function fetchNominatimEN(lat, lon){
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&namedetails=1&accept-language=en`;
      const r = await fetch(url, {headers:{'Accept':'application/json', 'User-Agent': 'ExplosionSim/1.0'}});
      if (!r.ok) throw new Error(`Nominatim request failed with status ${r.status}`);
      const j = await r.json();
      const a = j.address || {};
      const city = a.city || a.town;
      const country = a.country || '';
      const joined = [city, country].filter(Boolean).join(', ');
      return joined;
    }

    async function reverseGeocode(lat, lon){
      const key = rgKey(lat, lon);
      const cache = rgLoadCache();
      const TTL = 30*24*3600*1000; // 30 days
      if (cache[key] && (Date.now()-cache[key].ts) < TTL) return cache[key].name;

      let geocodeError = false;
      try{
        let name = await fetchNominatimEN(lat, lon);
        if (name && !isRTL(name)) {
          cache[key] = {name, ts: Date.now()}; rgSaveCache(cache);
          return name;
        }
      } catch(e) {
          console.error("Nominatim fetch failed:", e);
          geocodeError = true;
      }

      try{
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`);
        if (r.ok){
          const j = await r.json();
          if (j.results && j.results.length){
            const g = j.results[0];
            const name = [g.name, g.country].filter(Boolean).join(', ');
            if (name){
              cache[key] = {name, ts: Date.now()}; rgSaveCache(cache);
              return name;
            }
          }
        } else {
            throw new Error(`Open-Meteo request failed with status ${r.status}`);
        }
      } catch(e) {
          console.error("Open-Meteo fetch failed:", e);
          geocodeError = true;
      }

      if (geocodeError) {
          showNotification('Failed to get location name. Check your internet connection.', true);
      }
      return '';
    }

    let centerMarker = null;
    let placeName = '';
    let mapTitleEl = null;

    // ======= Heading updater =======
    function setHeading(name){
      const label = (name && name.trim()) ? name.trim() : `${settings.lat.toFixed(5)}, ${settings.lon.toFixed(5)}`;
      const txt = `Explosion Contour - ${label}`;
      document.title = txt;
      if (mapTitleEl) mapTitleEl.textContent = txt;
    }

    function _attachTooltipCloseHandler(tooltip) {
      if (!tooltip || !tooltip._container) return;
      const closeBtn = tooltip._container.querySelector('.placelabel-close');
      if (closeBtn) {
        L.DomEvent.on(closeBtn, 'click', (event) => {
          L.DomEvent.stop(event);
          if (centerMarker) centerMarker.closeTooltip();
        });
      }
    }

    function ensureCenterMarker(lat, lon, name){
      if (!centerMarker){
        centerMarker = L.circleMarker([lat, lon], {
          renderer: canvasRenderer, radius: 5,
          color:'#111', weight:1, fillColor:'#fff', fillOpacity:1
        }).addTo(map);

        centerMarker.on('tooltipopen', function (e) {
          _attachTooltipCloseHandler(e.tooltip);
        });
      } else {
        centerMarker.setLatLng([lat, lon]);
      }

      if (!settings.showLabel){
        if (centerMarker.getTooltip()) centerMarker.unbindTooltip();
        return;
      }

      const locationName = name ? esc(name) : `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      const labelContent = `<span class="placelabel-content">📍 ${locationName}</span><button class="placelabel-close" title="Close">×</button>`;
      
      const t = centerMarker.getTooltip();
      if (t) {
          t.setContent(labelContent);
          if (centerMarker.isTooltipOpen()) {
              _attachTooltipCloseHandler(t);
          }
      } else {
          centerMarker.bindTooltip(labelContent, {permanent:true, direction:'right', offset:[8,0], className:'placelabel'});
      }
      
      if (!centerMarker.isTooltipOpen()) {
          centerMarker.openTooltip();
      }
    }

    async function refreshPlaceName(lat, lon){
      placeName = await reverseGeocode(lat, lon);
      ensureCenterMarker(lat, lon, placeName);
      setHeading(placeName);
      if (!document.getElementById('legend').hidden) refreshLegend();
    }

    // ======= Animation =======
    const RESPECT_REDUCED_MOTION = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let rings = parseData(settings.csv);
    let tempLayers = [], finalLayer = null, idx = 0, playing = false, finished = false, timer = null;

    function clearLayers(){
      if (timer) { clearTimeout(timer); timer=null; }
      tempLayers.forEach(l=>map.removeLayer(l)); tempLayers=[];
      if (finalLayer){ map.removeLayer(finalLayer); finalLayer=null; }
      const toRemove = [];
      map.eachLayer(l=>{ if(l instanceof L.Polygon || l instanceof L.GeoJSON){ toRemove.push(l); } });
      toRemove.forEach(l=>map.removeLayer(l));
      document.getElementById('legend').hidden = true;
    }

    function refreshLegend(){
      const leg = document.getElementById('legend');
      leg.innerHTML = `<b>Explosion Contour</b>
        <div>Rings: ${rings.map(x=>x.r).join(', ')} m</div>`;
      leg.hidden = false;
    }
    
    function drawStep(){
      if (!playing) return;
      const ivUsed = RESPECT_REDUCED_MOTION ? 0 : Math.max(0, settings.iv|0);
      if (idx < rings.length){
        const d = rings[idx];
        const coords = circleCoordsGeodesic(settings.lat, settings.lon, d.r, settings.np);
        const pal = (palettes[settings.pal] || palettes.bright);
        const layer = L.polygon(coords, {
          renderer: canvasRenderer, color:"#000000", weight:settings.sw,
          fillColor: pal[idx % pal.length], fillOpacity: settings.os
        }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po}</code>`:''}`).addTo(map);
        tempLayers.push(layer);
        if (idx===0){ try{ map.setView([settings.lat, settings.lon], 14); }catch(e){} }
        idx++;
        timer = setTimeout(drawStep, ivUsed);
      } else {
        tempLayers.forEach(l=>map.removeLayer(l)); tempLayers=[];
        const pal = (palettes[settings.pal] || palettes.bright);
        const reversed = rings.slice().reverse();
        finalLayer = L.featureGroup(
          reversed.map((d, irev)=>{
            const coords = circleCoordsGeodesic(settings.lat, settings.lon, d.r, settings.np);
            return L.polygon(coords, {
              renderer: canvasRenderer, color:"#000000", weight:settings.sw,
              fillColor: pal[(rings.length-1-irev) % pal.length], fillOpacity: settings.of
            }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po}</code>`:''}`);
          })
        ).addTo(map);
        try{ map.fitBounds(finalLayer.getBounds(), {padding:[20,20]}); }catch(e){}
        refreshLegend();
        playing = false; finished = true; 
      }
    }

    function drawInitialState(){
      clearLayers();
      finished = true;
      playing = false;
      rings = parseData(settings.csv);
      
      const pal = (palettes[settings.pal] || palettes.bright);
      const reversed = rings.slice().reverse();
      finalLayer = L.featureGroup(
        reversed.map((d, irev)=>{
          const coords = circleCoordsGeodesic(settings.lat, settings.lon, d.r, settings.np);
          return L.polygon(coords, {
            renderer: canvasRenderer, color:"#000000", weight:settings.sw,
            fillColor: pal[(rings.length-1-irev) % pal.length], fillOpacity: settings.of
          }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po}</code>`:''}`);
          })
        ).addTo(map);
      try{ 
          if (finalLayer && finalLayer.getLayers().length > 0) {
              isProgrammaticMove = true;
              map.fitBounds(finalLayer.getBounds(), {padding:[20,20]}); 
          } else {
              isProgrammaticMove = true;
              map.setView([settings.lat, settings.lon], 14);
          }
      } catch(e){}
      
      if (rings.length > 0) {
          refreshLegend();
      } else {
          document.getElementById('legend').hidden = true;
          ensureCenterMarker(settings.lat, settings.lon, placeName);
      }
    }

    function play(){ if (finished){ replay(); return; } if (playing) return; playing = true; drawStep(); }
    function pause(){ playing = false; if (timer) { clearTimeout(timer); timer=null; } }
    function replay(){ pause(); clearLayers(); idx = 0; finished = false; rings = parseData(settings.csv); play(); }

    // ======= Fullscreen (desktop & mobile) =======
    const fsBtn = document.getElementById('fsBtn'),
          fsBtnMobile = document.getElementById('fsBtnMobile'),
          mapCard = document.getElementById('mapCard');

    function setFSLabel(on){
      const txt = on ? '⛶ Exit Fullscreen' : '⛶ Fullscreen';
      [fsBtn, fsBtnMobile].forEach(b=>{
        if(!b) return;
        b.textContent = txt;
        b.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }
    function enterFS(){
      mapCard.classList.add('fullscreen'); document.body.classList.add('fs-lock');
      if (mapCard.requestFullscreen) { mapCard.requestFullscreen().catch(()=>{}); }
      else if (mapCard.webkitRequestFullscreen) { mapCard.webkitRequestFullscreen(); }
      setFSLabel(true);
      setTimeout(()=>map.invalidateSize(), 180);
    }
    function exitFS(){
      mapCard.classList.remove('fullscreen'); document.body.classList.remove('fs-lock');
      if (document.fullscreenElement && document.exitFullscreen) { document.exitFullscreen().catch(()=>{}); }
      else if (document.webkitFullscreenElement && document.webkitCancelFullScreen) { document.webkitCancelFullScreen(); }
      setFSLabel(false);
      setTimeout(()=>map.invalidateSize(), 180);
    }
    function toggleFS(){ mapCard.classList.contains('fullscreen') ? exitFS() : enterFS(); }

    fsBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFS(); });
    fsBtnMobile?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFS(); });

    document.addEventListener('fullscreenchange', ()=>{
      const active = !!document.fullscreenElement || mapCard.classList.contains('fullscreen');
      if (!document.fullscreenElement) { mapCard.classList.remove('fullscreen'); document.body.classList.remove('fs-lock'); }
      setFSLabel(active);
    });

    window.addEventListener('resize', ()=>{
      if (mapCard.classList.contains('fullscreen')) {
        clearTimeout(window.__fsRaf);
        window.__fsRaf = setTimeout(()=>map.invalidateSize(), 120);
      }
    });
    
    // ======= Map Controls Logic =======
    const mapLatInput = document.getElementById('mapLat');
    const mapLonInput = document.getElementById('mapLon');
    const poModelSelect = document.getElementById('poModelSelect');

    function updateCoordInputs() {
        if (mapLatInput) mapLatInput.value = settings.lat.toFixed(6);
        if (mapLonInput) mapLonInput.value = settings.lon.toFixed(6);
    }

    const debouncedUpdateMapFromInput = debounce(() => {
        const latStr = mapLatInput.value.trim();
        const lonStr = mapLonInput.value.trim();

        if (latStr === '' && lonStr === '') {
            settings.lat = BUILTIN_DEFAULTS.lat;
            settings.lon = BUILTIN_DEFAULTS.lon;
            savePartial({ lat: settings.lat, lon: settings.lon });
            updateCoordInputs();
            isProgrammaticMove = true;
            map.setView([settings.lat, settings.lon]);
            refreshPlaceName(settings.lat, settings.lon).then(() => {
                drawInitialState();
            });
            showNotification('Coordinates reset to default.', false);
            return;
        }
        
        const lat = parseFloat(mapLatInput.value);
        const lon = parseFloat(mapLonInput.value);

        if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
            // Cek jika koordinat benar-benar berubah untuk menghindari pembaruan yang tidak perlu
            if (Math.abs(settings.lat - lat) > 1e-7 || Math.abs(settings.lon - lon) > 1e-7) {
                settings.lat = lat;
                settings.lon = lon;
                savePartial({ lat: lat, lon: lon });

                // Atur tampilan peta ke koordinat baru
                isProgrammaticMove = true; 
                map.setView([lat, lon]);

                // Muat ulang nama tempat dan gambar ulang semuanya di lokasi baru
                refreshPlaceName(lat, lon).then(() => {
                    drawInitialState();
                });
            }
        } else {
            showNotification('Invalid coordinate values.', true);
        }
    }, 750);
    
    if (mapLatInput) mapLatInput.addEventListener('input', debouncedUpdateMapFromInput);
    if (mapLonInput) mapLonInput.addEventListener('input', debouncedUpdateMapFromInput);
    if (poModelSelect) {
        poModelSelect.addEventListener('change', () => {
            settings.poModel = poModelSelect.value;
            savePartial({ poModel: poModelSelect.value });
            updateMapFromLog();
            updatePsVsZeChart(); // Update chart with new Po model selection
        });
    }

    // ======= Start =======
    (function init(){
      mapTitleEl = document.getElementById('mapTitle');
      setHeading(null); 
      refreshPlaceName(settings.lat, settings.lon);
      setFSLabel(false);
      updateCoordInputs();
      if (poModelSelect) poModelSelect.value = settings.poModel;
      // Memanggil updateMapFromLog() di sini untuk memastikan peta melakukan sinkronisasi dengan
      // data log yang sudah dimuat saat halaman pertama kali dibuka.
      updateMapFromLog(); 
    })();

    // Listen for custom events from the other script for CSV import
    window.addEventListener('map:updateCoords', (e) => {
        const { lat, lon } = e.detail;
        settings.lat = lat;
        settings.lon = lon;
        savePartial({ lat, lon });
        updateCoordInputs();
        isProgrammaticMove = true;
        map.setView([lat, lon]);
        refreshPlaceName(lat, lon).then(() => {
            drawInitialState();
        });
    });

    window.addEventListener('map:updatePoModel', (e) => {
        const { model } = e.detail;
        settings.poModel = model;
        if(poModelSelect) poModelSelect.value = model;
        savePartial({ poModel: model });
        updateMapFromLog(); // Redraw map with new model selection
    });

    async function updateMapFromLog() {
      if (typeof simulationLog === 'undefined' || !Array.isArray(simulationLog)) {
        console.error("simulationLog array not found or not an array.");
        return;
      }

      // Secara otomatis menyinkronkan kontrol peta dengan entri pertama dalam log simulasi.
      if (simulationLog.length > 0) {
          const firstLog = simulationLog[0];
          const lat = parseFloat(firstLog.lat);
          const lon = parseFloat(firstLog.lon);
          const poModel = firstLog.poModel;
          let settingsChanged = false;

          // Menyinkronkan koordinat
          if (!isNaN(lat) && !isNaN(lon)) {
              if (settings.lat !== lat || settings.lon !== lon) {
                  settings.lat = lat;
                  settings.lon = lon;
                  settingsChanged = true;
              }
              updateCoordInputs(); // Fungsi ini memperbarui bidang input
          }

          // Menyinkronkan Po Model
          const poModelSelect = document.getElementById('poModelSelect');
          if (poModel && poModelSelect && settings.poModel !== poModel) {
              settings.poModel = poModel;
              poModelSelect.value = poModel; // Memperbarui UI dropdown
              settingsChanged = true;
          }
          
          if (settingsChanged) {
              savePartial({ lat: settings.lat, lon: settings.lon, poModel: settings.poModel });
          }
      }

      await refreshPlaceName(settings.lat, settings.lon);

      const poModelSelect = document.getElementById('poModelSelect');
      const selectedModel = poModelSelect ? poModelSelect.value : (settings.poModel || 'crowl');
      const modelKeyMap = {
          crowl: 'po_crowl',
          alonso: 'po_alonso',
          sadovski: 'po_sadovski'
      };
      const pressureKey = modelKeyMap[selectedModel] || 'po_crowl';

      const csvLines = simulationLog.map(logEntry => {
          const distance = parseFloat(logEntry.dist);
          if (!isNaN(distance) && distance > 0) {
              const pressure = logEntry[pressureKey] ? parseFloat(logEntry[pressureKey]) : NaN;
              // Format CSV line: "distance, pressure". Pressure is optional.
              return isNaN(pressure) ? `${distance}` : `${distance}, ${pressure}`;
          }
          return null; // Return null for invalid entries
      }).filter(Boolean); // Filter out null values

      const newCsv = csvLines.join('\n');
      
      if (newCsv !== settings.csv || (newCsv && !finalLayer)) {
          settings.csv = newCsv;
          
          if (csvLines.length === 0) {
              rings = []; // Clear ring data
              clearLayers(); // Remove all layers from the map
              ensureCenterMarker(settings.lat, settings.lon, placeName); // Redraw the center marker
          } else {
              drawInitialState();
          }
      }
    }

    const logTbodyObserver = document.getElementById('logTbody');
    if (logTbodyObserver) {
        const observer = new MutationObserver(() => {
            // Gunakan debounce untuk menunda eksekusi agar tidak berjalan berkali-kali
            clearTimeout(window.logUpdateTimeout);
            window.logUpdateTimeout = setTimeout(updateMapFromLog, 250);
        });
        observer.observe(logTbodyObserver, { childList: true });
    }
    const leftPanel = document.querySelector('.left');
    const rightPanel = document.querySelector('.right');
    const logSection = document.querySelector('section[aria-labelledby="log-head"]');
    const overpressureChartSection = document.querySelector('section[aria-labelledby="overpressure-chart-head"]');

    function adjustLogPosition() {
        if (!leftPanel || !rightPanel || !logSection || !overpressureChartSection) {
            return;
        }

        if (window.innerWidth <= 1024) {
            if (!leftPanel.contains(logSection)) {
                overpressureChartSection.insertAdjacentElement('afterend', logSection);
            }
        } else {
            if (!rightPanel.contains(logSection)) {
                rightPanel.appendChild(logSection);
            }
        }
    }

    adjustLogPosition();
    const debouncedAdjustLogPosition = debounce(adjustLogPosition, 150);
    window.addEventListener('resize', debouncedAdjustLogPosition);
    window.addEventListener('orientationchange', debouncedAdjustLogPosition);

  });
  </script>
</body>
</html>
