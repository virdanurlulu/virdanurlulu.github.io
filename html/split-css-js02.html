<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulation & Modeling of Explosion Effects (TNT Equivalence)</title>

  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="canonical" href="https://virdanurlulu.github.io/">
  <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
  <link rel="dns-prefetch" href="//raw.githubusercontent.com">
  <link rel="preload" as="image" href="/img/banner-itb1.webp">

  <meta name="description" content="Interactive Simulation and Modeling of Explosion Effects Based on TNT Equivalence Using JavaScript: Incorporating Chemical Material Properties, Consequence Estimation, Pa–Ze Relationship, Overpressure–Distance Chart, and Visualization of Explosion Overpressure Contours.">
  <meta name="author" content="Virda Nur Lu'lu">
  <meta name="robots" content="index,follow">
  <meta name="theme-color" content="#0079c2">
  <meta name="color-scheme" content="light dark">

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Master’s Program in Chemical Engineering, Bandung Institute of Technology">
  <meta property="og:title" content="Simulation and Modeling of Explosion Effects Based on TNT Equivalence using Javascript">
  <meta property="og:description" content="Interactive Simulation and Modeling of Explosion Effects Based on TNT Equivalence Using JavaScript: Incorporating Chemical Material Properties, Consequence Estimation, Pa–Ze Relationship, Overpressure–Distance Chart, and Visualization of Explosion Overpressure Contours.">
  <meta property="og:url" content="https://virdanurlulu.github.io/">
  <meta property="og:image" content="/img/ITB-Exlosion-Modeling-Simulation.webp">
  <meta property="og:image:type" content="image/webp">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Simulation and Modeling of Explosion Effects Based on TNT Equivalence using Javascript">
  <meta name="twitter:description" content="Interactive Simulation and Modeling of Explosion Effects Based on TNT Equivalence Using JavaScript: Incorporating Chemical Material Properties, Consequence Estimation, Pa–Ze Relationship, Overpressure–Distance Chart, and Visualization of Explosion Overpressure Contours.">
  <meta name="twitter:image" content="/img/ITB-Exlosion-Modeling-Simulation.webp">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Explosion Effects Simulation & Modeling (TNT Equivalence)", 
    "applicationCategory": "EducationalApplication",
    "operatingSystem": "Web",
    "url": "https://virdanurlulu.github.io/",
    "image": "/img/ITB-Exlosion-Modeling-Simulation.webp",
    "author": {"@type": "Person", "name": "Virda Nur Lu'lu", "sameAs": ["https://id.linkedin.com/in/virdanurlulu"]},
    "inLanguage": "en",
    "description": "Interactive Simulation and Modeling of Explosion Effects Based on TNT Equivalence Using JavaScript: Incorporating Chemical Material Properties, Consequence Estimation, Pa–Ze Relationship, Overpressure–Distance Chart, and Visualization of Explosion Overpressure Contours.",
    "publisher": {"@type": "Organization", "name": "Bandung Institute of Technology", "url": "https://che.itb.ac.id/"}
  }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  
  <style>
    :root {
      --ink: #1e2b3b;
      --muted: #64748b;
      --card: #ffffff;
      --bg: #f5f7fb;
      --blue-itb: #0079c2;
      --stripe: #eaf3fb;
      --ring: rgba(0, 121, 194, 0.25);
      --danger: #DC2626;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    body.dragging {
        user-select: none;
    }
    .wrap { max-width: 1280px; margin: 32px auto; padding-left: max(16px, env(safe-area-inset-left)); padding-right: max(16px, env(safe-area-inset-right)); }
    body.full .wrap { max-width: none; width: 100%; padding: 0; margin: 0 auto; }
    body.full .banner, body.full main.split { padding-left: max(20px, env(safe-area-inset-left)); padding-right: max(20px, env(safe-area-inset-right)); }
    body.full .banner { border-radius: 0; padding-top: clamp(16px, 2.2vw, 24px); padding-bottom: clamp(16px, 2.2vw, 24px); margin-bottom: 18px; }
    body.full main.split { margin-top: 18px; }
    .title { display: grid; gap: 6px; }
    .title h1 { margin: 0; font-size: clamp(24px, 3.2vw, 44px); line-height: 1.25; font-family: Georgia, "Times New Roman", serif; color: #fff; padding: 6px 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); max-width: clamp(560px, 70vw, 62ch); }
    @supports (text-wrap: balance) { .title h1 { text-wrap: balance; } }
    .title h2 { margin: 0; font-size: clamp(12px, 1.2vw, 16px); font-weight: 600; color: #fff; }
    .banner { position: relative; color: #fff; background-image: url("https://virdanurlulu.github.io/img/banner-itb1.webp"); background-size: cover; background-position: center; padding: clamp(16px, 2.2vw, 24px) clamp(16px, 2.4vw, 28px); min-height: clamp(120px, 20vw, 240px); border-radius: 14px; box-shadow: 0 6px 20px rgba(2, 41, 77, 0.12); margin-bottom: 18px; display: flex; justify-content: space-between; align-items: flex-start;}
    .title h1, .title h2 { text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25); }
    .brandbar { display: flex; align-items: center; gap: 16px; }
    .brand-logo { height: clamp(56px, 6.5vw, 96px); width: auto; }
    .nowrap { white-space: nowrap; }
    .brand-text { display: flex; flex-direction: column; gap: 6px; }
    .card { background: var(--card); border-radius: 14px; overflow: hidden; box-shadow: 0 4px 14px rgba(10, 34, 64, 0.08); margin-bottom: 18px; }
    .card-header { background: var(--blue-itb); color: #e9f5ff; font-weight: 700; padding: 10px 14px; font-family: Georgia, "Times New Roman", serif; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .card-header .btn { padding: 6px 10px; font-size: 12px; background: #fff; color: var(--blue-itb); border: none; cursor: pointer; border-radius: 6px; transition: background-color 0.2s; }
    .card-header .btn:disabled { background-color: #e0e0e0; color: #9e9e9e; cursor: not-allowed; }
    .log-actions { display: flex; flex-wrap: wrap; gap: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; vertical-align: middle; text-align: left; font-size: 14px; }
    thead th { background: var(--stripe); font-weight: 700; color: #294050; border-bottom: 1px solid #dbe7f2; }
    tbody tr:nth-child(even) { background: #fbfdff; }
    tbody tr { border-bottom: 1px solid #eef4fa; }
    .label { font-weight: 600; display: block; margin-bottom: 4px; font-size: 14px;}
    .ref { color: var(--blue-itb); font-size: 12px; }
    input[type="number"], input[readonly], input[type="text"], input[type="text"][readonly], select { width: 100%; border: 1px solid #d6e3ef; background: #fff; color: var(--ink); border-radius: 10px; padding: 10px 12px; min-height: 40px; outline: none; transition: 0.2s box-shadow, 0.2s border-color; font-size: 16px; }
    input[readonly], input[type="text"][readonly] { background: #f6f9fd; color: #475569; }
    input:focus, select:focus { border-color: var(--blue-itb); box-shadow: 0 0 0 4px var(--ring); }
    input.input-error { border-color: var(--danger) !important; box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.25) !important; }
    .chem-grid { display: grid; grid-template-columns: 1.3fr 1fr; gap: 14px; align-items: start; }
    .mini { display: flex; gap: 12px; align-items: flex-start; }
    .mini > * { flex: 1; }
    .matcol { display: flex; flex-direction: column; gap: 12px; }
    .eq-panel { border: 1px solid #dbe7f2; background: var(--card); color: var(--ink); border-radius: 12px; padding: 12px; }
    .eq-title { font-weight: 700; color: var(--blue-itb); margin-bottom: 8px; }
    .rxn { padding: 10px 12px; border: 1px dashed #c9d8e6; border-radius: 10px; margin-top: 8px; background: var(--stripe); }
    .rxn small { display: block; color: #334155; margin-bottom: 4px; }
    .rxn-eq { font-family: "Times New Roman", Georgia, serif; font-size: 16px; color: var(--ink); }
    .rxn-eq .arrow { padding: 0 6px; font-weight: 700; }
    .status { padding: 8px 12px; border-left: 4px solid #0ea5e9; background: #ebf8ff; color: #075985; border-radius: 10px; display: none; margin-top: 8px; }
    .status.bad { border-left-color: var(--danger); background: #fff1f2; color: #be123c; }
    .footnote { font-size: 12px; color: var(--muted); margin-top: 8px; }
    main.split { display: grid; grid-template-columns: 2fr 3fr; gap: 18px; }
    .left, .right { display: flex; flex-direction: column; gap: 18px; }
    .right { position: sticky; top: 12px; align-self: start; }
    .method-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 12px; padding: 12px; }
    .method-card { position: relative; min-height: 220px; border: 1px solid #dbe7f2; background: #fff; border-radius: 12px; overflow: hidden; }
    .method-card .vlabel { background: var(--stripe); color: var(--blue-itb); padding: 8px 12px; font-weight: 700; text-align: center; border-bottom: 1px solid #e6eef6; }
    .method-card .pad { padding: 10px 10px 40px 10px; height: 100%; color: var(--ink); font-size: 14px; }
    .sevfoot { position: absolute; left: 0; right: 0; bottom: 0; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .damage-category { margin-top: 10px; }
    .damage-category strong { color: var(--blue-itb); }
    .damage-category ul { padding-left: 20px; margin-top: 5px; list-style-type: disc;}
    .app-footer { margin-top: 20px; color: #fff; background-color: var(--blue-itb); width: 100vw; margin-left: calc(50% - 50vw); padding: 24px 16px; border-top: 1px solid rgba(255, 255, 255, 0.25); text-align: center; }
    .app-footer .footer-content { max-width: 1280px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .app-footer .credit { font-weight: 700; color: #e9f5ff; }
    .app-footer .dedication { font-size: 13px; line-height: 1.6; max-width: 960px; }
    .app-footer a:not(.btn-home-3d) { color: #fff; text-decoration: none; }
    .btn-home-3d { --button-bg-top: #CC00CC; --button-bg-bottom: #990099; --button-shadow: #660066; --button-active-shadow: #440044; display: inline-flex; align-items: center; justify-content: center; padding: 1px 20px; font-size: 12px; font-weight: normal; color: #ffffff; background: linear-gradient(to bottom, var(--button-bg-top) 0%, var(--button-bg-bottom) 100%); border: none; border-radius: 8px; cursor: pointer; position: relative; outline: none; transform: translateY(0); transition: all 0.2s ease; box-shadow: 0 4px 0 var(--button-shadow); text-decoration: none; }
    .btn-home-3d:hover { transform: translateY(-2px); box-shadow: 0 6px 0 var(--button-shadow); }
    .btn-home-3d:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--button-active-shadow); }
    .footer-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
    .dropdown-menu { position: relative; z-index: 1000; }
    .dropdown-toggle { background-color: rgba(255, 255, 255, 0.9); color: var(--ink); padding: 8px 16px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .dropdown-toggle:hover { background-color: #ffffff; }
    .dropdown-content { display: none; position: absolute; right: 0; top: 110%; background-color: #ffffff; min-width: 220px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s; }
    .dropdown-menu.is-active .dropdown-content { display: block; opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-content a { color: var(--ink); padding: 12px 16px; text-decoration: none; display: block; transition: background-color 0.2s ease, color 0.2s ease; font-weight: 500; white-space: nowrap; }
    .dropdown-content a:hover { background-color: var(--stripe); color: var(--blue-itb); }
    .chart-container { padding: 12px; background-color: var(--card); border-radius: 14px; position: relative; }
    #chart, #overpressureChart { width: 100%; height: 500px; }
    .chart-note { margin-top: 4px; text-align: center; font-style: italic; color: var(--muted); font-size: 11px; }
    #overpressureChartMsg { color: var(--muted); font-style: italic; padding: 20px; font-size: 14px; text-align: center; }
    .table-wrapper { overflow-x: auto; }
    #logTable { font-size: 12px; }
    #logTable th, #logTable td { padding: 6px 8px; white-space: nowrap; }
    #logTable .col-action { width: 40px; text-align: center; }
    #logTable .log-placeholder td { text-align: center; color: var(--muted); padding: 20px; font-style: italic; }
    .btn-delete { background: none; border: none; cursor: pointer; padding: 4px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; width: 24px; height: 24px; transition: background-color 0.2s;}
    .btn-delete:hover { background-color: #fee2e2; }
    .btn-delete svg { width: 14px; height: 14px; stroke: #ef4444; }
    @keyframes fadeIn { from { background-color: #ebf8ff; } to { background-color: transparent; } }
    .new-row-animation { animation: fadeIn 1.5s ease-out; }
    #toTop { position: fixed; bottom: 20px; right: 20px; z-index: 1000; cursor: pointer; border-radius: 50%; width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: var(--blue-itb); color: white; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-size: 24px; opacity: 0; visibility: hidden; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s; }
    #toTop.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #toTop:hover { background-color: #005a8c; }
   
    #floatingControlPanel { display: none; position: fixed; z-index: 1001; background-color: var(--card); border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); transition: all 0.4s ease-in-out; width: auto; max-width: 90%; left: 50%; bottom: 20px; transform: translateX(-50%); }
    #floatingControlPanel.visible { display: block; }
    .floating-panel-header { cursor: move; padding: 10px 14px; background-color: var(--blue-itb); color: white; border-top-left-radius: 14px; border-top-right-radius: 14px; display: flex; justify-content: space-between; align-items: center; }
    .floating-panel-header h3 { margin: 0; font-size: 12px; font-family: Georgia, "Times New Roman", serif; transition: opacity 0.3s ease; }
    .floating-panel-action-btn { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.2); color: white; border: none; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
    .floating-panel-body { display: grid; grid-template-areas: "inputs outputs"; grid-template-columns: auto auto; gap: 16px; padding: 14px; align-items: start; max-height: 500px; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, opacity 0.4s ease-in-out;}
    #floatingControlPanel.collapsed {
        width: 44px !important;
        height: 44px;
        border-radius: 50%;
        bottom: auto;
        left: auto;
        top: var(--target-top, 20px);
        right: var(--target-right, 20px);
        transform: none;
        overflow: hidden;
    }
    #floatingControlPanel.collapsed .floating-panel-header { padding: 10px; cursor: pointer; }
    #floatingControlPanel.collapsed h3, #floatingControlPanel.collapsed .floating-panel-body { display: none; }
    #floatingControlPanel.collapsed #floatPanelCollapseBtn { transform: rotate(180deg); }
    #floatPanelInputs { grid-area: inputs; display: flex; flex-direction: column; gap: 10px; }
    #floatPanelOutputs { grid-area: outputs; display: flex; flex-direction: column; gap: 4px; padding-left: 16px; border-left: 2px solid var(--stripe); }
    .floating-group { display: flex; flex-direction: column; }
    #floatPanelOutputs .label { color: var(--muted); font-weight: normal; }
    #floatPanelOutputs .output-values { display: flex; justify-content: space-between; gap: 16px; flex-direction: column; }
    .floating-output-col { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; font-size: 12px; }
    .floating-output-col span:first-child { font-weight: 600; color: var(--muted); }
    .floating-output-col span:last-child { font-family: monospace; color: var(--blue-itb); font-weight: bold; font-size: 16px; }

    #floatingControlPanel .label { font-size: 11px; }
    #floatingControlPanel input, #floatingControlPanel select { font-size: 11px; padding: 8px 10px; min-height: 25px; }
    .floating-output-col span:last-child { font-size: 12px; }
    #logTable .unit-row th { font-weight: normal; font-size: 10px; color: var(--muted); padding-top: 0; padding-bottom: 4px; }

    #language-switcher { position: absolute; bottom: 12px; right: clamp(16px, 2.4vw, 28px); display: flex; gap: 8px; z-index: 10; }
    .lang-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.7); background-color: rgba(255, 255, 255, 0.1); cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); opacity: 0.7; }
    .lang-btn:hover { transform: scale(1.1); opacity: 1; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); }
    .lang-btn.active { border-color: #fff; opacity: 1; transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
    .lang-btn img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

    /* --- CONTOUR MAP STYLES START --- */
    #contourMapContainer {
        height: 75vh;
        display: flex;
        padding: 14px;
    }
    #mapCard {
        flex-grow: 1;
        position: relative;
        border-radius: 14px;
        box-shadow: 0 8px 24px rgba(2,8,20,.08);
        overflow: hidden; /* Ensures map corners are rounded */
    }
    #map {
        height: 100%;
        width: 100%;
    }
    .legend{ display: none; position:absolute;z-index:1001;bottom:12px;left:12px;background:#fff;border-radius:10px; box-shadow:0 6px 18px rgba(2,8,20,.15);padding:10px 12px;font:13px/1.3 system-ui,Segoe UI,Roboto,Arial}
    .fs-btn{ position:absolute; z-index:1002; top:12px; right:12px; background:rgba(255,255,255,.95); border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer; box-shadow:0 4px 12px rgba(2,8,20,.12); color: var(--ink, #0f172a); }
    .fs-btn:active{transform:translateY(1px)}
    .fs-host.fullscreen{position:fixed; inset:0; z-index:9999; margin:0; border-radius:0; padding:0; background:#000;}
    .fs-host.fullscreen #map{height:100dvh; height:100vh; border-radius:0}
    body.fs-lock{overflow:hidden}
    .placelabel{ background:rgba(255,255,255,.95); color:#0f172a; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 2px 8px rgba(2,8,20,.12); padding:4px 6px; font-weight:600 }
    .placelabel .leaflet-tooltip-content-wrapper { padding: 0; }
    .placelabel .leaflet-tooltip-content { display: flex; align-items: center; justify-content: flex-start; padding: 4px 2px 4px 8px; line-height: 1.2; }
    .placelabel-content { margin-right: 4px; }
    .placelabel-close { border: none; background: transparent; cursor: pointer; font-size: 18px; line-height: 1; padding: 0 4px; color: #64748b; }
    .placelabel-close:hover { color: #0f172a; }
    .leaflet-control-attribution span[title="Author"]{ font-weight:600; }
    .fs-btn-mobile{ display:none; bottom:40px; left:12px; right:auto; top:auto; }
    @media (max-width:640px){ #fsBtn{ display:none; } #fsBtnMobile{ display:inline-flex; } }
    .notification { position: absolute; z-index: 1003; top: 75px; left: 50%; transform: translateX(-50%); background: rgba(40,40,40,0.9); color: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; text-align: center; max-width: 90%; }
    .notification.show { opacity: 1; visibility: visible; }
    .notification.error { background: rgba(217, 48, 37, 0.9); }
    .map-title { position: absolute; top: 12px; left: 12px; z-index: 1002; background: rgba(255, 255, 255, 0.92); padding: 8px 12px; border-radius: 10px; box-shadow: 0 4px 12px rgba(2,8,20,.12); font-weight: 700; font-size: 16px; pointer-events: none; max-width: calc(100% - 150px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    @media (max-width: 640px) { .map-title { font-size: 14px; padding: 6px 10px; } }
    /* --- CONTOUR MAP STYLES END --- */

    /* --- REVISED RESPONSIVE STYLES FOR SPECIFIC DEVICES --- */

    /* 1. Main Layout Stacking and Table Scrolling for Tablets and Smaller */
    @media (max-width: 1024px) {
        .wrap {
            /* Force wrap to be full-width on mobile/tablet */
            padding-left: 0;
            padding-right: 0;
            margin-left: 0;
            margin-right: 0;
        }
        main.split {
            grid-template-columns: 1fr; /* Stack left and right columns */
        }
        aside.right {
            position: static;
        }
        .method-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .table-wrapper { /* Make ALL tables scrollable */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        #logTable {
            min-width: 900px;
        }
         #prop-head + div .table-wrapper table,
         #param-head + div .table-wrapper table {
            min-width: 600px; /* Set min-width for properties/params tables */
        }
    }

    /* 2. Styles for Mobile Devices in General */
    @media (max-width: 768px) {
        .banner .brand-text h1 { font-size: 1rem; }
        .banner .brand-text h2 { font-size: 0.8rem; }
        .footer-buttons { flex-wrap: wrap; justify-content: center; gap: 8px; }
        #contourMapContainer {
            height: 65vh;
        }
    }

    /* 3. Fine-tuning for Small Screens */
    @media (max-width: 430px) {
        body {
            font-size: 14px;
        }
        .card-header {
            font-size: 0.95rem;
            padding: 10px 14px;
        }
        .card > div[style*="padding"] {
            padding: 12px !important;
        }
        .chem-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
    }
    
    /* 4. SPECIFIC FIX for Very Small Screens */
    @media (max-width: 375px) {
        body {
            font-size: 13px;
            -webkit-text-size-adjust: 100%;
        }
        .wrap > .banner.title {
            padding: 8px;
        }
        .banner .brand-logo {
            width: 50px;
            height: 50px;
        }
        .banner .brand-text h1 { 
            font-size: 0.8rem;
            line-height: 1.25;
        }
        .banner .brand-text h2 { 
            font-size: 0.7rem;
            line-height: 1.3;
        }
        .card > div[style*="padding"] {
            padding: 10px !important;
        }
        table, td, th {
            font-size: 0.9em;
        }
        .footer-buttons .btn-home-3d {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        #contourMapContainer {
            height: 60vh;
            padding: 8px;
        }
    }

    /* 5. Adjustments for Landscape Orientation on Phones */
    @media (max-height: 500px) and (max-width: 926px) and (orientation: landscape) {
        .banner.title {
            display: none;
        }
        .app-footer {
             display: none;
        }
        main.split {
            padding-top: 1rem;
        }
        #contourMapContainer {
            height: 85vh;
        }
    }
  </style>
</head>
<body class="theme-itb full">
  <div class="wrap">
    <div class="banner title">
      <div class="brandbar">
        <a href="https://virdanurlulu.github.io/" target="_blank" rel="noopener noreferrer" aria-label="Visit homepage">
          <img id="itbLogo" class="brand-logo" alt="Logo ITB" width="96" height="96">
        </a>
        <div class="brand-text">
          <h1 data-lang-key="app_title">Simulation and Modeling of Explosion Effects Based on TNT Equivalence <span class="nowrap">using Javascript</span></h1>
          <h2>
            <span class="sub-line1" data-lang-key="app_subtitle1">Master’s Program in Chemical Engineering, </span>
            <span class="sub-line2" data-lang-key="app_subtitle2">Bandung Institute of Technology</span>
          </h2>
        </div>
      </div>

      <div class="dropdown-menu">
        <button class="dropdown-toggle" data-lang-key="menu_button">Menu &#9776;</button>
        <div class="dropdown-content">
          <a href="/" data-lang-key="menu_home">Home</a>
          <a href="/html/simulation-modeling-visualisation-explosion.html" data-lang-key="menu_app">Simulation & Modeling Application</a>
          <a href="#" data-lang-key="menu_guide">Simulation Guide (coming soon)</a>
          <a href="/html/presentation-slide.html" data-lang-key="menu_presentation">Presentation</a>
          <a href="#" data-lang-key="menu_journal">Journal & Conference (coming soon)</a>
          <a href="/html/bibliography_sim_modeling_explosion.html" data-lang-key="menu_bibliography">Bibliography</a>
        </div>
      </div>
      
      <div id="language-switcher">
          <button class="lang-btn" data-lang="en" aria-label="Switch to English">
              <img src="https://virdanurlulu.github.io/img/EN.svg" alt="Switch to English" />
          </button>
          <button class="lang-btn" data-lang="id" aria-label="Ganti ke Bahasa Indonesia">
              <img src="https://virdanurlulu.github.io/img/ID.svg" alt="Ganti ke Bahasa Indonesia" />
          </button>
      </div>

    </div>

    <main class="split" role="main">
      <div class="left">
        <section class="card" id="materialCard" aria-labelledby="mat-head">
          <div id="mat-head" class="card-header" data-lang-key="card_title_material">Chemical Material</div>
          <div style="padding:14px">
            <div class="chem-grid">
              <div class="matcol">
                <div>
                  <label for="material" class="label" data-lang-key="label_select_material">Select Material</label>
                  <select id="material">
                    <option value="" data-lang-key="select_option_default">— Select —</option>
                    <option value="AN" data-lang-key="select_option_an">Ammonium Nitrate (AN)</option>
                    <option value="LPG" data-lang-key="select_option_lpg">Propane (LPG)</option>
                    <option value="H2" data-lang-key="select_option_h2">Hydrogen (H₂)</option>
                  </select>
                </div>
                <div class="mini">
                  <div>
                    <label for="vol" class="label" data-lang-key="label_volume">Volume (m³)</label>
                    <input id="vol" type="number" min="0" step="any" placeholder="e.g., 12.5" aria-label="Volume" />
                  </div>
                  <div>
                    <label for="dist" class="label" data-lang-key="label_distance">Distance (m)</label>
                    <input id="dist" type="number" min="0" step="any" placeholder="e.g., 150" aria-label="Distance" />
                  </div>
                </div>
              </div>
              <div class="eq-panel">
                <div class="eq-title" data-lang-key="eq_panel_title">Representative Overall Reaction</div>
                <div id="eq-text" class="eq-body" data-lang-key="eq_panel_placeholder">Select a material to display the reaction equation.</div>
              </div>
            </div>
          </div>
        </section>

        <section class="card" aria-labelledby="prop-head">
          <div id="prop-head" class="card-header" data-lang-key="card_title_properties">Properties</div>
          <div style="padding:12px">
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-lang-key="table_header_properties">Properties</th>
                    <th data-lang-key="table_header_value">Value</th>
                    <th data-lang-key="table_header_unit">Unit</th>
                    <th data-lang-key="table_header_literature">Literature</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td data-label="Properties"><label for="rho">Density ρ = m/V</label></td><td data-label="Value"><input id="rho" type="number" min="0" step="any"/></td><td data-label="Unit" class="unit">kg/m³</td><td data-label="Source" class="ref">@Literature</td></tr>
                  <tr><td data-label="Properties"><label for="dh">ΔH<sub>explosion</sub></label></td><td data-label="Value"><input id="dh" type="number" step="any"/></td><td data-label="Unit" class="unit">kJ/kg</td><td data-label="Source" class="ref">@Literature</td></tr>
                  <tr><td data-label="Properties"><label for="pa" data-lang-key="label_ambient_pressure">Ambient Pressure</label></td><td data-label="Value"><input id="pa" type="number" min="0" step="any"/></td><td data-label="Unit" class="unit">kPa</td><td data-label="Source" class="ref">@Literature</td></tr>
                  <tr><td data-label="Properties"><label for="eta" data-lang-key="label_explosion_efficiency">η<sub>E</sub> Explosion Efficiency</label></td><td data-label="Value"><input id="eta" type="number" min="0" max="1" step="any"/></td><td data-label="Unit" class="unit">–</td><td data-label="Source" class="ref">@Literature</td></tr>
                  <tr><td data-label="Properties"><label for="e_tnt">E<sub>TNT</sub></label></td><td data-label="Value"><input id="e_tnt" type="number" min="0" step="any"/></td><td data-label="Unit" class="unit">kJ/kg</td><td data-label="Source" class="ref">@Literature</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="card" aria-labelledby="param-head">
          <div id="param-head" class="card-header" data-lang-key="card_title_parameters">Parameters</div>
          <div style="padding:12px">
            <div class="table-wrapper">
              <table>
                <thead><tr>
                  <th data-lang-key="table_header_parameters">Parameters</th>
                  <th data-lang-key="table_header_value">Value</th>
                  <th data-lang-key="table_header_unit">Unit</th>
                  <th data-lang-key="table_header_sources">Sources</th>
                </tr></thead>
                <tbody>
                  <tr><td data-label="Parameters" data-lang-key="param_mass_material">(W) Mass Material</td><td data-label="Value"><input id="W_mass" type="text" readonly /></td><td data-label="Unit" class="unit">kg</td><td data-label="Source" class="ref" data-lang-key="source_calculated">@Calculated</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_total_energy">(E) Total Energy</td><td data-label="Value"><input id="E_total" type="text" readonly /></td><td data-label="Unit" class="unit">kJ</td><td data-label="Source" class="ref" data-lang-key="source_calculated">@Calculated</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_tnt_equivalent">(W) TNT Equivalent</td><td data-label="Value"><input id="W_tnt" type="text" readonly /></td><td data-label="Unit" class="unit">kg</td><td data-label="Source" class="ref" data-lang-key="source_calculated">@Calculated</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_scaled_distance">(Ze) Scaled Distance</td><td data-label="Value"><input id="Ze" type="text" readonly /></td><td data-label="Unit" class="unit">m·kg<sup>−1/3</sup></td><td data-label="Source" class="ref" data-lang-key="source_calculated">@Calculated</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_scaled_overpressure">(Ps) Scaled Overpressure</td><td data-label="Value"><input id="Ps" type="text" readonly /></td><td data-label="Unit" class="unit">–</td><td data-label="Source" class="ref" data-lang-key="source_crowl_kinney">@Crowl/Kinney</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_peak_overpressure">(Po) Peak side-on overpressure</td><td data-label="Value"><input id="Po_crowl" type="text" readonly /></td><td data-label="Unit" class="unit">kPa</td><td data-label="Source" class="ref" data-lang-key="source_crowl">@Crowl</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_peak_overpressure">(Po) Peak side-on overpressure</td><td data-label="Value"><input id="Po_alonso" type="text" readonly /></td><td data-label="Unit" class="unit">kPa</td><td data-label="Source" class="ref" data-lang-key="source_alonso">@Alonso</td></tr>
                  <tr><td data-label="Parameters" data-lang-key="param_peak_overpressure">(Po) Peak side-on overpressure</td><td data-label="Value"><input id="Po_sadovski" type="text" readonly /></td><td data-label="Unit" class="unit">kPa</td><td data-label="Source" class="ref" data-lang-key="source_sadovski">@Sadovski</td></tr>
                </tbody>
              </table>
            </div>
            <div id="msg" class="status" role="status" aria-live="polite"></div>
          </div>
        </section>

        <section class="card" aria-labelledby="chart-head">
          <div id="chart-head" class="card-header">
            <span data-lang-key="chart_title_ps_vs_ze">Scaled Overpressure vs Scaled Distance</span>
            <button class="btn" id="btnExport" data-lang-key="btn_export_png">Export PNG</button>
          </div>
          <div class="chart-container">
            <div id="chart" role="img" aria-label="Log-log plot of Ps (Po/Pa) versus ze based on Kinney &amp; Graham (1985)."></div>
            <noscript><p data-lang-key="chart_noscript">Please enable JavaScript to display the chart. Reference: G. F. Kinney & K. J. Graham (1985).</p></noscript>
            <div class="chart-note" data-lang-key="chart_note_source">Source: G. F. Kinney & K. J. Graham, <em>Explosive Shocks in Air</em>, Springer-Verlag, 1985.</div>
          </div>
        </section>
        
        <section class="card" aria-labelledby="overpressure-chart-head">
          <div id="overpressure-chart-head" class="card-header">
            <span data-lang-key="chart_title_po_vs_dist">Overpressure vs Distance</span>
          </div>
          <div class="chart-container">
            <canvas id="overpressureChart"></canvas>
            <div id="overpressureChartMsg" class="chart-note" style="display: none; padding: 20px; font-size: 14px;"></div>
            <noscript><p data-lang-key="chart_noscript_generic">Please enable JavaScript to display the chart.</p></noscript>
          </div>
        </section>
        
        <section class="card" aria-labelledby="contour-map-head">
          <div id="contour-map-head" class="card-header">
            <span data-lang-key="contour_map_title">Explosion Contour Map</span>
          </div>
          <div id="contourMapContainer">
            <div class="fs-host" id="mapCard">
              <div id="mapTitle" class="map-title">Explosion Contour</div>
              <button id="fsBtn" class="fs-btn" aria-pressed="false" title="Fullscreen (F)">⛶ Fullscreen</button>
              <button id="fsBtnMobile" class="fs-btn fs-btn-mobile" aria-pressed="false" title="Fullscreen">⛶ Fullscreen</button>
              <div id="map" role="region" aria-label="Explosion contour map"></div>
              <div class="legend" id="legend" hidden></div>
              <div id="notification" class="notification"></div>
            </div>
          </div>
        </section>

      </div>

      <aside class="right">
        <section class="card estimation" aria-labelledby="est-damage">
          <div id="est-damage" class="card-header" data-lang-key="estimation_damage_title">Estimation of Damage to Structures and Process Equipment</div>
          <div class="method-grid">
            <div class="method-card" id="panel-damage-crowl">
              <div class="vlabel">CROWL</div>
              <div class="pad">
                <p><strong>Overpressure (Po):</strong> <span id="val-Po-crowl">—</span> kPa</p>
                <div>
                  <strong data-lang-key="damage_details_label">Damage Details:</strong>
                  <div class="damage-category">
                    <strong data-lang-key="structural_label">Structural:</strong>
                    <ul id="structural-damage-crowl"></ul>
                  </div>
                  <div class="damage-category">
                    <strong data-lang-key="process_equipment_label">Process Equipment:</strong>
                    <ul id="equipment-damage-crowl"></ul>
                  </div>
                </div>
              </div>
              <div class="sevfoot" id="sev-crowl" data-lang-key="unknown">Unknown</div>
            </div>
            <div class="method-card" id="panel-damage-alonso">
              <div class="vlabel">ALONSO</div>
              <div class="pad">
                <p><strong>Overpressure (Po):</strong> <span id="val-Po-alonso">—</span> kPa</p>
                  <div>
                  <strong data-lang-key="damage_details_label">Damage Details:</strong>
                  <div class="damage-category">
                    <strong data-lang-key="structural_label">Structural:</strong>
                    <ul id="structural-damage-alonso"></ul>
                  </div>
                  <div class="damage-category">
                    <strong data-lang-key="process_equipment_label">Process Equipment:</strong>
                    <ul id="equipment-damage-alonso"></ul>
                  </div>
                </div>
              </div>
              <div class="sevfoot" id="sev-alonso" data-lang-key="unknown">Unknown</div>
            </div>
            <div class="method-card" id="panel-damage-sadovski">
              <div class="vlabel">SADOVSKI</div>
              <div class="pad">
                <p><strong>Overpressure (Po):</strong> <span id="val-Po-sadovski">—</span> kPa</p>
                  <div>
                  <strong data-lang-key="damage_details_label">Damage Details:</strong>
                  <div class="damage-category">
                    <strong data-lang-key="structural_label">Structural:</strong>
                    <ul id="structural-damage-sadovski"></ul>
                  </div>
                  <div class="damage-category">
                    <strong data-lang-key="process_equipment_label">Process Equipment:</strong>
                    <ul id="equipment-damage-sadovski"></ul>
                  </div>
                </div>
              </div>
              <div class="sevfoot" id="sev-sadovski" data-lang-key="unknown">Unknown</div>
            </div>
          </div>
        </section>
        <section class="card estimation" aria-labelledby="est-injury">
          <div id="est-injury" class="card-header" data-lang-key="estimation_injury_title">Estimation of Injury Consequences</div>
          <div class="method-grid">
            <div class="method-card" id="panel-injury-crowl"><div class="vlabel">CROWL</div><div class="pad"><p><strong>Overpressure (Po):</strong> <span id="val-Po-crowl-inj">—</span> kPa</p><p><strong data-lang-key="effects_label">Effects:</strong></p><ul id="injury-effects-crowl"></ul></div><div class="sevfoot" id="sev-injury-crowl" data-lang-key="unknown">Unknown</div></div>
            <div class="method-card" id="panel-injury-alonso"><div class="vlabel">ALONSO</div><div class="pad"><p><strong>Overpressure (Po):</strong> <span id="val-Po-alonso-inj">—</span> kPa</p><p><strong data-lang-key="effects_label">Effects:</strong></p><ul id="injury-effects-alonso"></ul></div><div class="sevfoot" id="sev-injury-alonso" data-lang-key="unknown">Unknown</div></div>
            <div class="method-card" id="panel-injury-sadovski"><div class="vlabel">SADOVSKI</div><div class="pad"><p><strong>Overpressure (Po):</strong> <span id="val-Po-sadovski-inj">—</span> kPa</p><p><strong data-lang-key="effects_label">Effects:</strong></p><ul id="injury-effects-sadovski"></ul></div><div class="sevfoot" id="sev-injury-sadovski" data-lang-key="unknown">Unknown</div></div>
          </div>
        </section>
        <section class="card" aria-labelledby="log-head">
            <div id="log-head" class="card-header">
                <span data-lang-key="log_title">Simulation Log</span>
                <div class="log-actions">
                    <button class="btn" id="btnSortLog" data-lang-key="btn_sort">Sort</button>
                    <button class="btn" id="btnExportLog" data-lang-key="btn_export_csv">Export CSV</button>
                    <button class="btn" id="btnImportLog" data-lang-key="btn_import_csv">Import CSV</button>
                    <input type="file" id="importFile" accept=".csv" style="display: none;" />
                </div>
            </div>
            <div class="table-wrapper">
                <table id="logTable">
                    <thead>
                        <tr>
                            <th data-lang-key="log_col_node">Node</th>
                            <th data-lang-key="log_col_material">Material</th>
                            <th>ηE</th>
                            <th>ETNT</th>
                            <th data-lang-key="log_col_volume">Volume</th>
                            <th data-lang-key="log_col_distance">Distance</th>
                            <th>WTNT</th>
                            <th>ze</th>
                            <th>Ps</th>
                            <th>Crowl</th>
                            <th>Alonso</th>
                            <th>Sadovski</th>
                            <th class="col-action">-</th>
                        </tr>
                        <tr class="unit-row">
                           <th></th><th></th><th></th><th>(kJ/kg)</th><th>(m³)</th><th>(m)</th><th>(kg)</th><th>(m·kg<sup>−1/3</sup>)</th><th></th><th>(kPa)</th><th>(kPa)</th><th>(kPa)</th><th></th>
                        </tr>
                    </thead>
                    <tbody id="logTbody"></tbody>
                </table>
            </div>
            <div style="padding: 0 14px 14px;">
                <p class="footnote" data-lang-key="log_footnote">Click "Save" to log the calculation results. The last 10 entries will be stored in your browser.</p>
            </div>
        </section>
      </aside>
    </main>
  </div>
    
  <div id="floatingControlPanel">
      <div class="floating-panel-header">
        <h3 data-lang-key="quick_control_panel">Quick Control Panel</h3>
        <div class="panel-header-buttons">
          <button id="floatPanelCollapseBtn" class="floating-panel-action-btn" aria-label="Collapse/Expand Panel">▲</button>
        </div>
      </div>
      <div class="floating-panel-body">
        <div id="floatPanelInputs">
        </div>
        <div id="floatPanelOutputs">
        </div>
      </div>
  </div>

  <footer class="app-footer">
      <div class="footer-content">
        <div class="footer-buttons">
          <a class="btn-home-3d" href="/" target="_blank" rel="noopener noreferrer" data-lang-key="menu_home">Home</a>
          <a class="btn-home-3d" href="#" data-lang-key="footer_guide">Guide</a>
          <a class="btn-home-3d" href="#" data-lang-key="menu_presentation">Presentation</a>
          <a class="btn-home-3d" href="#" data-lang-key="footer_journal">Journal</a>
          <a class="btn-home-3d" href="https://id.linkedin.com/in/virdanurlulu" data-lang-key="footer_profile">Profile</a>
        </div>
        <div class="credit">
          <span data-lang-key="footer_copyright">Copyright © 2025 by</span>
          <a href="https://id.linkedin.com/in/virdanurlulu" target="_blank" rel="nofollow noopener noreferrer" style="text-decoration: none;">Virda Nur Lu'lu</a>
        </div>
        <div class="dedication">
          <span data-lang-key="footer_dedication1">This application is dedicated to my parents for their persistent support and patient guidance throughout my JavaScript journey.</span>
          <span data-lang-key="footer_dedication2">It is also presented to the academic community at</span>
          <a href="https://che.itb.ac.id/" target="_blank" rel="nofollow noopener noreferrer" data-lang-key="footer_dedication_itb">Bandung Institute of Technology</a>
          <span data-lang-key="footer_dedication3">as a contribution towards inspiring further advancements in JavaScript technology.</span>
        </div>
      </div>
  </footer>

  <button class="btn" id="toTop" type="button" aria-label="Back to Top">&#8679;</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://virdanurlulu.github.io/js/js-app.js" defer></script>

  <script>
  window.addEventListener('load', () => {
    // ======= BUILT-IN DEFAULTS =======
    const BUILTIN_DEFAULTS = {
      lat: 33.901436, lon: 35.519057,
      csv:
  `49, 2042.348
  150, 159.4947
  300, 41.51972
  500, 19.59217
  1000, 8.648397
  3000, 2.768441`,
      np: 90, iv: 250, os: 0.3, of: 0.2, sw: 0.3, pal: 'bright',
      showLabel: true
    };
    const LS_KEY  = 'explosionContour:v1';
    const RG_KEY  = 'explosionContour:revgeo:v2';

    // ======= Parser & CSV =======
    function parseNumberLoose(s){
      if (s==null) return NaN;
      s = String(s).trim().replace(/\s+/g,'').replace(/\u00A0/g,'');
      if (/^\d{1,3}(\.\d{3})+,\d+$/.test(s)) s = s.replace(/\./g,'').replace(',', '.');
      else if (/^\d+,\d+$/.test(s)) s = s.replace(',', '.');
      else s = s.replace(/(?<=\d),(?=\d{3}(?:\D|$))/g, '');
      return Number(s);
    }
    function extractNumbers(line){
      const toks = String(line).match(/-?\d+(?:[.,]\d+)?/g) || [];
      return toks.map(parseNumberLoose).filter(n=>Number.isFinite(n));
    }
    function parseData(text){
      const out = [];
      const rows = (text||'').split(/[\r\n]+/).map(r=>r.trim()).filter(Boolean);
      for (const r of rows){
        const nums = extractNumbers(r);
        if (!nums.length) continue;
        const rVal = nums[0];
        const poVal = nums.length>1 ? nums[1] : null;
        if (rVal > 0) out.push({ r: rVal, Po: (poVal!=null && Number.isFinite(poVal)) ? poVal : null });
      }
      out.sort((a,b)=>a.r-b.r);
      return out;
    }
    
    let notifTimer = null;
    function showNotification(message, isError = false){
        const el = document.getElementById('notification');
        el.textContent = message;
        el.className = 'notification'; // reset
        if (isError) el.classList.add('error');
        el.classList.add('show');
        if (notifTimer) clearTimeout(notifTimer);
        notifTimer = setTimeout(() => {
            el.classList.remove('show');
        }, 4000); 
    }

    // ======= QS read-only =======
    function b64urlToStr(b64u){
      try{
        const b64 = b64u.replace(/-/g,'+').replace(/_/g,'/') + '==='.slice(b64u.length%4);
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        return new TextDecoder().decode(bytes);
      }catch{ return ''; }
    }
    function readFromQS(){
      const sp = new URLSearchParams(location.search);
      if (!sp || [...sp].length===0) return {};
      const obj = {};
      if (sp.has('lat')) obj.lat = parseNumberLoose(sp.get('lat'));
      if (sp.has('lon')) obj.lon = parseNumberLoose(sp.get('lon'));
      if (sp.has('np'))  obj.np  = Math.max(16, Math.min(360, parseInt(sp.get('np'),10) || 0));
      if (sp.has('iv'))  obj.iv  = Math.max(0, parseInt(sp.get('iv'),10) || 0);
      if (sp.has('os'))  obj.os  = Math.max(0, Math.min(1, parseNumberLoose(sp.get('os'))));
      if (sp.has('of'))  obj.of  = Math.max(0, Math.min(1, parseNumberLoose(sp.get('of'))));
      if (sp.has('sw'))  obj.sw  = Math.max(0, parseNumberLoose(sp.get('sw')));
      if (sp.has('pal')) {
        const v = sp.get('pal').toLowerCase();
        if (['bright','cerah','default'].includes(v)) obj.pal = 'bright';
        else if (['bluegreen','biru-hijau','biru','hijau','bg'].includes(v)) obj.pal = 'bluegreen';
        else if (['heat','panas'].includes(v)) obj.pal = 'heat';
      }
      if (sp.has('label')) {
        const v = sp.get('label').toLowerCase();
        obj.showLabel = !(v==='0' || v==='false' || v==='no' || v==='off');
      }
      if (sp.has('csvb64')) { const s = b64urlToStr(sp.get('csvb64')||''); if (s) obj.csv = s; }
      else if (sp.has('csv')) { let v = sp.get('csv')||''; obj.csv = v.replace(/\|/g,'\n').replace(/;/g,'\n'); }
      return Object.fromEntries(Object.entries(obj).filter(([,v])=>v!==undefined && v!==null && v!==''));
    }

    // ======= localStorage =======
    function loadSaved(){
      try { const o = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); return (o && typeof o==='object') ? o : {}; }
      catch{ return {}; }
    }
    function savePartial(patch){
      settings = { ...settings, ...patch };
      try { localStorage.setItem(LS_KEY, JSON.stringify(settings)); } catch {}
    }

    // ======= Compose settings (QS ➜ LS ➜ Built-in) =======
    let settings = { ...BUILTIN_DEFAULTS, ...loadSaved(), ...readFromQS() };

    // ======= Geodesic helpers =======
    const R_EARTH = 6371008.8; // m
    function destPoint(latDeg, lonDeg, distanceM, bearingDeg){
      const φ1 = latDeg * Math.PI/180, λ1 = lonDeg * Math.PI/180;
      const θ = bearingDeg * Math.PI/180, δ = distanceM / R_EARTH;
      const sinφ1 = Math.sin(φ1), cosφ1 = Math.cos(φ1);
      const sinδ = Math.sin(δ), cosδ = Math.cos(δ);
      const sinφ2 = sinφ1*cosδ + cosφ1*sinδ*Math.cos(θ);
      const φ2 = Math.asin(sinφ2);
      const y = Math.sin(θ)*sinδ*cosφ1, x = cosδ - sinφ1*sinφ2;
      let λ2 = λ1 + Math.atan2(y, x);
      λ2 = ((λ2 + 3*Math.PI) % (2*Math.PI)) - Math.PI;
      return [φ2 * 180/Math.PI, λ2 * 180/Math.PI];
    }
    function circleCoordsGeodesic(lat0, lon0, Rm, n=90){
      const coords = [];
      for(let i=0;i<=n;i++){
        const bearing = 360 * i / n;
        const [lat, lon] = destPoint(lat0, lon0, Rm, bearing);
        coords.push([lat, lon]);
      }
      return coords;
    }

    // ======= Map init =======
    const map = L.map('map', {
      center:[settings.lat, settings.lon],
      zoom: 14,
      zoomControl: false
    });
    const canvasRenderer = L.canvas({ padding: 0.3 });
    
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
      maxZoom:19, attribution:'Tiles © Esri'
    });

    satelliteLayer.on('tileerror', function(event) {
        console.error('Tile load error:', event);
        showNotification('Failed to load map data. Check your internet connection.', true);
        satelliteLayer.off('tileerror');
    });
    satelliteLayer.addTo(map);

    L.control.scale({imperial:false, position: 'bottomright'}).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const creditHTML =
      `<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a> · ` +
      `<span title="Author">Credit by <a href="https://id.linkedin.com/in/virdanurlulu" target="_blank" rel="nofollow noopener">Virda Nur Lu'lu</a></span>`;
    map.attributionControl.setPrefix(creditHTML);

    // ======= Palettes =======
    const palettes = {
      bright: ["#FF0000","#FFA500","#FFFF00","#00FF00","#00FFFF","#0000FF","#FF00FF","#800080","#FFC0CB","#A52A2A"],
      bluegreen: ["#203a8f","#2d6cdf","#3fb6ff","#27c3a4","#15a371","#0f7a54","#0b533b","#083b2c"],
      heat: ["#4b0d0d","#7a1f0e","#ad3510","#e65a0d","#ff8c00","#ffb200","#ffd000","#ffe680"]
    };

    // ======= Reverse Geocoding (Latin/EN, cache, fallback) =======
    function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function isRTL(str){ return /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/.test(str); }
    function rgKey(lat, lon){ return `${lat.toFixed(5)},${lon.toFixed(5)}`; }
    function rgLoadCache(){ try{ return JSON.parse(localStorage.getItem(RG_KEY)||'{}'); }catch{ return {}; } }
    function rgSaveCache(obj){ try{ localStorage.setItem(RG_KEY, JSON.stringify(obj)); }catch{} }

    async function fetchNominatimEN(lat, lon){
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&namedetails=1&accept-language=en`;
      const r = await fetch(url, {headers:{'Accept':'application/json', 'User-Agent': 'ExplosionSim/1.0'}});
      if (!r.ok) throw new Error(`Nominatim request failed with status ${r.status}`);
      const j = await r.json();
      const a = j.address || {};
      const city = a.city || a.town;
      const country = a.country || '';
      const joined = [city, country].filter(Boolean).join(', ');
      return joined;
    }

    async function reverseGeocode(lat, lon){
      const key = rgKey(lat, lon);
      const cache = rgLoadCache();
      const TTL = 30*24*3600*1000; // 30 days
      if (cache[key] && (Date.now()-cache[key].ts) < TTL) return cache[key].name;

      let geocodeError = false;
      try{
        let name = await fetchNominatimEN(lat, lon);
        if (name && !isRTL(name)) {
          cache[key] = {name, ts: Date.now()}; rgSaveCache(cache);
          return name;
        }
      } catch(e) {
          console.error("Nominatim fetch failed:", e);
          geocodeError = true;
      }

      try{
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en`);
        if (r.ok){
          const j = await r.json();
          if (j.results && j.results.length){
            const g = j.results[0];
            const name = [g.name, g.country].filter(Boolean).join(', ');
            if (name){
              cache[key] = {name, ts: Date.now()}; rgSaveCache(cache);
              return name;
            }
          }
        } else {
            throw new Error(`Open-Meteo request failed with status ${r.status}`);
        }
      } catch(e) {
          console.error("Open-Meteo fetch failed:", e);
          geocodeError = true;
      }

      if (geocodeError) {
          showNotification('Failed to get location name. Check your internet connection.', true);
      }
      return '';
    }

    let centerMarker = null;
    let placeName = '';
    let mapTitleEl = null;

    // ======= Heading updater =======
    function setHeading(name){
      const label = (name && name.trim()) ? name.trim() : `${settings.lat.toFixed(5)}, ${settings.lon.toFixed(5)}`;
      const txt = `Explosion Contour - ${label}`;
      document.title = txt;
      if (mapTitleEl) mapTitleEl.textContent = txt;
    }

    function _attachTooltipCloseHandler(tooltip) {
      if (!tooltip || !tooltip._container) return;
      const closeBtn = tooltip._container.querySelector('.placelabel-close');
      if (closeBtn) {
        L.DomEvent.on(closeBtn, 'click', (event) => {
          L.DomEvent.stop(event);
          if (centerMarker) centerMarker.closeTooltip();
        });
      }
    }

    function ensureCenterMarker(lat, lon, name){
      if (!centerMarker){
        centerMarker = L.circleMarker([lat, lon], {
          renderer: canvasRenderer, radius: 5,
          color:'#111', weight:1, fillColor:'#fff', fillOpacity:1
        }).addTo(map);

        centerMarker.on('tooltipopen', function (e) {
          _attachTooltipCloseHandler(e.tooltip);
        });
      } else {
        centerMarker.setLatLng([lat, lon]);
      }

      if (!settings.showLabel){
        if (centerMarker.getTooltip()) centerMarker.unbindTooltip();
        return;
      }

      const locationName = name ? esc(name) : `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      const labelContent = `<span class="placelabel-content">📍 ${locationName}</span><button class="placelabel-close" title="Close">×</button>`;
      
      const t = centerMarker.getTooltip();
      if (t) {
          t.setContent(labelContent);
          if (centerMarker.isTooltipOpen()) {
              _attachTooltipCloseHandler(t);
          }
      } else {
          centerMarker.bindTooltip(labelContent, {permanent:true, direction:'right', offset:[8,0], className:'placelabel'});
      }
      
      if (!centerMarker.isTooltipOpen()) {
          centerMarker.openTooltip();
      }
    }

    async function refreshPlaceName(lat, lon){
      placeName = await reverseGeocode(lat, lon);
      ensureCenterMarker(lat, lon, placeName);
      setHeading(placeName);
      if (!document.getElementById('legend').hidden) refreshLegend();
    }

    // ======= Animation =======
    const RESPECT_REDUCED_MOTION = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let rings = parseData(settings.csv);
    let tempLayers = [], finalLayer = null, idx = 0, playing = false, finished = false, timer = null;

    function clearLayers(){
      if (timer) { clearTimeout(timer); timer=null; }
      tempLayers.forEach(l=>map.removeLayer(l)); tempLayers=[];
      if (finalLayer){ map.removeLayer(finalLayer); finalLayer=null; }
      const toRemove = [];
      map.eachLayer(l=>{ if(l instanceof L.Polygon || l instanceof L.GeoJSON){ toRemove.push(l); } });
      toRemove.forEach(l=>map.removeLayer(l));
      document.getElementById('legend').hidden = true;
    }

    function refreshLegend(){
      const leg = document.getElementById('legend');
      leg.innerHTML = `<b>Explosion Contour</b>
        <div>Rings: ${rings.map(x=>x.r).join(', ')} m</div>`;
      leg.hidden = false;
    }
    
    function drawStep(){
      if (!playing) return;
      const ivUsed = RESPECT_REDUCED_MOTION ? 0 : Math.max(0, settings.iv|0);
      if (idx < rings.length){
        const d = rings[idx];
        const coords = circleCoordsGeodesic(settings.lat, settings.lon, d.r, settings.np);
        const pal = (palettes[settings.pal] || palettes.bright);
        const layer = L.polygon(coords, {
          renderer: canvasRenderer, color:"#000000", weight:settings.sw,
          fillColor: pal[idx % pal.length], fillOpacity: settings.os
        }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po}</code>`:''}`).addTo(map);
        tempLayers.push(layer);
        if (idx===0){ try{ map.setView([settings.lat, settings.lon], 14); }catch(e){} }
        idx++;
        timer = setTimeout(drawStep, ivUsed);
      } else {
        tempLayers.forEach(l=>map.removeLayer(l)); tempLayers=[];
        const pal = (palettes[settings.pal] || palettes.bright);
        const reversed = rings.slice().reverse();
        finalLayer = L.featureGroup(
          reversed.map((d, irev)=>{
            const coords = circleCoordsGeodesic(settings.lat, settings.lon, d.r, settings.np);
            return L.polygon(coords, {
              renderer: canvasRenderer, color:"#000000", weight:settings.sw,
              fillColor: pal[(rings.length-1-irev) % pal.length], fillOpacity: settings.of
            }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: <code>${d.Po}</code>`:''}`);
          })
        ).addTo(map);
        try{ map.fitBounds(finalLayer.getBounds(), {padding:[20,20]}); }catch(e){}
        refreshLegend();
        playing = false; finished = true; 
      }
    }

    function drawInitialState(){
      clearLayers();
      finished = true;
      playing = false;
      rings = parseData(settings.csv);
      
      const pal = (palettes[settings.pal] || palettes.bright);
      const reversed = rings.slice().reverse();
      finalLayer = L.featureGroup(
        reversed.map((d, irev)=>{
          const coords = circleCoordsGeodesic(settings.lat, settings.lon, d.r, settings.np);
          return L.polygon(coords, {
            renderer: canvasRenderer, color:"#000000", weight:settings.sw,
            fillColor: pal[(rings.length-1-irev) % pal.length], fillOpacity: settings.of
          }).bindPopup(`<b>r = ${d.r} m</b>${d.Po!=null?`<br>Po: code>${d.Po}</code>`:''}`);
          })
        ).addTo(map);
      try{ 
          if (finalLayer && finalLayer.getLayers().length > 0) {
              map.fitBounds(finalLayer.getBounds(), {padding:[20,20]}); 
          } else {
              map.setView([settings.lat, settings.lon], 14);
          }
      } catch(e){}
      
      if (rings.length > 0) {
          refreshLegend();
      } else {
          document.getElementById('legend').hidden = true;
          ensureCenterMarker(settings.lat, settings.lon, placeName);
      }
    }

    function play(){ if (finished){ replay(); return; } if (playing) return; playing = true; drawStep(); }
    function pause(){ playing = false; if (timer) { clearTimeout(timer); timer=null; } }
    function replay(){ pause(); clearLayers(); idx = 0; finished = false; rings = parseData(settings.csv); play(); }

    // ======= Fullscreen (desktop & mobile) =======
    const fsBtn = document.getElementById('fsBtn'),
          fsBtnMobile = document.getElementById('fsBtnMobile'),
          mapCard = document.getElementById('mapCard');

    function setFSLabel(on){
      const txt = on ? '⛶ Exit Fullscreen' : '⛶ Fullscreen';
      [fsBtn, fsBtnMobile].forEach(b=>{
        if(!b) return;
        b.textContent = txt;
        b.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }
    function enterFS(){
      mapCard.classList.add('fullscreen'); document.body.classList.add('fs-lock');
      if (mapCard.requestFullscreen) { mapCard.requestFullscreen().catch(()=>{}); }
      else if (mapCard.webkitRequestFullscreen) { mapCard.webkitRequestFullscreen(); }
      setFSLabel(true);
      setTimeout(()=>map.invalidateSize(), 180);
    }
    function exitFS(){
      mapCard.classList.remove('fullscreen'); document.body.classList.remove('fs-lock');
      if (document.fullscreenElement && document.exitFullscreen) { document.exitFullscreen().catch(()=>{}); }
      else if (document.webkitFullscreenElement && document.webkitCancelFullScreen) { document.webkitCancelFullScreen(); }
      setFSLabel(false);
      setTimeout(()=>map.invalidateSize(), 180);
    }
    function toggleFS(){ mapCard.classList.contains('fullscreen') ? exitFS() : enterFS(); }

    fsBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFS(); });
    fsBtnMobile?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleFS(); });

    document.addEventListener('fullscreenchange', ()=>{
      const active = !!document.fullscreenElement || mapCard.classList.contains('fullscreen');
      if (!document.fullscreenElement) { mapCard.classList.remove('fullscreen'); document.body.classList.remove('fs-lock'); }
      setFSLabel(active);
    });

    document.addEventListener('keydown', (e)=>{
      if (document.activeElement.tagName === 'INPUT') return;
      if (e.key.toLowerCase() === 'f') { e.preventDefault(); toggleFS(); }
      if (e.key === 'Escape' && mapCard.classList.contains('fullscreen')) { exitFS(); }
    });

    window.addEventListener('resize', ()=>{
      if (mapCard.classList.contains('fullscreen')) {
        clearTimeout(window.__fsRaf);
        window.__fsRaf = setTimeout(()=>map.invalidateSize(), 120);
      }
    });
    
    // ======= Start =======
    (function init(){
      mapTitleEl = document.getElementById('mapTitle');
      setHeading(null); 
      refreshPlaceName(settings.lat, settings.lon);
      setFSLabel(false);
      drawInitialState();
    })();

    // ======= INTEGRATION: Sync Map with Simulation Log =======
    /**
     * Reads data from the Simulation Log table and updates the contour map.
     */
    function updateMapFromLog() {
      const logTbody = document.getElementById('logTbody');
      if (!logTbody) return;

      const rows = logTbody.querySelectorAll('tr');
      const csvLines = [];

      rows.forEach(row => {
          // Kolom 'Distance' adalah kolom ke-6 (indeks 5)
          const distanceCell = row.cells[5];
          // Kolom 'Crowl' (indeks 9) digunakan sebagai data tekanan opsional
          const pressureCell = row.cells[9];

          if (distanceCell) {
              const distance = parseFloat(distanceCell.textContent);
              if (!isNaN(distance) && distance > 0) {
                  const pressure = pressureCell ? parseFloat(pressureCell.textContent) : NaN;
                  // Format baris CSV: "jarak, tekanan". Tekanan bersifat opsional.
                  const line = isNaN(pressure) ? `${distance}` : `${distance}, ${pressure}`;
                  csvLines.push(line);
              }
          }
      });

      const newCsv = csvLines.join('\n');
      
      if (newCsv !== settings.csv || (newCsv && !finalLayer)) {
          settings.csv = newCsv;
          
          if (csvLines.length === 0) {
              rings = []; // Kosongkan data ring
              clearLayers(); // Hapus semua layer dari peta
              ensureCenterMarker(settings.lat, settings.lon, placeName); // Gambar ulang marker pusat
          } else {
              drawInitialState();
          }
      }
    }

    // Amati perubahan pada tabel log (saat baris ditambah atau dihapus)
    const logTbodyObserver = document.getElementById('logTbody');
    if (logTbodyObserver) {
        const observer = new MutationObserver(() => {
            // Gunakan debounce untuk menunda eksekusi agar tidak berjalan berkali-kali
            clearTimeout(window.logUpdateTimeout);
            window.logUpdateTimeout = setTimeout(updateMapFromLog, 250);
        });
        observer.observe(logTbodyObserver, { childList: true });
    }
    
    // Panggil updateMapFromLog saat halaman pertama kali dimuat
    setTimeout(updateMapFromLog, 500);

    // ======= DYNAMIC LAYOUT: Move Simulation Log based on screen size =======
    const leftPanel = document.querySelector('.left');
    const rightPanel = document.querySelector('.right');
    const logSection = document.querySelector('section[aria-labelledby="log-head"]');
    const overpressureChartSection = document.querySelector('section[aria-labelledby="overpressure-chart-head"]');
    let resizeTimer;

    function adjustLogPosition() {
        if (!leftPanel || !rightPanel || !logSection || !overpressureChartSection) {
            // This error can be ignored if it appears briefly on load, 
            // as this function will be called again once elements are ready.
            return;
        }

        if (window.innerWidth <= 1024) {
            // Mobile/Tablet view: Move log to the left panel if it's not already there.
            // It should be placed after the 'Overpressure vs Distance' chart.
            if (!leftPanel.contains(logSection)) {
                overpressureChartSection.insertAdjacentElement('afterend', logSection);
            }
        } else {
            // Desktop view: Move log back to the right panel if it's not already there.
            if (!rightPanel.contains(logSection)) {
                rightPanel.appendChild(logSection);
            }
        }
    }

    // Initial check on page load
    adjustLogPosition();

    // Adjust on window resize, with a debounce to prevent excessive calls
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(adjustLogPosition, 150);
    });

  });
  </script>
</body>
</html>

